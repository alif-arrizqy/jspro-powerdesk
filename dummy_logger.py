import datetime
import redis
import json


host = "localhost"
red = redis.StrictRedis(host=host, password='')

energy_data = {'cpu_temp': 53.7, 'edl1': -16.1, 'edl2': -99.0, 'batt_volt': 5350, 'load1': 1.31, 'load2': 7.68, 'load3': 0.0, 'edl3': -2.3, 'eh1': 183.8, 'pv1_volt': 63.3, 'pv1_curr': 0.88, 'eh2': 124.7, 'pv2_volt': 67.7, 'pv2_curr': 1.03, 'eh3': 34.6, 'pv3_volt': 64.9, 'pv3_curr': 0.24}

data_usb0 = [{'pcb_code': 'TBI24032703195    ', 'counter': 6, 'sn1_code': 'AO67950111', 'pack_voltage': 5576, 'pack_current': 0, 'remaining_capacity': 108, 'average_cell_temperature': 301, 'environment_temperature': 332, 'soc': 10000, 'soh': 10000, 'full_charged_capacity': 108, 'cycle_count': 5, 'max_cell_voltage': 3588, 'min_cell_voltage': 3368, 'cell_difference': 220, 'max_cell_temperature': 304, 'min_cell_temperature': 299, 'fet_temperature': 312, 'ambient_temperature': 332, 'remaining_charge_time': 65535, 'remaining_discharge_time': 65535, 'slave_id': 1, 'warning_flag': ['no alarm detected'], 'protection_flag': ['battery cell overvoltage protection', 'no alarm detected'], 'fault_status_flag': ['charge Mosfet OFF', 'discharge Mosfet ON', 'charge limit current function is ON'], 'cell_voltage': [3462, 3538, 3420, 3517, 3568, 3453, 3427, 3417, 3368, 3404, 3588, 3581, 3534, 3457, 3514, 3513], 'cell_temperature': [304, 299, 299], 'error_messages': ['Pack voltage 5576 exceeds limit 5325', 'Max cell voltage 3588 exceeds limit 425 at indices [10]', 'Min cell voltage 3368 exceeds limit 375 at indices [8]', 'Cell difference 220 below limit 300', 'Max cell temperature 304 exceeds limit 240 at indices [0]', 'Min cell temperature 299 exceeds limit 230 at indices [1, 2]', 'FET temperature 312 exceeds limit 250'], 'port': 'usb0'}, {'pcb_code': 'TBI23122400218    ', 'counter': 8, 'sn1_code': 'AO67950032', 'pack_voltage': 5433, 'pack_current': 0, 'remaining_capacity': 108, 'average_cell_temperature': 300, 'environment_temperature': 335, 'soc': 10000, 'soh': 10000, 'full_charged_capacity': 108, 'cycle_count': 7, 'max_cell_voltage': 3443, 'min_cell_voltage': 3360, 'cell_difference': 83, 'max_cell_temperature': 303, 'min_cell_temperature': 300, 'fet_temperature': 317, 'ambient_temperature': 335, 'remaining_charge_time': 65535, 'remaining_discharge_time': 65535, 'slave_id': 2, 'warning_flag': ['no alarm detected'], 'protection_flag': ['battery cell overvoltage protection', 'no alarm detected'], 'fault_status_flag': ['charge Mosfet OFF', 'discharge Mosfet ON', 'charge limit current function is ON'], 'cell_voltage': [3402, 3409, 3374, 3385, 3432, 3373, 3374, 3375, 3397, 3370, 3443, 3360, 3399, 3409, 3404, 3431], 'cell_temperature': [300, 300, 300], 'error_messages': ['Pack voltage 5433 exceeds limit 5325', 'Max cell voltage 3443 exceeds limit 425 at indices [10]', 'Min cell voltage 3360 exceeds limit 375 at indices [11]', 'Cell difference 83 below limit 300', 'Max cell temperature 303 exceeds limit 240', 'Min cell temperature 300 exceeds limit 230 at indices [0, 1, 2]', 'FET temperature 317 exceeds limit 250'], 'port': 'usb0'}, {'pcb_code': 'TBI24032703295    ', 'counter': 5, 'sn1_code': 'AO67950144', 'pack_voltage': 5418, 'pack_current': 0, 'remaining_capacity': 108, 'average_cell_temperature': 302, 'environment_temperature': 331, 'soc': 10000, 'soh': 10000, 'full_charged_capacity': 108, 'cycle_count': 11, 'max_cell_voltage': 3419, 'min_cell_voltage': 3366, 'cell_difference': 53, 'max_cell_temperature': 304, 'min_cell_temperature': 300, 'fet_temperature': 318, 'ambient_temperature': 331, 'remaining_charge_time': 65535, 'remaining_discharge_time': 65535, 'slave_id': 3, 'warning_flag': ['no alarm detected'], 'protection_flag': ['battery cell overvoltage protection', 'no alarm detected'], 'fault_status_flag': ['charge Mosfet OFF', 'discharge Mosfet ON', 'charge limit current function is ON'], 'cell_voltage': [3419, 3366, 3369, 3403, 3398, 3390, 3378, 3401, 3400, 3372, 3389, 3393, 3368, 3382, 3380, 3375], 'cell_temperature': [304, 300, 303], 'error_messages': ['Pack voltage 5418 exceeds limit 5325', 'Max cell voltage 3419 exceeds limit 425 at indices [0]', 'Min cell voltage 3366 exceeds limit 375 at indices [1]', 'Cell difference 53 below limit 300', 'Max cell temperature 304 exceeds limit 240 at indices [0]', 'Min cell temperature 300 exceeds limit 230 at indices [1]', 'FET temperature 318 exceeds limit 250'], 'port': 'usb0'}, {'pcb_code': 'TBI24032703084    ', 'counter': 18, 'sn1_code': 'AO67950088', 'pack_voltage': 5432, 'pack_current': 0, 'remaining_capacity': 108, 'average_cell_temperature': 305, 'environment_temperature': 339, 'soc': 10000, 'soh': 10000, 'full_charged_capacity': 108, 'cycle_count': 9, 'max_cell_voltage': 3462, 'min_cell_voltage': 3365, 'cell_difference': 97, 'max_cell_temperature': 307, 'min_cell_temperature': 303, 'fet_temperature': 323, 'ambient_temperature': 339, 'remaining_charge_time': 65535, 'remaining_discharge_time': 65535, 'slave_id': 4, 'warning_flag': ['no alarm detected'], 'protection_flag': ['battery cell overvoltage protection', 'no alarm detected'], 'fault_status_flag': ['charge Mosfet OFF', 'discharge Mosfet ON', 'charge limit current function is ON'], 'cell_voltage': [3413, 3393, 3387, 3427, 3421, 3370, 3412, 3368, 3373, 3395, 3371, 3390, 3462, 3392, 3382, 3365], 'cell_temperature': [307, 303, 304], 'error_messages': ['Pack voltage 5432 exceeds limit 5325', 'Max cell voltage 3462 exceeds limit 425 at indices [12]', 'Min cell voltage 3365 exceeds limit 375 at indices [15]', 'Cell difference 97 below limit 300', 'Max cell temperature 307 exceeds limit 240 at indices [0]', 'Min cell temperature 303 exceeds limit 230 at indices [1]', 'FET temperature 323 exceeds limit 250'], 'port': 'usb0'}, {'pcb_code': 'TBI24032703017    ', 'counter': 9, 'sn1_code': 'AO67950160', 'pack_voltage': 5411, 'pack_current': 0, 'remaining_capacity': 108, 'average_cell_temperature': 312, 'environment_temperature': 342, 'soc': 10000, 'soh': 10000, 'full_charged_capacity': 108, 'cycle_count': 8, 'max_cell_voltage': 3407, 'min_cell_voltage': 3348, 'cell_difference': 59, 'max_cell_temperature': 314, 'min_cell_temperature': 310, 'fet_temperature': 323, 'ambient_temperature': 342, 'remaining_charge_time': 65535, 'remaining_discharge_time': 65535, 'slave_id': 5, 'warning_flag': ['no alarm detected'], 'protection_flag': ['no alarm detected'], 'fault_status_flag': ['charge Mosfet OFF', 'discharge Mosfet ON', 'charge limit current function is ON'], 'cell_voltage': [3407, 3372, 3374, 3391, 3404, 3348, 3377, 3380, 3382, 3383, 3376, 3401, 3377, 3393, 3378, 3370], 'cell_temperature': [314, 310, 312], 'error_messages': ['Pack voltage 5411 exceeds limit 5325', 'Max cell voltage 3407 exceeds limit 425 at indices [0]', 'Min cell voltage 3348 exceeds limit 375 at indices [5]', 'Cell difference 59 below limit 300', 'Max cell temperature 314 exceeds limit 240 at indices [0]', 'Min cell temperature 310 exceeds limit 230 at indices [1]', 'FET temperature 323 exceeds limit 250'], 'port': 'usb0'}]

data_usb1 = [{'pcb_code': 'TBI24032703301    ', 'counter': 6, 'sn1_code': 'AO67950135', 'pack_voltage': 5403, 'pack_current': 0, 'remaining_capacity': 108, 'average_cell_temperature': 309, 'environment_temperature': 336, 'soc': 10000, 'soh': 10000, 'full_charged_capacity': 108, 'cycle_count': 7, 'max_cell_voltage': 3418, 'min_cell_voltage': 3357, 'cell_difference': 61, 'max_cell_temperature': 313, 'min_cell_temperature': 307, 'fet_temperature': 319, 'ambient_temperature': 336, 'remaining_charge_time': 65535, 'remaining_discharge_time': 65535, 'slave_id': 6, 'warning_flag': ['no alarm detected'], 'protection_flag': ['no alarm detected'], 'fault_status_flag': ['charge Mosfet OFF', 'discharge Mosfet ON', 'charge limit current function is ON'], 'cell_voltage': [3369, 3383, 3370, 3371, 3376, 3397, 3358, 3401, 3363, 3418, 3392, 3371, 3359, 3379, 3370, 3357], 'cell_temperature': [308, 307, 308], 'error_messages': ['Pack voltage 5403 exceeds limit 5325', 'Max cell voltage 3418 exceeds limit 425 at indices [9]', 'Min cell voltage 3357 exceeds limit 375 at indices [15]', 'Cell difference 61 below limit 300', 'Max cell temperature 313 exceeds limit 240', 'Min cell temperature 307 exceeds limit 230 at indices [1]', 'FET temperature 319 exceeds limit 250'], 'port': 'usb1'}, {'pcb_code': 'TBI23122400270    ', 'counter': 12, 'sn1_code': 'AO67950063', 'pack_voltage': 5415, 'pack_current': 0, 'remaining_capacity': 108, 'average_cell_temperature': 305, 'environment_temperature': 338, 'soc': 10000, 'soh': 10000, 'full_charged_capacity': 108, 'cycle_count': 9, 'max_cell_voltage': 3409, 'min_cell_voltage': 3342, 'cell_difference': 67, 'max_cell_temperature': 310, 'min_cell_temperature': 303, 'fet_temperature': 322, 'ambient_temperature': 338, 'remaining_charge_time': 65535, 'remaining_discharge_time': 65535, 'slave_id': 7, 'warning_flag': ['no alarm detected'], 'protection_flag': ['no alarm detected'], 'fault_status_flag': ['charge Mosfet OFF', 'discharge Mosfet ON', 'charge limit current function is ON'], 'cell_voltage': [3395, 3396, 3403, 3371, 3382, 3342, 3401, 3402, 3357, 3373, 3409, 3378, 3394, 3364, 3392, 3392], 'cell_temperature': [304, 303, 305], 'error_messages': ['Pack voltage 5415 exceeds limit 5325', 'Max cell voltage 3409 exceeds limit 425 at indices [10]', 'Min cell voltage 3342 exceeds limit 375 at indices [5]', 'Cell difference 67 below limit 300', 'Max cell temperature 310 exceeds limit 240', 'Min cell temperature 303 exceeds limit 230 at indices [1]', 'FET temperature 322 exceeds limit 250'], 'port': 'usb1'}, {'pcb_code': 'TBI23122400299    ', 'counter': 0, 'sn1_code': 'AO67950070', 'pack_voltage': 5578, 'pack_current': 0, 'remaining_capacity': 108, 'average_cell_temperature': 307, 'environment_temperature': 346, 'soc': 10000, 'soh': 10000, 'full_charged_capacity': 108, 'cycle_count': 9, 'max_cell_voltage': 3585, 'min_cell_voltage': 3390, 'cell_difference': 195, 'max_cell_temperature': 312, 'min_cell_temperature': 306, 'fet_temperature': 323, 'ambient_temperature': 346, 'remaining_charge_time': 65535, 'remaining_discharge_time': 65535, 'slave_id': 8, 'warning_flag': ['battery pack overvoltage alarm', 'no alarm detected'], 'protection_flag': ['battery cell overvoltage protection', 'no alarm detected'], 'fault_status_flag': ['charge Mosfet OFF', 'discharge Mosfet ON', 'charge limit current function is ON'], 'cell_voltage': [3487, 3416, 3507, 3475, 3432, 3585, 3564, 3410, 3510, 3522, 3519, 3559, 3444, 3390, 3443, 3522], 'cell_temperature': [306, 307, 306], 'error_messages': ['Pack voltage 5578 exceeds limit 5325', 'Max cell voltage 3585 exceeds limit 425 at indices [5]', 'Min cell voltage 3390 exceeds limit 375 at indices [13]', 'Cell difference 195 below limit 300', 'Max cell temperature 312 exceeds limit 240', 'Min cell temperature 306 exceeds limit 230 at indices [0, 2]', 'FET temperature 323 exceeds limit 250'], 'port': 'usb1'}, {'pcb_code': 'TBI24032702971    ', 'counter': 6, 'sn1_code': 'AO67950108', 'pack_voltage': 5529, 'pack_current': 0, 'remaining_capacity': 108, 'average_cell_temperature': 310, 'environment_temperature': 341, 'soc': 10000, 'soh': 10000, 'full_charged_capacity': 108, 'cycle_count': 7, 'max_cell_voltage': 3554, 'min_cell_voltage': 3398, 'cell_difference': 156, 'max_cell_temperature': 312, 'min_cell_temperature': 308, 'fet_temperature': 323, 'ambient_temperature': 341, 'remaining_charge_time': 65535, 'remaining_discharge_time': 65535, 'slave_id': 9, 'warning_flag': ['no alarm detected'], 'protection_flag': ['battery cell overvoltage protection', 'no alarm detected'], 'fault_status_flag': ['charge Mosfet OFF', 'discharge Mosfet ON', 'charge limit current function is ON'], 'cell_voltage': [3413, 3510, 3419, 3485, 3439, 3456, 3439, 3525, 3426, 3527, 3424, 3554, 3443, 3412, 3429, 3398], 'cell_temperature': [311, 308, 310], 'error_messages': ['Pack voltage 5529 exceeds limit 5325', 'Max cell voltage 3554 exceeds limit 425 at indices [11]', 'Min cell voltage 3398 exceeds limit 375 at indices [15]', 'Cell difference 156 below limit 300', 'Max cell temperature 312 exceeds limit 240', 'Min cell temperature 308 exceeds limit 230 at indices [1]', 'FET temperature 323 exceeds limit 250'], 'port': 'usb1'}, {'pcb_code': 'TBI24032703094    ', 'counter': 18, 'sn1_code': 'AO67950139', 'pack_voltage': 5418, 'pack_current': 0, 'remaining_capacity': 108, 'average_cell_temperature': 317, 'environment_temperature': 349, 'soc': 10000, 'soh': 10000, 'full_charged_capacity': 108, 'cycle_count': 8, 'max_cell_voltage': 3415, 'min_cell_voltage': 3357, 'cell_difference': 58, 'max_cell_temperature': 319, 'min_cell_temperature': 316, 'fet_temperature': 329, 'ambient_temperature': 349, 'remaining_charge_time': 65535, 'remaining_discharge_time': 65535, 'slave_id': 10, 'warning_flag': ['no alarm detected'], 'protection_flag': ['no alarm detected'], 'fault_status_flag': ['charge Mosfet OFF', 'discharge Mosfet ON', 'charge limit current function is ON'], 'cell_voltage': [3368, 3404, 3373, 3395, 3380, 3357, 3398, 3409, 3414, 3365, 3378, 3402, 3370, 3415, 3366, 3391], 'cell_temperature': [318, 317, 316], 'error_messages': ['Pack voltage 5418 exceeds limit 5325', 'Max cell voltage 3415 exceeds limit 425 at indices [13]', 'Min cell voltage 3357 exceeds limit 375 at indices [5]', 'Cell difference 58 below limit 300', 'Max cell temperature 319 exceeds limit 240', 'Min cell temperature 316 exceeds limit 230 at indices [2]', 'FET temperature 329 exceeds limit 250'], 'port': 'usb1'}]


scc_logs_srne = {'scc1': {'load': {'vsat_curr': 1.26, 'bts_curr': 7.6, 'obl': 0.0, 'relay_state': {'vsat': True, 'bts': True, 'obl': True}}, 'load_status': 'is running', 'battery_voltage': 5470, 'battery_temperature': 25, 'device_temperature': 25, 'alarm': {'result': 1, 'fault': {'batt_overdisc': 0, 'batt_overvolt': 0, 'batt_undervolt': 0, 'load_short': 0, 'load_over_current_power': 0, 'controller_temp_high': 0, 'batt_hi_temp_protection_1': 0, 'pv_input_overpower': 0, 'pv_input_overvolt': 0, 'solar_panel_working_point_overvolt': 0, 'solar_panel_reversed': 0, 'power_supply_status': 0, 'oo_battery_detected_sld': 0, 'batt_hi_temp_protection_2': 0, 'batt_lo_temp_protection_1': 0, 'overcharge_protection': 0, 'batt_lo_temp_protection_2': 0, 'batt_reversed': 0, 'induction_probe_damaged': 0, 'load_open_circuit': 0}}}, 'scc2': {'load': {'vsat_curr': 1.26, 'bts_curr': 7.6, 'obl': 0.0, 'relay_state': {'vsat': True, 'bts': True, 'obl': True}}, 'load_status': 'is running', 'battery_voltage': 5470, 'battery_temperature': 25, 'device_temperature': 25, 'alarm': {'result': 1, 'fault': {'batt_overdisc': 0, 'batt_overvolt': 0, 'batt_undervolt': 0, 'load_short': 0, 'load_over_current_power': 0, 'controller_temp_high': 0, 'batt_hi_temp_protection_1': 0, 'pv_input_overpower': 1, 'pv_input_overvolt': 0, 'solar_panel_working_point_overvolt': 0, 'solar_panel_reversed': 0, 'power_supply_status': 0, 'oo_battery_detected_sld': 0, 'batt_hi_temp_protection_2': 0, 'batt_lo_temp_protection_1': 0, 'overcharge_protection': 0, 'batt_lo_temp_protection_2': 0, 'batt_reversed': 0, 'induction_probe_damaged': 0, 'load_open_circuit': 0}}}, 'scc3': {'load': {'vsat_curr': 1.26, 'bts_curr': 7.6, 'obl': 0.0, 'relay_state': {'vsat': True, 'bts': True, 'obl': True}}, 'load_status': 'is running', 'battery_voltage': 5470, 'battery_temperature': 25, 'device_temperature': 25, 'alarm': {'result': 1, 'fault': {'batt_overdisc': 0, 'batt_overvolt': 0, 'batt_undervolt': 0, 'load_short': 0, 'load_over_current_power': 0, 'controller_temp_high': 0, 'batt_hi_temp_protection_1': 0, 'pv_input_overpower': 0, 'pv_input_overvolt': 0, 'solar_panel_working_point_overvolt': 0, 'solar_panel_reversed': 0, 'power_supply_status': 0, 'oo_battery_detected_sld': 0, 'batt_hi_temp_protection_2': 0, 'batt_lo_temp_protection_1': 0, 'overcharge_protection': 0, 'batt_lo_temp_protection_2': 0, 'batt_reversed': 0, 'induction_probe_damaged': 0, 'load_open_circuit': 0}}}}

scc_logs_epveper = {'scc1': {'load': {'vsat_curr': 1.02, 'bts_curr': 6.98, 'obl': 0.0, 'relay_state': {'vsat': True, 'bts': True, 'obl': False}}, 'load_status': 'is running', 'battery_voltage': 5528, 'battery_temperature': 25.0, 'device_temperature': 27.65, 'alarm': {'battery_status': {'battery_condition': 'normal', 'battery_temperature': 'normal', 'battery_inner_resistance': 'normal', 'battery_identification': 'normal'}, 'charging_status': {'charging_state': 'running', 'charging_condition': 'normal', 'charging_status': 'no_charging', 'pv_input_short': 'normal', 'disequilibrium': 'normal', 'load_mosfet_short': 'normal', 'load_short': 'normal', 'load_over_current': 'normal', 'input_over_current': 'normal', 'anti_reverse_mosfet': 'normal', 'charging_anti_reverse_mosfet': 'normal', 'charging_mosfet_short': 'normal', 'input_voltage_status': 'normal'}, 'discharging_status': {'discharging_state': 'running', 'discharging_condition': 'normal', 'boost_voltage': 'normal', 'high_voltage_side': 'normal', 'input_voltage': 'normal', 'output_voltage': 'normal', 'stop_discharging': 'normal', 'discharge_short': 'normal', 'discharging_output': 'normal', 'output_power': 'light_load'}}}, 'scc2': {'load': {'vsat_curr': 1.02, 'bts_curr': 6.98, 'obl': 0.0, 'relay_state': {'vsat': True, 'bts': True, 'obl': False}}, 'load_status': 'is running', 'battery_voltage': 5528, 'battery_temperature': 25.0, 'device_temperature': 27.39, 'alarm': {'battery_status': {'battery_condition': 'normal', 'battery_temperature': 'normal', 'battery_inner_resistance': 'normal', 'battery_identification': 'normal'}, 'charging_status': {'charging_state': 'running', 'charging_condition': 'normal', 'charging_status': 'no_charging', 'pv_input_short': 'normal', 'disequilibrium': 'normal', 'load_mosfet_short': 'normal', 'load_short': 'normal', 'load_over_current': 'normal', 'input_over_current': 'normal', 'anti_reverse_mosfet': 'normal', 'charging_anti_reverse_mosfet': 'normal', 'charging_mosfet_short': 'normal', 'input_voltage_status': 'normal'}, 'discharging_status': {'discharging_state': 'running', 'discharging_condition': 'normal', 'boost_voltage': 'normal', 'high_voltage_side': 'normal', 'input_voltage': 'normal', 'output_voltage': 'normal', 'stop_discharging': 'normal', 'discharge_short': 'normal', 'discharging_output': 'normal', 'output_power': 'light_load'}}}}


def create_ts(base_time=None):
    if base_time is None:
        now = datetime.datetime.now()
    else:
        now = base_time
    # Round to the nearest 5-minute mark
    minute = (now.minute // 5) * 5
    rounded_time = now.replace(minute=minute, second=0, microsecond=0)
    ts = rounded_time.strftime('%Y%m%dT%H%M%S')
    return ts

def loggers_to_redis():
    base_time = datetime.datetime.now()
    for i in range(25):
        ts = create_ts(base_time)
        red.hset("bms_usb0_log", ts, json.dumps(data_usb0).encode('utf-8'))
        red.hset("bms_usb1_log", ts, json.dumps(data_usb1).encode('utf-8'))
        red.hset("energy_data", ts, json.dumps(energy_data).encode('utf-8'))
        # Increment the base_time by 5 minutes for the next iteration
        base_time += datetime.timedelta(minutes=5)
    print("Done saving to redis")
    

def scc_logs_to_redis():
    base_time = datetime.datetime.now()
    for i in range(25):
        ts = create_ts(base_time)
        red.hset("scc_logs_srne", ts, json.dumps(scc_logs_srne).encode('utf-8'))
        red.hset("scc_logs_epveper", ts, json.dumps(scc_logs_epveper).encode('utf-8'))
        # Increment the base_time by 5 minutes for the next iteration
        base_time += datetime.timedelta(minutes=5)
    print("Done saving to redis")


# get_length = red.hgetall("bms_usb0_log")
# print(len(get_length))

# loggers_to_redis()
scc_logs_to_redis()
