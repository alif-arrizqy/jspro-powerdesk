{% extends 'modern-layout.html' %}
{% block breadcrumbs %}MQTT Bakti Service{% endblock breadcrumbs %}

{% block content %}
<!-- Page Header -->
<div class="row mb-4">
    <div class="col-12">
        <div class="modern-card">
            <div class="modern-card-header">
                <h3 class="modern-card-title">
                    <i class="fas fa-satellite-dish text-primary me-2"></i>
                    MQTT Bakti Service Management
                </h3>
            </div>
            <div class="modern-card-body">
                <div class="alert alert-info" role="alert">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Info:</strong> Memantau aktifitas publish MQTT ke Bakti Broker.
                </div>
                <p class="text-muted mb-0">Kamu bisa memantau dan mengelola MQTT Bakti messaging service secara realtime.</p>
            </div>
        </div>
    </div>
</div>

<!-- Service Status & Controls -->
<div class="row mb-4">
    <div class="col-12">
        <div class="modern-card">
            <div class="modern-card-header">
                <h5 class="modern-card-title">
                    <i class="fas fa-cogs text-success me-2"></i>
                    Service Status & Controls
                </h5>
            </div>
            <div class="modern-card-body">
                <div class="row g-4 justify-content-center">
                    <div class="col-lg-4 col-md-6">
                        <div class="stats-card">
                            <div class="stats-card-header">
                                <h6 class="stats-card-title">Service Status</h6>
                                <div class="stats-card-icon bg-success">
                                    <i class="fas fa-power-off"></i>
                                </div>
                            </div>
                            <h4 class="stats-card-value">
                                <span class="status-indicator inactive" id="service-status">
                                    Loading...
                                </span>
                            </h4>
                            <p class="stats-card-subtitle">MQTT Bakti Service</p>
                        </div>
                    </div>
                    <div class="col-lg-4 col-md-6">
                        <div class="stats-card">
                            <div class="stats-card-header">
                                <h6 class="stats-card-title">Messages Published</h6>
                                <div class="stats-card-icon bg-info">
                                    <i class="fas fa-paper-plane"></i>
                                </div>
                            </div>
                            <h4 class="stats-card-value" id="message-count">0</h4>
                            <p class="stats-card-subtitle">Total Records Today</p>
                        </div>
                    </div>
                    <div class="col-lg-4 col-md-6">
                        <div class="stats-card">
                            <div class="stats-card-header">
                                <h6 class="stats-card-title">Service Control</h6>
                                <div class="stats-card-icon bg-primary">
                                    <i class="fas fa-cog"></i>
                                </div>
                            </div>
                            <div class="d-grid gap-2">
                                <button class="btn btn-modern btn-warning btn-sm" id="restart-service" onclick="restartMqttService()">
                                    <i class="fas fa-redo me-1"></i>
                                    Restart Service
                                </button>
                            </div>
                            <p class="stats-card-subtitle">Service Management</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- MQTT Stats Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="modern-card">
            <div class="modern-card-header">
                <h5 class="modern-card-title">
                    <i class="fas fa-chart-line text-success me-2"></i>
                    MQTT Bakti Statistics
                </h5>
            </div>
            <div class="modern-card-body">
                <div class="row g-3">
                    <div class="col-lg-3 col-md-6">
                        <div class="stats-card">
                            <h6 class="text-muted mb-1"><i class="fas fa-database me-1"></i>Total Records</h6>
                            <h4 class="mb-0" id="total-records">-</h4>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <div class="stats-card">
                            <h6 class="text-muted mb-1"><i class="fas fa-calendar-day me-1"></i>Today Records</h6>
                            <h4 class="mb-0" id="today-records">-</h4>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <div class="stats-card">
                            <h6 class="text-muted mb-1"><i class="fas fa-check-circle me-1"></i>Messages Sent</h6>
                            <h4 class="mb-0 text-success" id="msg-sent">-</h4>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <div class="stats-card">
                            <h6 class="text-muted mb-1"><i class="fas fa-clock me-1"></i>Messages Pending</h6>
                            <h4 class="mb-0 text-warning" id="msg-pending">-</h4>
                        </div>
                    </div>
                    <div class="col-lg-6 col-md-6">
                        <div class="stats-card">
                            <h6 class="text-muted mb-1"><i class="fas fa-history me-1"></i>First Record</h6>
                            <p class="mb-0" id="first-record-ts">-</p>
                        </div>
                    </div>
                    <div class="col-lg-6 col-md-6">
                        <div class="stats-card">
                            <h6 class="text-muted mb-1"><i class="fas fa-clock me-1"></i>Last Record</h6>
                            <p class="mb-0" id="last-record-ts">-</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- MQTT Logs Monitor -->
<div class="row mb-4">
    <div class="col-12">
        <div class="modern-card">
            <div class="modern-card-header">
                <h5 class="modern-card-title">
                    <i class="fas fa-terminal text-primary me-2"></i>
                    MQTT Bakti Service Logs
                    <span class="badge bg-secondary ms-2" id="log-type-badge">All Logs</span>
                </h5>
            </div>
            <div class="modern-card-body">
                <!-- Log Parameters -->
                <div class="row mb-3 g-3">
                    <div class="col-md-3">
                        <label for="log-type" class="form-label">
                            <i class="fas fa-file-alt me-1"></i>
                            Log File Type
                        </label>
                        <select class="form-select form-select-sm" id="log-type">
                            <option value="mqtt_bakti_all.log" selected>All Logs</option>
                            <option value="mqtt_bakti_errors.log">Error Logs</option>
                            <option value="mqtt_bakti_warnings.log">Warning Logs</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="log-lines" class="form-label">
                            <i class="fas fa-list-ol me-1"></i>
                            Lines
                        </label>
                        <select class="form-select form-select-sm" id="log-lines">
                            <option value="20">20 lines</option>
                            <option value="50">50 lines</option>
                            <option value="100" selected>100 lines</option>
                            <option value="200">200 lines</option>
                            <option value="500">500 lines</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">
                            <i class="fas fa-sort me-1"></i>
                            Order
                        </label>
                        <div class="form-check form-switch mt-2">
                            <input class="form-check-input" type="checkbox" id="log-reverse" checked>
                            <label class="form-check-label" for="log-reverse">
                                Newest First
                            </label>
                        </div>
                    </div>
                    <div class="col-md-5 text-end">
                        <label class="form-label">&nbsp;</label>
                        <div class="d-flex gap-2 justify-content-end">
                            <button class="btn btn-modern btn-primary btn-sm" onclick="showMqttLogs()">
                                <i class="fas fa-eye me-1"></i>
                                Show Logs
                            </button>
                            <button class="btn btn-modern btn-outline-secondary btn-sm" onclick="refreshMqttLogs()">
                                <i class="fas fa-sync-alt me-1"></i>
                                Refresh
                            </button>
                            <button class="btn btn-modern btn-outline-danger btn-sm" onclick="clearLogFile()">
                                <i class="fas fa-trash me-1"></i>
                                Clear Logs
                            </button>
                            <button class="btn btn-modern btn-outline-info btn-sm" onclick="downloadLogs()">
                                <i class="fas fa-download me-1"></i>
                                Download
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Log Display Area -->
                <div class="mqtt-monitor">
                    <div class="monitor-log" id="mqtt-log" style="height: 450px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 12px; background-color: #1e1e1e; color: #d4d4d4; padding: 15px; border-radius: 5px;">
                        <div class="text-center text-muted p-3">
                            <i class="fas fa-info-circle me-2"></i>
                            Click "Show Logs" to display MQTT Bakti service logs...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- MQTT Bakti Configuration -->
<div class="row">
    <div class="col-12">
        <div class="modern-card">
            <div class="modern-card-header">
                <h5 class="modern-card-title">
                    <i class="fas fa-cog text-warning me-2"></i>
                    MQTT Bakti Configuration (eHub Broker)
                </h5>
            </div>
            <div class="modern-card-body">
                <div class="row g-4">
                    <div class="col-lg-6 col-md-6">
                        <div class="config-item">
                            <label class="form-label">
                                <i class="fas fa-server me-2"></i>
                                Broker Host
                            </label>
                            <input type="text" class="form-control" value="{{ mqtt_config.ehub_broker.host if mqtt_config and mqtt_config.ehub_broker else 'localhost' }}" readonly>
                        </div>
                    </div>
                    <div class="col-lg-6 col-md-6">
                        <div class="config-item">
                            <label class="form-label">
                                <i class="fas fa-plug me-2"></i>
                                Port
                            </label>
                            <input type="text" class="form-control" value="{{ mqtt_config.ehub_broker.port if mqtt_config and mqtt_config.ehub_broker else '1883' }}" readonly>
                        </div>
                    </div>
                    <div class="col-lg-6 col-md-6">
                        <div class="config-item">
                            <label class="form-label">
                                <i class="fas fa-user me-2"></i>
                                Username
                            </label>
                            <input type="text" class="form-control" value="{{ mqtt_config.ehub_broker.username if mqtt_config and mqtt_config.ehub_broker else 'N/A' }}" readonly>
                        </div>
                    </div>
                    <div class="col-lg-6 col-md-6">
                        <div class="config-item">
                            <label class="form-label">
                                <i class="fas fa-shield-alt me-2"></i>
                                Password
                            </label>
                            <input type="password" class="form-control" value="{{ mqtt_config.ehub_broker.password if mqtt_config and mqtt_config.ehub_broker else 'N/A' }}" readonly>
                        </div>
                    </div>
                    <div class="col-lg-6 col-md-6">
                        <div class="config-item">
                            <label class="form-label">
                                <i class="fas fa-network-wired me-2"></i>
                                OpenVPN IP
                            </label>
                            <input type="text" class="form-control" value="{{ mqtt_config.ehub_broker.openvpn_ip if mqtt_config and mqtt_config.ehub_broker else 'N/A' }}" readonly>
                        </div>
                    </div>
                    <div class="col-lg-6 col-md-6">
                        <div class="config-item">
                            <label class="form-label">
                                <i class="fas fa-tag me-2"></i>
                                Topic Prefix
                            </label>
                            <input type="text" class="form-control" value="{{ mqtt_config.ehub_broker.topic if mqtt_config and mqtt_config.ehub_broker else 'N/A' }}" readonly>
                        </div>
                    </div>
                </div>
                
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="alert alert-warning" role="alert">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Note:</strong> MQTT Bakti configuration is managed through the system configuration file. 
                            Contact administrator to modify these settings.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Service Action Modal -->
<div class="modal fade" id="serviceActionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning text-white">
                <h5 class="modal-title">
                    <i class="fas fa-cog me-2"></i>Restart MQTT Bakti Service
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning" role="alert">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Warning:</strong> This will restart the MQTT Bakti service. This action may briefly interrupt message publishing to eHub broker.
                </div>
                <div class="mb-3">
                    <label for="action-user" class="form-label">
                        <i class="fas fa-user me-2"></i>
                        User
                    </label>
                    <select class="form-select" id="action-user" required>
                        <option value="admin" selected>Admin</option>
                        <option value="teknisi">Teknisi</option>
                        <option value="apt">APT</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="action-password" class="form-label">
                        <i class="fas fa-lock me-2"></i>
                        Password
                    </label>
                    <input type="password" class="form-control" id="action-password" placeholder="Enter your password" required>
                    <div class="invalid-feedback" id="action-password-error"></div>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="action-confirm">
                    <label class="form-check-label" for="action-confirm">
                        I understand the consequences of this action
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" id="confirm-action-btn" onclick="executeServiceRestart()">
                    <i class="fas fa-redo me-2"></i>Restart Service
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block scripts %}
<script>
// Inline MQTT Bakti page script
(function(){
    'use strict';

    // Inject user token from server-side session into JS
    const userToken = '{{ session.get("auth_token", "") }}';

    async function fetchJson(url, opts){
        try{
            opts = opts || {};
            opts.headers = Object.assign({}, opts.headers || {});
            if(userToken) opts.headers['Authorization'] = `Bearer ${userToken}`;

            const res = await fetch(url, opts);
            if(!res.ok) throw new Error(`HTTP ${res.status}`);
            return await res.json();
        }catch(err){
            console.error('fetchJson error', err, url);
            return null;
        }
    }

    function formatTimestamp(ts){
        if(!ts || ts === 'N/A' || ts === '-') return 'N/A';
        // Assuming format: YYYYMMDDThhmmss
        try{
            const match = ts.match(/^(\d{4})(\d{2})(\d{2})T(\d{2})(\d{2})(\d{2})$/);
            if(match){
                return `${match[1]}-${match[2]}-${match[3]} ${match[4]}:${match[5]}:${match[6]}`;
            }
        }catch(e){}
        return ts;
    }

    window.updateServiceStatus = async function(){
        const fetchServiceStatus = await fetchJson('/api/v1/service/systemd/list');
        
        if (fetchServiceStatus && fetchServiceStatus.status === 'success' && fetchServiceStatus.data){
            const data = fetchServiceStatus.data;
            const servicesStatus = data.services_status;
            
            // Get mqtt_bakti_publisher.service status
            const baktiStatus = servicesStatus['mqtt_bakti_publisher.service'] || 'unknown';
            
            // Update status indicator
            const statusIndicator = document.getElementById('service-status');
            if(statusIndicator){
                // Update text based on status
                let displayText = 'Unknown';
                let isActive = false;
                
                switch(baktiStatus) {
                    case 'active':
                        displayText = 'Running';
                        isActive = true;
                        break;
                    case 'inactive':
                        displayText = 'Stopped';
                        isActive = false;
                        break;
                    case 'failed':
                        displayText = 'Failed';
                        isActive = false;
                        break;
                    case 'unknown':
                    default:
                        displayText = 'Unknown';
                        isActive = false;
                        break;
                }
                
                statusIndicator.textContent = displayText;
                statusIndicator.classList.remove('active', 'inactive', 'stopped', 'failed');
                
                if(isActive) {
                    statusIndicator.classList.add('active');
                } else if(baktiStatus === 'failed') {
                    statusIndicator.classList.add('failed');
                } else {
                    statusIndicator.classList.add('inactive');
                }
            }
        }
    };

    window.loadMqttStats = async function(){
        const stats = await fetchJson('/api/v1/service/mqtt-bakti/stats');
        
        if(stats && stats.status === 'success' && stats.data){
            const data = stats.data;
            
            // Update stats display
            document.getElementById('total-records').textContent = data.total_records || 0;
            document.getElementById('today-records').textContent = data.today_records || 0;
            document.getElementById('msg-sent').textContent = data.total_msg_sent || 0;
            document.getElementById('msg-pending').textContent = data.total_msg_pending || 0;
            document.getElementById('first-record-ts').textContent = formatTimestamp(data.first_record_timestamp);
            document.getElementById('last-record-ts').textContent = formatTimestamp(data.last_record_timestamp);
            
            // Update service status
            const msgCount = document.getElementById('message-count');
            if(msgCount) msgCount.textContent = data.today_records || 0;
        }
    };

    window.showMqttLogs = async function(){
        const logType = document.getElementById('log-type')?.value || 'mqtt_bakti_all.log';
        const lines = document.getElementById('log-lines')?.value || 100;
        const reverse = document.getElementById('log-reverse')?.checked || false;
        const container = document.getElementById('mqtt-log');
        
        // Update badge
        const badge = document.getElementById('log-type-badge');
        if(badge){
            if(logType.includes('all')) badge.textContent = 'All Logs';
            else if(logType.includes('error')) badge.textContent = 'Error Logs';
            else if(logType.includes('warning')) badge.textContent = 'Warning Logs';
        }
        
        if(container) container.innerHTML = '<div class="text-center p-3" style="color: #888;"><i class="fas fa-spinner fa-spin me-2"></i>Loading logs...</div>';
        
        try{
            const url = `/api/v1/service/mqtt-bakti/logs?log_type=${encodeURIComponent(logType)}&lines=${encodeURIComponent(lines)}&reverse=${reverse}`;
            const res = await fetch(url, {
                headers: { 'Authorization': `Bearer ${userToken}` }
            });
            
            if(!res.ok) throw new Error('Failed to fetch logs');
            
            const data = await res.json();
            
            if(data.status === 'success' && data.data && data.data.logs){
                const logs = data.data.logs;
                if(logs.length === 0){
                    container.innerHTML = '<div class="text-center p-3" style="color: #888;"><i class="fas fa-info-circle me-2"></i>No logs available</div>';
                } else {
                    container.innerHTML = '<pre style="margin: 0; white-space: pre-wrap; word-wrap: break-word;">' + 
                                         logs.map(log => escapeHtml(log)).join('\n') + '</pre>';
                    
                    // Auto scroll to bottom if reverse is false
                    if(!reverse){
                        container.scrollTop = container.scrollHeight;
                    }
                }
            } else {
                container.innerHTML = '<div class="text-danger p-3"><i class="fas fa-exclamation-circle me-2"></i>Failed to load logs</div>';
            }
        }catch(err){
            console.error('showMqttLogs error:', err);
            if(container) container.innerHTML = '<div class="text-danger p-3"><i class="fas fa-exclamation-circle me-2"></i>Error: ' + escapeHtml(err.message) + '</div>';
        }
    };

    window.refreshMqttLogs = function(){
        showMqttLogs();
    };

    window.clearLogFile = async function(){
        if(!confirm('Are you sure you want to clear the selected log file? This action cannot be undone.')){
            return;
        }
        
        const logType = document.getElementById('log-type')?.value || 'mqtt_bakti_all.log';
        
        try{
            const url = `/api/v1/service/mqtt-bakti/logs/clear?log_type=${encodeURIComponent(logType)}`;
            const res = await fetch(url, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${userToken}` }
            });
            
            if(!res.ok) throw new Error('Failed to clear logs');
            
            const data = await res.json();
            
            if(data.status === 'success'){
                alert(data.message || 'Log file cleared successfully');
                // Clear the display
                const container = document.getElementById('mqtt-log');
                if(container) container.innerHTML = '<div class="text-center p-3" style="color: #888;"><i class="fas fa-info-circle me-2"></i>Log file has been cleared</div>';
            } else {
                alert('Failed to clear log file: ' + (data.message || 'Unknown error'));
            }
        }catch(err){
            console.error('clearLogFile error:', err);
            alert('Error clearing log file: ' + err.message);
        }
    };

    window.downloadLogs = async function(){
        const logType = document.getElementById('log-type')?.value || 'mqtt_bakti_all.log';
        const lines = 5000; // Default for download
        
        try{
            const url = `/api/v1/service/mqtt-bakti/logs/download?log_type=${encodeURIComponent(logType)}&lines=${lines}`;
            const res = await fetch(url, { 
                headers: { 'Authorization': `Bearer ${userToken}` } 
            });
            
            if(!res.ok) throw new Error('Download failed');
            
            const blob = await res.blob();
            const filename = `${logType.replace('.log', '')}_${new Date().toISOString().slice(0,10)}.log`;
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            link.remove();
        }catch(err){
            console.error('downloadLogs error:', err);
            alert('Failed to download logs: ' + err.message);
        }
    };

    window.restartMqttService = function(){
        const modalEl = document.getElementById('serviceActionModal');
        if(!modalEl) return;
        const bsModal = bootstrap.Modal.getOrCreateInstance(modalEl);
        bsModal.show();
    };

    window.executeServiceRestart = async function(){
        const pwd = document.getElementById('action-password')?.value;
        const user = document.getElementById('action-user')?.value || 'admin';
        const confirm = document.getElementById('action-confirm')?.checked;
        const errEl = document.getElementById('action-password-error');
        
        if(!confirm){
            if(errEl) errEl.textContent = 'You must confirm the action.';
            return;
        }
        if(!pwd){
            if(errEl) errEl.textContent = 'Password required';
            return;
        }
        if(errEl) errEl.textContent = '';

        try{
            const res = await fetch('/api/v1/service/systemd/action', {
                method: 'POST',
                headers: Object.assign({'Content-Type': 'application/json'}, userToken ? {'Authorization': `Bearer ${userToken}`} : {}),
                body: JSON.stringify({
                    service: 'mqtt_bakti_publisher.service',
                    action: 'restart',
                    password: pwd,
                    user: user
                })
            });
            
            if(!res.ok) throw new Error('Restart failed');
            
            const json = await res.json();
            const modalEl = document.getElementById('serviceActionModal');
            bootstrap.Modal.getOrCreateInstance(modalEl).hide();
            
            if(json.status === 'success'){
                alert(json.message || 'Service restarted successfully');
                // Refresh service status after restart
                setTimeout(() => {
                    updateServiceStatus();
                    loadMqttStats();
                }, 2000);
            } else {
                alert('Failed: ' + (json.message || 'Unknown error'));
            }
        }catch(err){
            console.error('executeServiceRestart error:', err);
            alert('Failed to request restart: ' + err.message);
        }
    };

    function escapeHtml(text){
        const map = {'&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;'};
        return text.replace(/[&<>"']/g, m => map[m]);
    }

    // Auto refresh stats every 30 seconds
    setInterval(() => {
        loadMqttStats();
        updateServiceStatus();
    }, 30000);

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', () => {
        loadMqttStats();
        updateServiceStatus();
    });

})();
</script>
<link rel="stylesheet" href="{{ url_for('static', filename='css/modern-style.css') }}">
{% endblock scripts %}
