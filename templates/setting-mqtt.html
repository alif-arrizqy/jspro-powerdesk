{% extends 'modern-layout.html' %}
{% block breadcrumbs %}MQTT Settings{% endblock breadcrumbs %}

{% block content %}
<!-- Page Header -->
<div class="row mb-4">
    <div class="col-12">
        <div class="modern-card">
            <div class="modern-card-header">
                <h3 class="modern-card-title">
                    <i class="fas fa-broadcast-tower text-primary me-2"></i>
                    MQTT Configuration
                </h3>
            </div>
            <div class="modern-card-body">
                <p class="text-muted mb-0">Konfigurasi koneksi MQTT broker untuk Bakti dan Sundaya.</p>
            </div>
        </div>
    </div>
</div>

<!-- MQTT Status Summary -->
<div class="row mb-3">
    <div class="col-12">
        <div class="modern-card">
            <div class="modern-card-header">
                <h5 class="modern-card-title">
                    <i class="fas fa-chart-line text-success me-2"></i>
                    MQTT Connection Status
                </h5>
            </div>
            <div class="modern-card-body">
                <div class="row g-4">
                    <!-- Bakti Status -->
                    <div class="col-lg-3 col-md-6">
                        <div class="stats-card">
                            <div class="stats-card-header">
                                <h6 class="stats-card-title">Bakti Broker</h6>
                                <div class="stats-card-icon bg-primary">
                                    <i class="fas fa-server"></i>
                                </div>
                            </div>
                            <h4 class="stats-card-value" id="bakti-host-display">{{mqtt_config.ehub_broker.host or 'Not Set'}}</h4>
                            <p class="stats-card-subtitle">Host: Port {{mqtt_config.ehub_broker.port or '-'}}</p>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <div class="stats-card">
                            <div class="stats-card-header">
                                <h6 class="stats-card-title">Bakti Status</h6>
                                <div class="stats-card-icon bg-success">
                                    <i class="fas fa-wifi"></i>
                                </div>
                            </div>
                            <h4 class="stats-card-value">
                                <span class="badge bg-success" id="bakti-status">
                                    {% if mqtt_config.ehub_broker.host %}Configured{% else %}Pending{% endif %}
                                </span>
                            </h4>
                            <p class="stats-card-subtitle">Connection Status</p>
                        </div>
                    </div>
                    <!-- Sundaya Status -->
                    <div class="col-lg-3 col-md-6">
                        <div class="stats-card">
                            <div class="stats-card-header">
                                <h6 class="stats-card-title">Sundaya Broker</h6>
                                <div class="stats-card-icon bg-info">
                                    <i class="fas fa-server"></i>
                                </div>
                            </div>
                            <h4 class="stats-card-value" id="sundaya-host-display">{{mqtt_config.sundaya_broker.host or 'Not Set'}}</h4>
                            <p class="stats-card-subtitle">Host: Port {{mqtt_config.sundaya_broker.port or '-'}}</p>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <div class="stats-card">
                            <div class="stats-card-header">
                                <h6 class="stats-card-title">Sundaya Status</h6>
                                <div class="stats-card-icon bg-warning">
                                    <i class="fas fa-wifi"></i>
                                </div>
                            </div>
                            <h4 class="stats-card-value">
                                <span class="badge bg-success" id="sundaya-status">
                                    {% if mqtt_config.sundaya_broker.host %}Configured{% else %}Pending{% endif %}
                                </span>
                            </h4>
                            <p class="stats-card-subtitle">Connection Status</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- MQTT Configuration Forms -->
<div class="row">
    <!-- MQTT Bakti (ehub_broker) -->
    <div class="col-lg-6 mb-4">
        <div class="modern-card">
            <div class="modern-card-header">
                <h5 class="modern-card-title">
                    <i class="fas fa-satellite-dish text-primary me-2"></i>
                    MQTT Bakti (Ehub Broker)
                </h5>
            </div>
            <div class="modern-card-body">
                <form method="POST" id="mqtt-bakti-form">
                    <input type="hidden" name="setting-mqtt-bakti-form" value="setting-mqtt-bakti-form">
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="bakti-host" class="form-label">
                                <i class="fas fa-server me-2"></i>Host/IP Address
                            </label>
                            <input type="text" class="form-control" name="bakti-host" id="bakti-host" 
                                   placeholder="192.168.1.100" value="{{mqtt_config.ehub_broker.host}}" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="bakti-port" class="form-label">
                                <i class="fas fa-plug me-2"></i>Port
                            </label>
                            <input type="number" class="form-control" name="bakti-port" id="bakti-port" 
                                   placeholder="1883" value="{{mqtt_config.ehub_broker.port}}" min="1" max="65535" required>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="bakti-username" class="form-label">
                                <i class="fas fa-user me-2"></i>Username
                            </label>
                            <input type="text" class="form-control" name="bakti-username" id="bakti-username" 
                                   placeholder="mqtt_user" value="{{mqtt_config.ehub_broker.username}}">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="bakti-password" class="form-label">
                                <i class="fas fa-lock me-2"></i>Password
                            </label>
                            <div class="input-group">
                                <input type="password" class="form-control" name="bakti-password" id="bakti-password" 
                                       placeholder="••••••••" value="{{mqtt_config.ehub_broker.password}}">
                                <button class="btn btn-outline-secondary toggle-password" type="button" data-target="bakti-password">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="bakti-openvpn-ip" class="form-label">
                                <i class="fas fa-shield-alt me-2"></i>OpenVPN IP
                            </label>
                            <input type="text" class="form-control" name="bakti-openvpn-ip" id="bakti-openvpn-ip" 
                                   placeholder="10.8.0.1" value="{{mqtt_config.ehub_broker.openvpn_ip}}">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="bakti-topic" class="form-label">
                                <i class="fas fa-folder me-2"></i>Topic Prefix
                            </label>
                            <input type="text" class="form-control" name="bakti-topic" id="bakti-topic" 
                                   placeholder="sundaya/mqtt/bakti" value="{{mqtt_config.ehub_broker.topic}}" required>
                        </div>
                    </div>
                    
                    <div class="alert alert-info d-flex align-items-center py-2" role="alert">
                        <i class="fas fa-info-circle me-2"></i>
                        <small>Konfigurasi broker MQTT untuk koneksi ke sistem Bakti</small>
                    </div>
                    
                    <div class="d-grid">
                        <button type="submit" class="btn btn-modern btn-primary">
                            <i class="fas fa-save me-2"></i>Save MQTT Bakti Settings
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- MQTT Sundaya (sundaya_broker) -->
    <div class="col-lg-6 mb-4">
        <div class="modern-card">
            <div class="modern-card-header">
                <h5 class="modern-card-title">
                    <i class="fas fa-cloud text-info me-2"></i>
                    MQTT Sundaya (Sundaya Broker)
                </h5>
            </div>
            <div class="modern-card-body">
                <form method="POST" id="mqtt-sundaya-form">
                    <input type="hidden" name="setting-mqtt-sundaya-form" value="setting-mqtt-sundaya-form">
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="sundaya-host" class="form-label">
                                <i class="fas fa-server me-2"></i>Host/IP Address
                            </label>
                            <input type="text" class="form-control" name="sundaya-host" id="sundaya-host" 
                                   placeholder="192.168.1.100" value="{{mqtt_config.sundaya_broker.host}}" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="sundaya-port" class="form-label">
                                <i class="fas fa-plug me-2"></i>Port
                            </label>
                            <input type="number" class="form-control" name="sundaya-port" id="sundaya-port" 
                                   placeholder="1883" value="{{mqtt_config.sundaya_broker.port}}" min="1" max="65535" required>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="sundaya-username" class="form-label">
                                <i class="fas fa-user me-2"></i>Username
                            </label>
                            <input type="text" class="form-control" name="sundaya-username" id="sundaya-username" 
                                   placeholder="mqtt_user" value="{{mqtt_config.sundaya_broker.username}}">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="sundaya-password" class="form-label">
                                <i class="fas fa-lock me-2"></i>Password
                            </label>
                            <div class="input-group">
                                <input type="password" class="form-control" name="sundaya-password" id="sundaya-password" 
                                       placeholder="••••••••" value="{{mqtt_config.sundaya_broker.password}}">
                                <button class="btn btn-outline-secondary toggle-password" type="button" data-target="sundaya-password">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <label for="sundaya-topic" class="form-label">
                                <i class="fas fa-folder me-2"></i>Topic Prefix
                            </label>
                            <input type="text" class="form-control" name="sundaya-topic" id="sundaya-topic" 
                                   placeholder="sundaya/mqtt" value="{{mqtt_config.sundaya_broker.topic}}" required>
                        </div>
                    </div>
                    
                    <div class="alert alert-warning d-flex align-items-center py-2" role="alert">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <small>Konfigurasi broker MQTT untuk koneksi ke sistem Sundaya</small>
                    </div>
                    
                    <div class="d-grid">
                        <button type="submit" class="btn btn-modern btn-info">
                            <i class="fas fa-save me-2"></i>Save MQTT Sundaya Settings
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Password toggle functionality
    const toggleButtons = document.querySelectorAll('.toggle-password');
    toggleButtons.forEach(btn => {
        btn.addEventListener('click', function() {
            const targetId = this.getAttribute('data-target');
            const passwordField = document.getElementById(targetId);
            const icon = this.querySelector('i');
            
            if (passwordField) {
                const type = passwordField.getAttribute('type') === 'password' ? 'text' : 'password';
                passwordField.setAttribute('type', type);
                
                if (type === 'password') {
                    icon.classList.remove('fa-eye-slash');
                    icon.classList.add('fa-eye');
                } else {
                    icon.classList.remove('fa-eye');
                    icon.classList.add('fa-eye-slash');
                }
            }
        });
    });
    
    // Form validation for both forms
    const forms = ['mqtt-bakti-form', 'mqtt-sundaya-form'];
    forms.forEach(formId => {
        const form = document.getElementById(formId);
        if (form) {
            form.addEventListener('submit', function(e) {
                const inputs = form.querySelectorAll('input[required]');
                let isValid = true;
                
                inputs.forEach(input => {
                    if (!input.value.trim()) {
                        input.classList.add('is-invalid');
                        isValid = false;
                    } else {
                        input.classList.remove('is-invalid');
                        input.classList.add('is-valid');
                    }
                });
                
                // Port validation
                const portFields = form.querySelectorAll('input[type="number"]');
                portFields.forEach(portField => {
                    const port = parseInt(portField.value);
                    if (port < 1 || port > 65535) {
                        portField.classList.add('is-invalid');
                        isValid = false;
                    }
                });
                
                if (!isValid) {
                    e.preventDefault();
                    showAlert('Please fix the validation errors before submitting', 'danger');
                    return;
                }
                
                // Show loading state
                const submitBtn = form.querySelector('button[type="submit"]');
                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Saving...';
                    
                    setTimeout(() => {
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = submitBtn.innerHTML.replace('Saving...', 'Save');
                    }, 5000);
                }
            });
        }
    });
    
    // Real-time input validation
    const inputs = document.querySelectorAll('form input');
    inputs.forEach(input => {
        input.addEventListener('input', function() {
            this.classList.remove('is-invalid', 'is-valid');
            if (this.value.trim()) {
                if (this.type === 'number') {
                    const port = parseInt(this.value);
                    if (port >= 1 && port <= 65535) {
                        this.classList.add('is-valid');
                    }
                } else {
                    this.classList.add('is-valid');
                }
            }
        });
    });
    
    function showAlert(message, type) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.innerHTML = `
            <i class="fas fa-info-circle me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        const firstCard = document.querySelector('.modern-card');
        firstCard.parentNode.insertBefore(alertDiv, firstCard);
        
        setTimeout(() => {
            alertDiv.remove();
        }, 3000);
    }
});
</script>
{% endblock scripts %}

