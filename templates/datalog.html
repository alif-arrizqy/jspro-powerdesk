{% extends 'modern-layout.html' %}
{% block breadcrumbs %}Data Log Management{% endblock breadcrumbs %}

{% block content %}
<!-- Page Header -->
<div class="row mb-4">
    <div class="col-12">
        <div class="modern-card">
            <div class="modern-card-header">
                <h3 class="modern-card-title">
                    <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                    Data Log Management
                </h3>
            </div>
            <div class="modern-card-body">
                <p class="text-muted mb-0">Monitor and manage data in Redis and SQLite.</p>
            </div>
        </div>
    </div>
</div>

<!-- Storage Overview -->
<div class="row mb-4">
    <div class="col-12">
        <div class="modern-card">
            <div class="modern-card-header">
                <h5 class="modern-card-title">
                    <i class="fas fa-chart-bar text-info me-2"></i>
                    Storage Overview
                </h5>
            </div>
            <div class="modern-card-body">
                <div class="row g-4">
                    <div class="col-lg-6 col-md-6">
                        <div class="stats-card">
                            <div class="stats-card-header">
                                <h6 class="stats-card-title">Redis Storage</h6>
                                <div class="stats-card-icon bg-danger">
                                    <i class="fas fa-memory"></i>
                                </div>
                            </div>
                            <h3 class="stats-card-value" id="redis-storage">Loading...</h3>
                            <p class="stats-card-subtitle">Memory Usage</p>
                        </div>
                    </div>
                    <div class="col-lg-6 col-md-6">
                        <div class="stats-card">
                            <div class="stats-card-header">
                                <h6 class="stats-card-title">SQLite Storage</h6>
                                <div class="stats-card-icon bg-warning">
                                    <i class="fas fa-hdd"></i>
                                </div>
                            </div>
                            <h3 class="stats-card-value" id="sqlite-storage">Loading...</h3>
                            <p class="stats-card-subtitle">Disk Usage</p>
                        </div>
                    </div>
                </div>
                <div class="row g-4 mt-3">
                    <div class="col-lg-12 col-md-12">
                        <div class="stats-card">
                            <div class="stats-card-header">
                                <h6 class="stats-card-title">Disk Usage</h6>
                                <div class="stats-card-icon bg-info">
                                    <i class="fas fa-server"></i>
                                </div>
                            </div>
                            <div class="disk-usage-container">
                                <!-- Disk Usage Progress Bar -->
                                <div class="disk-progress-wrapper mb-3">
                                    <div class="progress" style="height: 25px; border-radius: 15px; background-color: #e9ecef;">
                                        <div class="progress-bar progress-bar-striped" id="disk-progress-bar" 
                                             role="progressbar" style="width: 0%; background: linear-gradient(90deg, #28a745 0%, #ffc107 70%, #dc3545 90%);" 
                                             aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                            <span class="progress-text" id="disk-progress-text" style="color: white; font-weight: bold; font-size: 14px;">Loading...</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Disk Usage Statistics -->
                                <div class="row text-center">
                                    <div class="col-4">
                                        <div class="disk-stat-item">
                                            <div class="disk-stat-icon text-success">
                                                <i class="fas fa-check-circle"></i>
                                            </div>
                                            <div class="disk-stat-value" id="disk-free-value">0 GB</div>
                                            <div class="disk-stat-label">Free Space</div>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="disk-stat-item">
                                            <div class="disk-stat-icon text-warning">
                                                <i class="fas fa-chart-pie"></i>
                                            </div>
                                            <div class="disk-stat-value" id="disk-used-value">0 GB</div>
                                            <div class="disk-stat-label">Used Space</div>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="disk-stat-item">
                                            <div class="disk-stat-icon text-info">
                                                <i class="fas fa-hdd"></i>
                                            </div>
                                            <div class="disk-stat-value" id="disk-total-value">0 GB</div>
                                            <div class="disk-stat-label">Total Space</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Status Badge -->
                                <div class="text-center mt-3">
                                    <span class="badge" id="disk-status-badge" style="font-size: 12px; padding: 8px 16px;">
                                        <i class="fas fa-circle-notch fa-spin me-2"></i>
                                        Checking Status...
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Data Statistics -->
<div class="row mb-4">
    <div class="col-12">
        <div class="modern-card">
            <div class="modern-card-header flex-wrap gap-3 d-flex justify-content-between align-items-center">
                <h5 class="modern-card-title mb-0">
                    <i class="fas fa-chart-line text-success me-2"></i>
                    Data Statistics
                </h5>
                <div class="d-flex flex-wrap align-items-center gap-2">
                    <div>
                        <label for="log-type-select" class="form-label text-muted mb-1 small">Log Type</label>
                        <select id="log-type-select" class="form-select form-select-sm shadow-sm">
                            <option value="battery">Battery</option>
                            <option value="energy">Energy / SCC</option>
                            <option value="bakti_mqtt">Bakti MQTT</option>
                        </select>
                    </div>
                    <div class="d-flex flex-column gap-1">
                        <span class="badge bg-secondary text-white" id="redis-availability-badge">
                            <i class="fas fa-bolt me-1"></i>Redis
                        </span>
                        <span class="badge bg-secondary text-white" id="sqlite-availability-badge">
                            <i class="fas fa-database me-1"></i>SQLite
                        </span>
                    </div>
                </div>
            </div>
            <div class="modern-card-body">
                <div class="row g-4">
                    <div class="col-lg-4 col-md-6">
                        <div class="stats-card">
                            <div class="stats-card-header">
                                <h6 class="stats-card-title">Redis Records</h6>
                                <div class="stats-card-icon bg-primary">
                                    <i class="fas fa-memory"></i>
                                </div>
                            </div>
                            <h3 class="stats-card-value" id="redis-log-count">--</h3>
                            <p class="stats-card-subtitle">Selected log type</p>
                            <p class="text-muted small mb-0">
                                <i class="far fa-clock me-1"></i>
                                <span id="redis-log-range">Awaiting data...</span>
                            </p>
                        </div>
                    </div>
                    <div class="col-lg-4 col-md-6">
                        <div class="stats-card">
                            <div class="stats-card-header">
                                <h6 class="stats-card-title">SQLite Records</h6>
                                <div class="stats-card-icon bg-warning">
                                    <i class="fas fa-database"></i>
                                </div>
                            </div>
                            <h3 class="stats-card-value" id="sqlite-log-count">--</h3>
                            <p class="stats-card-subtitle">Selected log type</p>
                            <p class="text-muted small mb-0">
                                <i class="far fa-clock me-1"></i>
                                <span id="sqlite-log-range">Awaiting data...</span>
                            </p>
                        </div>
                    </div>
                    <div class="col-lg-4 col-md-6">
                        <div class="stats-card">
                            <div class="stats-card-header">
                                <h6 class="stats-card-title">Last Update</h6>
                                <div class="stats-card-icon bg-info">
                                    <i class="fas fa-clock"></i>
                                </div>
                            </div>
                            <h3 class="stats-card-value" id="logs-last-update">--</h3>
                            <p class="stats-card-subtitle">Data snapshot</p>
                        </div>
                    </div>
                </div>
                <div class="row g-4 mt-3">
                    <div class="col-md-6">
                        <div class="d-flex align-items-center gap-2">
                            <span class="text-muted small">Redis Status:</span>
                            <span class="status-indicator" id="datalog-status">--</span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="d-flex align-items-center gap-2">
                            <span class="text-muted small">Data Health:</span>
                            <span class="status-indicator" id="data-health">--</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Data Operations -->
<div class="row">
    <div class="col-12">
        <div class="modern-card">
            <div class="modern-card-header">
                <h3 class="modern-card-title">
                    <i class="fas fa-tools"></i>
                    Data Operations
                </h3>
            </div>
            <div class="modern-card-body">
                <p class="text-muted mb-3">
                    Actions will be applied to
                    <span class="fw-semibold" id="current-log-type-label">Battery</span>
                    logs.
                </p>
                <div class="row g-3">
                    <div class="col-lg-3 col-md-6">
                        <div class="modern-card">
                            <div class="modern-card-body text-center">
                                <div class="mb-3">
                                    <i class="fas fa-download text-primary" style="font-size: 2rem;"></i>
                                </div>
                                <h5 class="mb-3">Download Redis Data</h5>
                                <p class="text-muted mb-3">Export Redis data to JSON</p>
                                <button class="btn btn-modern btn-primary w-100" id="download-redis" onclick="downloadRedisData();">
                                    <i class="fas fa-download"></i>
                                    Download Redis
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <div class="modern-card">
                            <div class="modern-card-body text-center">
                                <div class="mb-3">
                                    <i class="fas fa-download text-warning" style="font-size: 2rem;"></i>
                                </div>
                                <h5 class="mb-3">Download SQLite Data</h5>
                                <p class="text-muted mb-3">Export SQLite database to JSON</p>
                                <button class="btn btn-modern btn-warning w-100" id="download-sqlite" onclick="downloadSqliteData();">
                                    <i class="fas fa-download"></i>
                                    Download SQLite
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <div class="modern-card">
                            <div class="modern-card-body text-center">
                                <div class="mb-3">
                                    <i class="fas fa-trash-alt text-danger" style="font-size: 2rem;"></i>
                                </div>
                                <h5 class="mb-3">Clear Redis Data</h5>
                                <p class="text-muted mb-3">Remove all Redis cache data</p>
                                <button class="btn btn-modern btn-danger w-100" id="clear-redis" onclick="clearRedisData();">
                                    <i class="fas fa-trash-alt"></i>
                                    Clear Redis
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <div class="modern-card">
                            <div class="modern-card-body text-center">
                                <div class="mb-3">
                                    <i class="fas fa-trash-alt text-danger" style="font-size: 2rem;"></i>
                                </div>
                                <h5 class="mb-3">Clear SQLite Data</h5>
                                <p class="text-muted mb-3">Remove all SQLite database data</p>
                                <button class="btn btn-modern btn-danger w-100" id="clear-sqlite" onclick="clearSqliteData();">
                                    <i class="fas fa-trash-alt"></i>
                                    Clear SQLite
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block scripts %}
<script>
    // Configuration
const API_BASE_URL = '/api/v1/loggers';
const siteName = "{{ site_name }}";
const AUTH_TOKEN = '{{ session.get("auth_token", "") }}';
const DOWNLOAD_PAGE_SIZE = 1000;
const LOG_TYPE_CONFIG = {
    battery: { label: 'Battery', sources: { redis: true, sqlite: true } },
    energy: { label: 'Energy / SCC', sources: { redis: true, sqlite: true } },
    bakti_mqtt: { label: 'Bakti MQTT', sources: { redis: false, sqlite: true } }
};
const sourceHealth = { redis: false, sqlite: false };
let selectedLogType = 'battery';

// Helper Functions
function updateStatusIndicator(elementId, status, activeStates = ['active', 'online', 'healthy'], dangerStates = ['error', 'offline', 'unhealthy']) {
    const element = document.getElementById(elementId);
    if (!element) return;
    element.textContent = status;
    const statusLower = status.toLowerCase();
    if (activeStates.some(state => statusLower.includes(state))) {
        element.className = 'status-indicator active';
    } else if (dangerStates.some(state => statusLower.includes(state))) {
        element.className = 'status-indicator danger';
    } else {
        element.className = 'status-indicator inactive';
    }
}

function formatFileSize(bytes) {
    if (!Number.isFinite(bytes) || bytes <= 0) return '0 Bytes';
    const units = ['Bytes', 'KB', 'MB', 'GB'];
    const index = Math.min(units.length - 1, Math.floor(Math.log(bytes) / Math.log(1024)));
    const value = (bytes / Math.pow(1024, index)).toFixed(2);
    return value + ' ' + units[index];
}

const updateDiskUsageDisplay = (diskUsage, isLoading = false, isError = false) => {
    const progressBar = document.getElementById('disk-progress-bar');
    const progressText = document.getElementById('disk-progress-text');
    const freeValue = document.getElementById('disk-free-value');
    const usedValue = document.getElementById('disk-used-value');
    const totalValue = document.getElementById('disk-total-value');
    const statusBadge = document.getElementById('disk-status-badge');
    
    if (!progressBar || !progressText || !freeValue || !usedValue || !totalValue || !statusBadge) {
        return;
    }
    
    if (isLoading) {
        progressBar.style.width = '0%';
        progressBar.className = 'progress-bar progress-bar-striped progress-bar-animated';
        progressBar.style.background = 'linear-gradient(90deg, #6b7280 0%, #9ca3af 100%)';
        progressText.textContent = 'Loading...';
        freeValue.textContent = '--- GB';
        usedValue.textContent = '--- GB';
        totalValue.textContent = '--- GB';
        statusBadge.className = 'badge badge-info-custom';
        statusBadge.innerHTML = '<i class="fas fa-circle-notch fa-spin me-2"></i>Checking Status...';
        return;
    }
    
    if (isError || !diskUsage || !Number.isFinite(diskUsage.used) || !Number.isFinite(diskUsage.total)) {
        progressBar.style.width = '100%';
        progressBar.className = 'progress-bar';
        progressBar.style.background = 'linear-gradient(90deg, #dc3545 0%, #b91c1c 100%)';
        progressText.textContent = 'Error Loading Disk Data';
        freeValue.textContent = 'Error';
        usedValue.textContent = 'Error';
        totalValue.textContent = 'Error';
        statusBadge.className = 'badge badge-danger-custom';
        statusBadge.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Error';
        return;
    }
    
    const usagePercentage = Math.min(100, Math.max(0, Math.round((diskUsage.used / diskUsage.total) * 100)));
    
    setTimeout(() => {
        progressBar.style.setProperty('--progress-width', usagePercentage + '%');
        progressBar.style.width = usagePercentage + '%';
        progressBar.className = 'progress-bar progress-bar-striped progress-bar-animated-custom';
        
        let gradient = 'linear-gradient(90deg, #10b981 0%, #059669 100%)';
        if (usagePercentage >= 95) {
            gradient = 'linear-gradient(90deg, #dc3545 0%, #b91c1c 100%)';
        } else if (usagePercentage >= 90) {
            gradient = 'linear-gradient(90deg, #dc3545 0%, #b91c1c 100%)';
        } else if (usagePercentage >= 75) {
            gradient = 'linear-gradient(90deg, #f59e0b 0%, #d97706 100%)';
        } else if (usagePercentage >= 50) {
            gradient = 'linear-gradient(90deg, #3b82f6 0%, #1d4ed8 100%)';
        }
        progressBar.style.background = gradient;
        progressText.textContent = usagePercentage + '% Used';
    }, 100);
    
    freeValue.textContent = diskUsage.free + ' ' + diskUsage.unit;
    usedValue.textContent = diskUsage.used + ' ' + diskUsage.unit;
    totalValue.textContent = diskUsage.total + ' ' + diskUsage.unit;
    
    let statusClass = 'badge badge-success-custom';
    let statusText = 'Excellent - Plenty Space';
    let statusIcon = 'fas fa-thumbs-up';
    
    if (usagePercentage >= 95) {
        statusClass = 'badge badge-danger-custom';
        statusText = 'Critical - Almost Full';
        statusIcon = 'fas fa-exclamation-circle';
    } else if (usagePercentage >= 90) {
        statusClass = 'badge badge-danger-custom';
        statusText = 'Warning - Low Space';
        statusIcon = 'fas fa-exclamation-triangle';
    } else if (usagePercentage >= 75) {
        statusClass = 'badge badge-warning-custom';
        statusText = 'Caution - Monitor Space';
        statusIcon = 'fas fa-info-circle';
    } else if (usagePercentage >= 50) {
        statusClass = 'badge badge-info-custom';
        statusText = 'Normal - Good Space';
        statusIcon = 'fas fa-check-circle';
    }
    
    statusBadge.className = statusClass;
    statusBadge.innerHTML = '<i class="' + statusIcon + ' me-2"></i>' + statusText;
};

const showNotification = (message, type = 'info') => {
    if (window.powerDeskApp && window.powerDeskApp.showNotification) {
        window.powerDeskApp.showNotification(message, type);
    } else {
        alert(message);
    }
};

const setButtonLoading = (buttonId, isLoading, loadingLabel) => {
    const button = document.getElementById(buttonId);
    if (!button) return;
    if (isLoading) {
        button.dataset.defaultHtml = button.dataset.defaultHtml || button.innerHTML;
        button.disabled = true;
        button.innerHTML = loadingLabel;
    } else {
        button.disabled = false;
        button.innerHTML = button.dataset.defaultHtml || button.innerHTML;
    }
};

const formatRange = (first, last) => {
    if (!first && !last) return 'No timestamps available';
    if (first && last) return first + ' → ' + last;
    return first || last || 'No timestamps available';
};

const getAuthHeaders = () => {
    const headers = { 'Content-Type': 'application/json' };
    if (AUTH_TOKEN) {
        headers['Authorization'] = 'Bearer ' + AUTH_TOKEN;
    }
    return headers;
};

// API Functions

// Fetch Storage Overview
const fetchStorageOverview = async () => {
    try {
        document.getElementById('redis-storage').textContent = 'Loading...';
        document.getElementById('sqlite-storage').textContent = 'Loading...';
        updateDiskUsageDisplay(null, true);
        
        const response = await fetch(`${API_BASE_URL}/data/overview`, {
            method: 'GET',
            headers: getAuthHeaders()
        });
        
        if (!response.ok) {
            throw new Error('HTTP error! status: ' + response.status);
        }
        
        const payload = await response.json();
        
        if (payload.status_code === 200 && payload.data) {
            updateStorageOverviewUI(payload.data);
        } else {
            throw new Error(payload.message || 'Failed to fetch data overview');
        }
    } catch (error) {
        console.error('Failed to get data overview:', error);
        document.getElementById('redis-storage').textContent = 'Error';
        document.getElementById('sqlite-storage').textContent = 'Error';
        updateDiskUsageDisplay(null, false, true);
    }
};

const updateStorageOverviewUI = (data) => {
    const storageOverview = data.storage_overview || {};
    const redisInfo = storageOverview.redis || {};
    const sqliteInfo = storageOverview.sqlite || {};
    
    const redisLabel = (redisInfo.size !== undefined ? redisInfo.size : '--') + ' ' + (redisInfo.unit || 'MB');
    const sqliteLabel = (sqliteInfo.size !== undefined ? sqliteInfo.size : '--') + ' ' + (sqliteInfo.unit || 'MB');
    
    document.getElementById('redis-storage').textContent = redisLabel;
    document.getElementById('sqlite-storage').textContent = sqliteLabel;
    
    if (storageOverview.disk_usage) {
        updateDiskUsageDisplay(storageOverview.disk_usage);
    }
    
    const lastUpdateLabel = document.getElementById('logs-last-update');
    if (lastUpdateLabel && data.last_update) {
        lastUpdateLabel.textContent = data.last_update;
    }
};

// Initialize Log Type Selector
const initLogTypeSelector = () => {
    const selector = document.getElementById('log-type-select');
    if (!selector) return;
    
    selector.value = selectedLogType;
    selector.addEventListener('change', () => {
        selectedLogType = selector.value;
        refreshLogStats();
        updateAvailabilityBadges();
    });
};

const updateAvailabilityBadges = () => {
    const config = LOG_TYPE_CONFIG[selectedLogType];
    const redisBadge = document.getElementById('redis-availability-badge');
    const sqliteBadge = document.getElementById('sqlite-availability-badge');
    const currentLabel = document.getElementById('current-log-type-label');
    
    if (currentLabel) currentLabel.textContent = config.label;
    
    const setBadge = (badge, isActive, label) => {
        if (!badge) return;
        badge.className = 'badge ' + (isActive ? 'bg-success' : 'bg-secondary') + ' text-white';
        badge.innerHTML = '<i class="fas ' + (isActive ? 'fa-check' : 'fa-ban') + ' me-1"></i>' + label;
    };
    
    setBadge(redisBadge, config.sources.redis, 'Redis');
    setBadge(sqliteBadge, config.sources.sqlite, 'SQLite');
    
    ['download-redis', 'clear-redis'].forEach(id => {
        const btn = document.getElementById(id);
        if (btn) btn.disabled = !config.sources.redis;
    });
    
    ['download-sqlite', 'clear-sqlite'].forEach(id => {
        const btn = document.getElementById(id);
        if (btn) btn.disabled = !config.sources.sqlite;
    });
};

// Fetch Log Source Data
const refreshLogStats = async () => {
    updateAvailabilityBadges();
    await Promise.all(['redis', 'sqlite'].map(source => fetchLogSourceData(source)));
};

const fetchLogSourceData = async (source) => {
    const config = LOG_TYPE_CONFIG[selectedLogType];
    if (!config.sources[source]) {
        setLogSourceUnavailable(source);
        return;
    }
    
    try {
        const response = await fetch(`${API_BASE_URL}/data/logs/${selectedLogType}?source=${source}&limit=1`, {
            method: 'GET',
            headers: getAuthHeaders()
        });
        
        if (!response.ok) {
            throw new Error('HTTP error! status: ' + response.status);
        }
        
        const payload = await response.json();
        
        if (payload.status === 'success') {
            updateLogSourceCard(source, payload);
        } else {
            throw new Error(payload.message || 'Failed to fetch logs');
        }
    } catch (error) {
        console.error('Failed to fetch ' + source + ' logs:', error);
        setLogSourceUnavailable(source, true);
    }
};

const updateLogSourceCard = (source, payload) => {
    const prefix = source === 'redis' ? 'redis' : 'sqlite';
    const countEl = document.getElementById(prefix + '-log-count');
    const rangeEl = document.getElementById(prefix + '-log-range');
    
    const stats = payload.data?.statistics || {};
    const logs = payload.data?.logs || [];
    const totalRecords = payload.page_info?.total_records ?? stats.total_records ?? logs.length ?? 0;
    const firstTimestamp = stats.first_timestamp || (logs.length ? logs[logs.length - 1].timestamp : null);
    const lastTimestamp = stats.last_timestamp || (logs.length ? logs[0].timestamp : null);
    
    if (countEl) countEl.textContent = totalRecords.toLocaleString();
    if (rangeEl) rangeEl.textContent = formatRange(firstTimestamp, lastTimestamp);
    
    const lastUpdateLabel = document.getElementById('logs-last-update');
    if (lastUpdateLabel && payload.timestamp) {
        lastUpdateLabel.textContent = payload.timestamp;
    }
    
    sourceHealth[source] = totalRecords > 0;
    
    if (source === 'redis') {
        updateStatusIndicator('datalog-status', totalRecords > 0 ? 'Active' : 'No Data');
    }
    
    updateDataHealthIndicator();
};

const setLogSourceUnavailable = (source, errored = false) => {
    const prefix = source === 'redis' ? 'redis' : 'sqlite';
    const countEl = document.getElementById(prefix + '-log-count');
    const rangeEl = document.getElementById(prefix + '-log-range');
    
    if (countEl) countEl.textContent = errored ? 'Error' : 'N/A';
    if (rangeEl) rangeEl.textContent = errored ? 'Unable to load data' : 'Not available for this log type';
    
    sourceHealth[source] = false;
    
    if (source === 'redis') {
        updateStatusIndicator('datalog-status', errored ? 'Error' : 'Unavailable');
    }
    
    updateDataHealthIndicator();
};

const updateDataHealthIndicator = () => {
    const config = LOG_TYPE_CONFIG[selectedLogType];
    const availableSources = Object.entries(config.sources).filter(([, available]) => available);
    
    if (!availableSources.length) {
        updateStatusIndicator('data-health', 'Unavailable');
        return;
    }
    
    const anyData = availableSources.some(([source]) => sourceHealth[source]);
    updateStatusIndicator('data-health', anyData ? 'Healthy' : 'No Data');
};

// Download Logs (Multiple Files)
const downloadLogs = async (source) => {
    const config = LOG_TYPE_CONFIG[selectedLogType];
    if (!config.sources[source]) {
        showNotification(source.toUpperCase() + ' source is not available for ' + config.label, 'warning');
        return;
    }
    
    const buttonId = source === 'redis' ? 'download-redis' : 'download-sqlite';
    setButtonLoading(buttonId, true, '<i class="fas fa-spinner fa-spin"></i> Downloading...');
    
    try {
        let offset = 0;
        let fileIndex = 0;
        let hasData = false;
        
        while (true) {
            const response = await fetch(`${API_BASE_URL}/data/logs/${selectedLogType}?source=${source}&limit=${DOWNLOAD_PAGE_SIZE}&offset=${offset}`, {
                method: 'GET',
                headers: getAuthHeaders()
            });
            
            if (!response.ok) {
                throw new Error('HTTP error! status: ' + response.status);
            }
            
            const payload = await response.json();
            
            if (payload.status !== 'success') {
                throw new Error(payload.message || 'Failed to download logs');
            }
            
            const logs = payload.data?.logs || [];
            if (!logs.length) break;
            
            hasData = true;
            
            const fileData = {
                log_type: selectedLogType,
                source,
                site_info: payload.site_info,
                page_info: payload.page_info,
                logs
            };
            
            const blob = new Blob([JSON.stringify(fileData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const anchor = document.createElement('a');
            anchor.href = url;
            anchor.download = `data_logs_${selectedLogType}_${fileIndex}.json`;
            document.body.appendChild(anchor);
            anchor.click();
            URL.revokeObjectURL(url);
            document.body.removeChild(anchor);
            
            fileIndex += 1;
            offset += DOWNLOAD_PAGE_SIZE;
            
            if (!payload.page_info?.has_next) break;
        }
        
        if (!hasData) {
            showNotification('No data available for the selected log type.', 'warning');
        } else {
            showNotification(`Logs downloaded successfully (${fileIndex} file${fileIndex > 1 ? 's' : ''}).`, 'success');
        }
    } catch (error) {
        console.error('Failed to download logs:', error);
        showNotification('Failed to download logs. Please try again.', 'error');
    } finally {
        setButtonLoading(buttonId, false);
    }
};

// Delete Logs
const deleteLogs = async (source) => {
    const config = LOG_TYPE_CONFIG[selectedLogType];
    if (!config.sources[source]) {
        showNotification(source.toUpperCase() + ' source is not available for ' + config.label, 'warning');
        return;
    }
    
    const buttonId = source === 'redis' ? 'clear-redis' : 'clear-sqlite';
    const confirmMessage = `⚠️ WARNING: This will delete all ${source.toUpperCase()} logs for ${config.label}. Continue?`;
    
    if (!confirm(confirmMessage)) return;
    
    setButtonLoading(buttonId, true, '<i class="fas fa-spinner fa-spin"></i> Clearing...');
    
    try {
        const response = await fetch(`${API_BASE_URL}/data/logs/${selectedLogType}?source=${source}&confirm=yes`, {
            method: 'DELETE',
            headers: getAuthHeaders()
        });
        
        if (!response.ok) {
            throw new Error('HTTP error! status: ' + response.status);
        }
        
        const payload = await response.json();
        
        if (payload.status === 'success') {
            showNotification(`${source.toUpperCase()} logs cleared successfully.`, 'success');
            await refreshLogStats();
            await fetchStorageOverview();
        } else {
            throw new Error(payload.message || 'Failed to clear logs');
        }
    } catch (error) {
        console.error('Failed to clear logs:', error);
        showNotification('Failed to clear logs. Please try again.', 'error');
    } finally {
        setButtonLoading(buttonId, false);
    }
};

// Public Functions (called from HTML)
window.downloadRedisData = () => downloadLogs('redis');
window.downloadSqliteData = () => downloadLogs('sqlite');
window.clearRedisData = () => deleteLogs('redis');
window.clearSqliteData = () => deleteLogs('sqlite');

// Initialize on Page Load
document.addEventListener('DOMContentLoaded', () => {
    const diskContainer = document.querySelector('.disk-usage-container');
    if (diskContainer) {
        diskContainer.style.opacity = '0';
        diskContainer.style.transform = 'translateY(20px)';
        diskContainer.style.transition = 'all 0.6s ease';
        
        setTimeout(() => {
            diskContainer.style.opacity = '1';
            diskContainer.style.transform = 'translateY(0)';
        }, 300);
    }
    
    initLogTypeSelector();
    fetchStorageOverview();
    refreshLogStats();
    
    setInterval(() => {
        fetchStorageOverview();
        refreshLogStats();
    }, 60000);
});
</script>
{% endblock scripts %}