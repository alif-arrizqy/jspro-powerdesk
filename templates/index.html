{% extends 'modern-layout.html' %}
{% block breadcrumbs %}Dashboard{% endblock breadcrumbs %}

{% block content %}

<!-- System Status Overview -->
<div class="row mb-4">
    <div class="col-12">
        <div class="modern-card">
            <div class="modern-card-header">
                <h2 class="modern-card-title">
                    <i class="fas fa-server"></i>
                    System Resources & Services
                </h2>
            </div>
            <div class="modern-card-body">
                <div class="row g-3">
                    <!-- CPU Usage -->
                    <div class="col-md-3">
                        <div class="stats-card">
                            <div class="stats-card-header">
                                <h6 class="stats-card-title">CPU Usage</h6>
                                <div class="stats-card-icon bg-primary">
                                    <i class="fas fa-microchip"></i>
                                </div>
                            </div>
                            <h3 class="stats-card-value" id="cpu-usage">Loading...</h3>
                            <p class="stats-card-subtitle">Processor Load</p>
                        </div>
                    </div>
                    <!-- Memory Usage -->
                    <div class="col-md-3">
                        <div class="stats-card">
                            <div class="stats-card-header">
                                <h6 class="stats-card-title">Memory Usage</h6>
                                <div class="stats-card-icon bg-info">
                                    <i class="fas fa-memory"></i>
                                </div>
                            </div>
                            <h3 class="stats-card-value" id="memory-usage">Loading...</h3>
                            <p class="stats-card-subtitle">RAM Consumption</p>
                        </div>
                    </div>
                    <!-- System Temperature -->
                    <div class="col-md-3">
                        <div class="stats-card">
                            <div class="stats-card-header">
                                <h6 class="stats-card-title">Temperature</h6>
                                <div class="stats-card-icon bg-warning">
                                    <i class="fas fa-thermometer-half"></i>
                                </div>
                            </div>
                            <h3 class="stats-card-value" id="system-temp">Loading...</h3>
                            <p class="stats-card-subtitle">System Temperature</p>
                        </div>
                    </div>
                    <!-- Disk Usage -->
                    <div class="col-md-3">
                        <div class="stats-card">
                            <div class="stats-card-header">
                                <h6 class="stats-card-title">Disk Usage</h6>
                                <div class="stats-card-icon bg-success">
                                    <i class="fas fa-hdd"></i>
                                </div>
                            </div>
                            <h3 class="stats-card-value" id="disk-usage">Loading...</h3>
                            <p class="stats-card-subtitle">Storage Space</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Service Status Overview -->
<div class="row mb-4">
    <div class="col-12">
        <div class="modern-card">
            <div class="modern-card-header">
                <h2 class="modern-card-title">
                    <i class="fas fa-cogs"></i>
                    Service Status Overview
                </h2>
            </div>
            <div class="modern-card-body">
                <div class="row g-3">
                    <!-- Redis Service -->
                    <div class="col-md-3">
                        <div class="stats-card">
                            <div class="stats-card-header">
                                <h6 class="stats-card-title">Redis Service</h6>
                                <div class="stats-card-icon bg-danger">
                                    <i class="fas fa-database"></i>
                                </div>
                            </div>
                            <h3 class="stats-card-value">
                                <span class="status-indicator" id="redis-status">Loading...</span>
                            </h3>
                            <p class="stats-card-subtitle">Database Service</p>
                        </div>
                    </div>
                    <!-- SNMP Service -->
                    <div class="col-md-3">
                        <div class="stats-card">
                            <div class="stats-card-header">
                                <h6 class="stats-card-title">SNMP Service</h6>
                                <div class="stats-card-icon bg-primary">
                                    <i class="fas fa-network-wired"></i>
                                </div>
                            </div>
                            <h3 class="stats-card-value">
                                <span class="status-indicator" id="snmp-status">Loading...</span>
                            </h3>
                            <p class="stats-card-subtitle">Network Monitoring</p>
                        </div>
                    </div>
                    <!-- MQTT Service -->
                    <div class="col-md-3">
                        <div class="stats-card">
                            <div class="stats-card-header">
                                <h6 class="stats-card-title">MQTT Service</h6>
                                <div class="stats-card-icon bg-success">
                                    <i class="fas fa-exchange-alt"></i>
                                </div>
                            </div>
                            <h3 class="stats-card-value">
                                <span class="status-indicator" id="mqtt-status">Loading...</span>
                            </h3>
                            <p class="stats-card-subtitle">Message Broker</p>
                        </div>
                    </div>
                    <!-- System Uptime -->
                    <div class="col-md-3">
                        <div class="stats-card">
                            <div class="stats-card-header">
                                <h6 class="stats-card-title">System Uptime</h6>
                                <div class="stats-card-icon bg-info">
                                    <i class="fas fa-clock"></i>
                                </div>
                            </div>
                            <h3 class="stats-card-value" id="system-uptime">Loading...</h3>
                            <p class="stats-card-subtitle">Operational Time</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Device Information -->
<div class="row mb-4">
    <div class="col-12">
        <div class="modern-card">
            <div class="modern-card-header">
                <h2 class="modern-card-title">
                    <i class="fas fa-info-circle"></i>
                    Device Information
                </h2>
            </div>
            <div class="modern-card-body">
                <div class="row g-3">
                    <div class="col-md-3">
                        <div class="stats-card">
                            <div class="stats-card-header">
                                <h6 class="stats-card-title">Battery Type</h6>
                                <div class="stats-card-icon bg-primary">
                                    <i class="fas fa-battery"></i>
                                </div>
                            </div>
                            <h3 class="stats-card-value" id="battery-type">Loading...</h3>
                            <p class="stats-card-subtitle">Battery in Use</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-card">
                            <div class="stats-card-header">
                                <h6 class="stats-card-title">SCC Type</h6>
                                <div class="stats-card-icon bg-primary">
                                    <i class="fas fa-solar-panel"></i>
                                </div>
                            </div>
                            <h3 class="stats-card-value" id="scc-type">Loading...</h3>
                            <p class="stats-card-subtitle">Solar Charge Controller</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-card">
                            <div class="stats-card-header">
                                <h6 class="stats-card-title">SCC IDs</h6>
                                <div class="stats-card-icon bg-warning">
                                    <i class="fas fa-hashtag"></i>
                                </div>
                            </div>
                            <h3 class="stats-card-value" id="scc-ids">Loading...</h3>
                            <p class="stats-card-subtitle">Controller IDs</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-card">
                            <div class="stats-card-header">
                                <h6 class="stats-card-title">Data Logs</h6>
                                <div class="stats-card-icon bg-info">
                                    <i class="fas fa-database"></i>
                                </div>
                            </div>
                            <h3 class="stats-card-value" id="datalog-length">Loading...</h3>
                            <p class="stats-card-subtitle">Total Records</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- SCC Relay Configuration -->
<div class="row mb-4">
    <div class="col-12">
        <div class="modern-card">
            <div class="modern-card-header">
                <h5 class="modern-card-title">
                    <i class="fas fa-chart-bar text-info me-2"></i>
                    SCC Relay Configuration
                </h5>
            </div>
            <div class="modern-card-body">
                <div class="row g-4">
                    <div class="col-lg-3 col-md-6">
                        <div class="stats-card">
                            <div class="stats-card-header">
                                <h6 class="stats-card-title">Vsat Reconnect</h6>
                                <div class="stats-card-icon bg-success">
                                    <i class="fas fa-satellite"></i>
                                </div>
                            </div>
                            <h3 class="stats-card-value">4700</h3>
                            <p class="stats-card-subtitle">
                                <i class="fas fa-arrow-up me-2"></i>
                                Vsat Reconnect (mV)
                            </p>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <div class="stats-card">
                            <div class="stats-card-header">
                                <h6 class="stats-card-title">Vsat Cut Off</h6>
                                <div class="stats-card-icon bg-success">
                                    <i class="fas fa-satellite"></i>
                                </div>
                            </div>
                            <h3 class="stats-card-value">4600</h3>
                            <p class="stats-card-subtitle">
                                <i class="fas fa-arrow-down me-2"></i>
                                Vsat Cut Off (mV)
                            </p>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <div class="stats-card">
                            <div class="stats-card-header">
                                <h6 class="stats-card-title">BTS Reconnect</h6>
                                <div class="stats-card-icon bg-primary">
                                    <i class="fas fa-broadcast-tower"></i>
                                </div>
                            </div>
                            <h3 class="stats-card-value">4900</h3>
                            <p class="stats-card-subtitle">
                                <i class="fas fa-arrow-up me-2"></i>
                                BTS Reconnect (mV)
                            </p>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <div class="stats-card">
                            <div class="stats-card-header">
                                <h6 class="stats-card-title">BTS Cut Off</h6>
                                <div class="stats-card-icon bg-primary">
                                    <i class="fas fa-broadcast-tower"></i>
                                </div>
                            </div>
                            <h3 class="stats-card-value">4800</h3>
                            <p class="stats-card-subtitle">
                                <i class="fas fa-arrow-down me-2"></i>
                                BTS Cut Off (mV)
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- SCC Overview -->
<div class="row mb-4">
    <div class="col-12">
        <div class="modern-card">
            <div class="modern-card-header">
                <h2 class="modern-card-title">
                    <i class="fas fa-solar-panel"></i>
                    Solar Charge Controller Overview
                </h2>
            </div>
            <div class="modern-card-body">
                <div class="row g-4">
                    {% for i in range(1, number_of_scc+1) %}
                    {% if number_of_scc <= 2 %}
                    <div class="col-lg-6">
                    {% elif number_of_scc == 3 %}
                    <div class="col-xl-4 col-lg-6 col-md-12">
                    {% else %}
                    <div class="col-xl-3 col-lg-6 col-md-12">
                    {% endif %}
                        <div class="modern-card">
                            <div class="modern-card-header">
                                <h5 class="modern-card-title">
                                    <i class="fas fa-solar-panel"></i>
                                    SCC {{i}} Status
                                </h5>
                                <div class="d-flex align-items-center flex-wrap">
                                    <i class="fas fa-info-circle text-primary me-2"></i>
                                    <span class="text-muted small" id="scc{{i}}-device-id">SCC ID: Loading...</span>
                                    <span class="text-muted mx-1">|</span>
                                    <i class="fas fa-heartbeat text-danger me-1"></i>
                                    <span class="text-muted small" id="scc{{i}}-counter-heartbeat">Heartbeat: Loading...</span>
                                </div>
                            </div>
                            <div class="modern-card-body">
                                <div class="row g-2">
                                    <div class="col-6">
                                        <div class="stats-card">
                                            <div class="stats-card-header">
                                                <h6 class="stats-card-title small">Status</h6>
                                                <div class="stats-card-icon bg-primary">
                                                    <i class="fas fa-power-off"></i>
                                                </div>
                                            </div>
                                            <h5 class="stats-card-value">
                                                <span class="status-indicator" id="scc{{i}}-status">Loading...</span>
                                            </h5>
                                            <p class="stats-card-subtitle small">SCC {{i}} Status</p>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="stats-card">
                                            <div class="stats-card-header">
                                                <h6 class="stats-card-title small">PV {{i}} Voltage</h6>
                                                <div class="stats-card-icon bg-success">
                                                    <i class="fas fa-sun"></i>
                                                </div>
                                            </div>
                                            <h5 class="stats-card-value" id="pv{{i}}-voltage">Loading...</h5>
                                            <p class="stats-card-subtitle small">Photovoltaic</p>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="stats-card">
                                            <div class="stats-card-header">
                                                <h6 class="stats-card-title small">PV {{i}} Current</h6>
                                                <div class="stats-card-icon bg-info">
                                                    <i class="fas fa-tachometer-alt"></i>
                                                </div>
                                            </div>
                                            <h5 class="stats-card-value" id="pv{{i}}-current">Loading...</h5>
                                            <p class="stats-card-subtitle small">PV Current</p>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="stats-card">
                                            <div class="stats-card-header">
                                                <h6 class="stats-card-title small">Load Voltage</h6>
                                                <div class="stats-card-icon bg-info">
                                                    <i class="fas fa-plug"></i>
                                                </div>
                                            </div>
                                            <h5 class="stats-card-value" id="load{{i}}-voltage-detail">Loading...</h5>
                                            <p class="stats-card-subtitle small">Load Voltage</p>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="stats-card">
                                            <div class="stats-card-header">
                                                <h6 class="stats-card-title small">Load Current</h6>
                                                <div class="stats-card-icon bg-primary">
                                                    <i class="fas fa-arrow-left"></i>
                                                </div>
                                            </div>
                                            <h5 class="stats-card-value" id="load{{i}}-current-detail">Loading...</h5>
                                            <p class="stats-card-subtitle small">Load Current</p>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="stats-card">
                                            <div class="stats-card-header">
                                                <h6 class="stats-card-title small">Load Power</h6>
                                                <div class="stats-card-icon bg-warning">
                                                    <i class="fas fa-bolt"></i>
                                                </div>
                                            </div>
                                            <h5 class="stats-card-value" id="load{{i}}-power-detail">Loading...</h5>
                                            <p class="stats-card-subtitle small">Load Power</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="row mb-4">
    <div class="col-12">
        <div class="modern-card">
            <div class="modern-card-header">
                <h2 class="modern-card-title">
                    <i class="fas fa-tools"></i>
                    Quick Actions
                </h2>
            </div>
            <div class="modern-card-body">
                <div class="row g-3">
                    <div class="col-md-3">
                        <a href="/scc" class="btn btn-modern btn-primary w-100">
                            <i class="fas fa-solar-panel"></i>
                            Monitor SCC
                        </a>
                    </div>
                    {% if username == 'teknisi' %}
                    <div class="col-md-3">
                        <a href="/battery" class="btn btn-modern btn-success w-100">
                            <i class="fas fa-battery-full"></i>
                            Battery Status
                        </a>
                    </div>
                    <div class="col-md-3">
                        <a href="/datalog" class="btn btn-modern btn-info w-100">
                            <i class="fas fa-database"></i>
                            View Data Logs
                        </a>
                    </div>
                    {% endif %}
                    <div class="col-md-3">
                        <a href="/site-information" class="btn btn-modern btn-secondary w-100">
                            <i class="fas fa-info-circle"></i>
                            Site Information
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Enhanced dashboard functionality with modern approach
document.addEventListener('DOMContentLoaded', function() {
    // Initialize system monitoring
    initializeSystemMonitoring();
    
    // Initialize dashboard data updates
    if (window.powerDeskApp) {
        // Override the default data processing for dashboard
        window.powerDeskApp.processData = function(endpoint, data) {
            switch (endpoint) {
                case '/api/device-information':
                    updateDeviceInformation(data);
                    break;
                case '/api/scc-realtime':
                    updateSCCOverview(data);
                    break;
                case '/api/system-resources':
                    updateSystemResources(data);
                    break;
                case '/api/service-status':
                    updateServiceStatus(data);
                    break;
            }
        };
    }
});

// Helper function to update status indicators
function updateStatusIndicator(elementId, status, activeStates = ['active', 'online', 'running'], dangerStates = ['error', 'offline', 'stopped']) {
    const element = document.getElementById(elementId);
    if (element) {
        element.textContent = status;
        
        const statusLower = status.toLowerCase();
        if (activeStates.some(state => statusLower.includes(state))) {
            element.className = 'status-indicator active';
        } else if (dangerStates.some(state => statusLower.includes(state))) {
            element.className = 'status-indicator danger';
        } else {
            element.className = 'status-indicator inactive';
        }
    }
}

// System monitoring initialization
function initializeSystemMonitoring() {
    // Generate dummy system data
    generateDummySystemData();
    
    // Update every 5 seconds
    setInterval(generateDummySystemData, 5000);
}

// Generate dummy system resource data
function generateDummySystemData() {
    // CPU Usage
    const cpuUsage = Math.floor(Math.random() * 80) + 10; // 10-90%
    const cpuElement = document.getElementById('cpu-usage');
    if (cpuElement) {
        cpuElement.textContent = `${cpuUsage}%`;
        cpuElement.className = cpuUsage > 80 ? 'stats-card-value text-danger' : 'stats-card-value';
    }
    
    // Memory Usage
    const memoryUsage = Math.floor(Math.random() * 70) + 20; // 20-90%
    const memoryElement = document.getElementById('memory-usage');
    if (memoryElement) {
        memoryElement.textContent = `${memoryUsage}%`;
        memoryElement.className = memoryUsage > 85 ? 'stats-card-value text-danger' : 'stats-card-value';
    }
    
    // System Temperature
    const systemTemp = (Math.random() * 20 + 35).toFixed(1); // 35-55°C
    const tempElement = document.getElementById('system-temp');
    if (tempElement) {
        tempElement.textContent = `${systemTemp}°C`;
        tempElement.className = systemTemp > 50 ? 'stats-card-value text-danger' : 'stats-card-value';
    }
    
    // System Uptime
    const uptimeHours = Math.floor(Math.random() * 720) + 1; // 1-720 hours
    const days = Math.floor(uptimeHours / 24);
    const hours = uptimeHours % 24;
    const uptimeElement = document.getElementById('system-uptime');
    if (uptimeElement) {
        uptimeElement.textContent = `${days}d ${hours}h`;
    }
    
    // Service Status
    const services = ['redis', 'snmp', 'mqtt'];
    const serviceStates = ['active', 'active', 'active', 'inactive', 'error'];
    
    services.forEach(service => {
        const status = serviceStates[Math.floor(Math.random() * serviceStates.length)];
        updateStatusIndicator(`${service}-status`, status, ['active'], ['inactive', 'error']);
    });
    
    // Generate dummy SCC data
    generateDummySCCData();
}

// Generate dummy SCC data for testing
function generateDummySCCData() {
    const numberOfScc = {{ number_of_scc }};
    
    for (let i = 1; i <= numberOfScc; i++) {
        // SCC Status
        const sccStatuses = ['is running', 'is running', 'is standby', 'modbus error'];
        const sccStatus = sccStatuses[Math.floor(Math.random() * sccStatuses.length)];
        updateStatusIndicator(`scc${i}-status`, sccStatus, ['is running'], ['modbus error', 'unknown status']);
        
        // PV Voltage
        const pvVoltage = (Math.random() * 30 + 15).toFixed(1); // 15-45V
        const pvVoltageElement = document.getElementById(`pv${i}-voltage`);
        if (pvVoltageElement) {
            pvVoltageElement.textContent = `${pvVoltage} V`;
        }
        
        // PV Current
        const pvCurrent = (Math.random() * 8 + 1).toFixed(2); // 1-9A
        const pvCurrentElement = document.getElementById(`pv${i}-current`);
        if (pvCurrentElement) {
            pvCurrentElement.textContent = `${pvCurrent} A`;
        }
        
        // Load Voltage Detail
        const loadVoltage = (Math.random() * 3 + 12).toFixed(1); // 12-15V
        const loadVoltageDetailElement = document.getElementById(`load${i}-voltage-detail`);
        if (loadVoltageDetailElement) {
            loadVoltageDetailElement.textContent = `${loadVoltage} V`;
        }
        
        // Load Current Detail
        const loadCurrent = (Math.random() * 5 + 0.5).toFixed(2); // 0.5-5.5A
        const loadCurrentDetailElement = document.getElementById(`load${i}-current-detail`);
        if (loadCurrentDetailElement) {
            loadCurrentDetailElement.textContent = `${loadCurrent} A`;
        }
        
        // Load Power Detail
        const loadPower = (parseFloat(loadVoltage) * parseFloat(loadCurrent)).toFixed(2);
        const loadPowerDetailElement = document.getElementById(`load${i}-power-detail`);
        if (loadPowerDetailElement) {
            loadPowerDetailElement.textContent = `${loadPower} W`;
        }
        
        // SCC Device ID
        const sccDeviceIdElement = document.getElementById(`scc${i}-device-id`);
        if (sccDeviceIdElement) {
            const deviceId = Math.floor(Math.random() * 200) + 1;
            sccDeviceIdElement.textContent = `SCC ID: ${deviceId}`;
        }
        
        // SCC Heartbeat
        const sccHeartbeatElement = document.getElementById(`scc${i}-counter-heartbeat`);
        if (sccHeartbeatElement) {
            const heartbeat = Math.floor(Math.random() * 1000) + 100;
            sccHeartbeatElement.textContent = `Heartbeat: ${heartbeat}`;
        }
    }
    
    // Generate dummy device information
    generateDummyDeviceInfo();
}

// SCC Device ID mapping
const sccDeviceIds = {
    'scc-srne': ['122', '123', '124'],
    'scc-epveper': ['1', '2']
};

// Update SCC IDs based on type
function updateSCCIds(sccType) {
    const sccIdsElement = document.getElementById('scc-ids');
    if (sccIdsElement && sccDeviceIds[sccType]) {
        sccIdsElement.textContent = sccDeviceIds[sccType].join(', ');
    }
}

// Device Information Update
const updateDeviceInformation = (data) => {
    if (data.code == 500) {
        console.log(`Error: ${data.status}`);
        return;
    }

    // Battery Type
    const batteryTypeElement = document.getElementById('battery-type');
    if (batteryTypeElement && data.data.device_information) {
        batteryTypeElement.textContent = data.data.device_information.battery_type.toUpperCase();
    }
    
    // SCC Type and IDs
    const sccTypeElement = document.getElementById('scc-type');
    if (sccTypeElement && data.data.device_information) {
        const sccType = data.data.device_information.scc_type;
        sccTypeElement.textContent = sccType.toUpperCase();
        
        // Update SCC IDs based on type
        updateSCCIds(sccType);
    }
    
    // Disk Usage
    const diskUsageElement = document.getElementById('disk-usage');
    if (diskUsageElement && data.data.disk_ram) {
        const disk = data.data.disk_ram.disk;
        const usagePercent = ((disk.used / disk.total) * 100).toFixed(1);
        const usageText = `${usagePercent}% (${disk.used}/${disk.total} GB)`;
        diskUsageElement.textContent = usageText;
        
        // Update status indicator
        if (usagePercent > 85) {
            diskUsageElement.classList.add('text-danger');
        } else if (usagePercent > 70) {
            diskUsageElement.classList.add('text-warning');
        } else {
            diskUsageElement.classList.remove('text-danger', 'text-warning');
        }
    }
    
    // Datalog length
    const datalogElement = document.getElementById('datalog-length');
    if (datalogElement && data.data.datalog_length !== undefined) {
        datalogElement.textContent = data.data.datalog_length.toLocaleString();
        
        // Update status indicator
        if (data.data.datalog_length > 1000) {
            datalogElement.classList.add('text-warning');
        } else {
            datalogElement.classList.remove('text-warning');
        }
    }
};

// SCC Overview Update
const updateSCCOverview = (data) => {
    if (data.code == 500) {
        console.log(`Error: ${data.status}`);
        return;
    }

    // Get SCC type to determine device IDs
    const sccType = document.getElementById('scc-type')?.textContent?.toLowerCase() || 'unknown';
    const deviceIds = sccDeviceIds[sccType] || [];

    {% if number_of_scc >= 2 %}
    {% for i in range(1, number_of_scc+1) %}
    // SCC {{i}} Device ID
    const scc{{i}}DeviceIdElement = document.getElementById('scc{{i}}-device-id');
    if (scc{{i}}DeviceIdElement && deviceIds[{{i-1}}]) {
        scc{{i}}DeviceIdElement.textContent = `ID: ${deviceIds[{{i-1}}]}`;
    }

    // SCC {{i}} Status
    const scc{{i}}StatusElement = document.getElementById('scc{{i}}-status');
    if (scc{{i}}StatusElement && data.data.scc{{i}}) {
        const status = data.data.scc{{i}}.load_status;
        scc{{i}}StatusElement.textContent = status;
        
        if (status === 'is standby') {
            scc{{i}}StatusElement.className = 'status-indicator inactive';
        } else if (status === 'modbus error' || status === 'unknown status') {
            scc{{i}}StatusElement.className = 'status-indicator danger';
        } else {
            scc{{i}}StatusElement.className = 'status-indicator active';
        }
    }

    // PV {{i}} Voltage
    const pv{{i}}VoltageElement = document.getElementById('pv{{i}}-voltage');
    if (pv{{i}}VoltageElement && data.data.scc{{i}}) {
        if (data.data.scc{{i}}.pv_voltage === -1) {
            pv{{i}}VoltageElement.textContent = 'N/A';
            pv{{i}}VoltageElement.classList.add('text-muted');
        } else {
            pv{{i}}VoltageElement.textContent = `${data.data.scc{{i}}.pv_voltage} V`;
            pv{{i}}VoltageElement.classList.remove('text-muted');
        }
    }

    // PV {{i}} Current
    const pv{{i}}CurrentElement = document.getElementById('pv{{i}}-current');
    if (pv{{i}}CurrentElement && data.data.scc{{i}}) {
        if (data.data.scc{{i}}.pv_current === -1) {
            pv{{i}}CurrentElement.textContent = 'N/A';
            pv{{i}}CurrentElement.classList.add('text-muted');
        } else {
            pv{{i}}CurrentElement.textContent = `${data.data.scc{{i}}.pv_current} A`;
            pv{{i}}CurrentElement.classList.remove('text-muted');
        }
    }

    // PV {{i}} Power (calculate from voltage and current)
    const pv{{i}}PowerElement = document.getElementById('pv{{i}}-power');
    if (pv{{i}}PowerElement && data.data.scc{{i}}) {
        const voltage = data.data.scc{{i}}.pv_voltage;
        const current = data.data.scc{{i}}.pv_current;
        
        if (voltage === -1 || current === -1) {
            pv{{i}}PowerElement.textContent = 'N/A';
            pv{{i}}PowerElement.classList.add('text-muted');
        } else {
            const power = (voltage * current).toFixed(2);
            pv{{i}}PowerElement.textContent = `${power} W`;
            pv{{i}}PowerElement.classList.remove('text-muted');
        }
    }

    // Load Voltage Detail for SCC Overview
    const load{{i}}VoltageDetailElement = document.getElementById('load{{i}}-voltage-detail');
    if (load{{i}}VoltageDetailElement && data.data.scc{{i}}) {
        if (data.data.scc{{i}}.load_voltage === -1) {
            load{{i}}VoltageDetailElement.textContent = 'N/A';
            load{{i}}VoltageDetailElement.classList.add('text-muted');
        } else {
            load{{i}}VoltageDetailElement.textContent = `${data.data.scc{{i}}.load_voltage} V`;
            load{{i}}VoltageDetailElement.classList.remove('text-muted');
        }
    }

    // Load Current Detail for SCC Overview
    const load{{i}}CurrentDetailElement = document.getElementById('load{{i}}-current-detail');
    if (load{{i}}CurrentDetailElement && data.data.scc{{i}}) {
        if (data.data.scc{{i}}.load_current === -1) {
            load{{i}}CurrentDetailElement.textContent = 'N/A';
            load{{i}}CurrentDetailElement.classList.add('text-muted');
        } else {
            load{{i}}CurrentDetailElement.textContent = `${data.data.scc{{i}}.load_current} A`;
            load{{i}}CurrentDetailElement.classList.remove('text-muted');
        }
    }

    // Load Power Detail for SCC Overview
    const load{{i}}PowerDetailElement = document.getElementById('load{{i}}-power-detail');
    if (load{{i}}PowerDetailElement && data.data.scc{{i}}) {
        const voltage = data.data.scc{{i}}.load_voltage;
        const current = data.data.scc{{i}}.load_current;
        
        if (voltage === -1 || current === -1) {
            load{{i}}PowerDetailElement.textContent = 'N/A';
            load{{i}}PowerDetailElement.classList.add('text-muted');
        } else {
            const power = (voltage * current).toFixed(2);
            load{{i}}PowerDetailElement.textContent = `${power} W`;
            load{{i}}PowerDetailElement.classList.remove('text-muted');
        }
    }

    // SCC {{i}} Counter Heartbeat
    const scc{{i}}HeartbeatElement = document.getElementById('scc{{i}}-counter-heartbeat');
    if (scc{{i}}HeartbeatElement && data.data.scc{{i}}) {
        const heartbeat = data.data.scc{{i}}.counter_heartbeat;
        scc{{i}}HeartbeatElement.textContent = `Heartbeat: ${heartbeat}`;
        
        if (heartbeat == -1) {
            scc{{i}}HeartbeatElement.classList.add('text-danger');
        } else {
            scc{{i}}HeartbeatElement.classList.remove('text-danger');
        }
    }
    {% endfor %}
    {% endif %}
};

// Fallback for manual data fetching if PowerDeskApp is not available
if (!window.powerDeskApp) {
    const fetchData = async (endpoint) => {
        try {
            const response = await fetch(endpoint, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                },
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            return await response.json();
        } catch (error) {
            console.error(`Failed to fetch data from ${endpoint}:`, error);
            return null;
        }
    };

    const updateAllData = async () => {
        const deviceData = await fetchData('/api/device-information/');
        const sccData = await fetchData('/api/realtime/scc/');
        
        if (deviceData) updateDeviceInformation(deviceData);
        if (sccData) updateSCCOverview(sccData);
    };

    // Initial load and periodic updates
    updateAllData();
    setInterval(updateAllData, 5000);
}
</script>
{% endblock %}
