{% extends 'layout.html' %}
{% block breadcrumbs %} Dashboard {% endblock breadcrumbs %}

{% block content %}
<!-- Flash messages -->
{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        <div class="container mt-3">
            {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                    <strong>Info!</strong> {{ message }} <strong>{{ username.capitalize() }}</strong>
                    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
            {% endfor %}
        </div>
    {% endif %}
{% endwith %}
<!-- Device Information -->
<div class="row">
    <div class="col-lg-12">
        <div class="card">
            <div class="card-header card-header-text titel-border">
                <h4 class="card-title left-text">
                    <a href="#" style="text-decoration: none;">
                        <i class="fas fa-info"></i> Device Information
                    </a>
                </h4>
            </div>
            <div class="card-content">
                <div class="row">
                    <div class="col">
                        <div class="shadow card card-stats full-border">
                            <div class="card-content">
                                <p class="category left-text"><strong>SCC Type</strong></p>
                                <h6 class="card-title left-text" id="scc-type" aria-label="SCC Type">Getting Data...</h6>
                            </div>
                        </div>
                    </div>
                    <div class="col">
                        <div class="shadow card card-stats full-border">
                            <div class="card-content">
                                <p class="category left-text"><strong>Disk Usage</strong></p>
                                <h6 class="card-title left-text" id="disk-usage">used: | free: / GB</h6>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!--Power/LVD Overview -->
<div class="row">
    <div class="col-lg-12 col-md-12">
        <div class="card">
            <div class="card-header card-header-text titel-border d-flex justify-content-between align-items-center">
                <h4 class="card-title left-text">
                    <a href="#" style="text-decoration: none;">
                        <i class="fas fa-bolt"></i> Power Overview
                    </a>
                </h4>
                <h4 class="card-title text-right">
                    <a href="#" style="text-decoration: none;">
                        <i class="fas fa-heart"></i>
                        <span id="lvd-counter-heartbeat">Heartbeat: Getting Data...</span>
                    </a>
                </h4>
            </div>
            <div class="card-content">
                <div class="row">
                    <!-- VSAT Lvd -->
                    <div class="col-lg-6">
                        <div class="shadow card card-stats full-border">
                            <div class="card-content">
                                <p class="category left-text"><strong>VSAT LVD</strong></p>
                                <h5 id="vsat-lvd" class="card-title left-text">Getting Data...</h5>
                            </div>
                        </div>
                    </div>

                    <!-- BTS Lvd -->
                    <div class="col-lg-6">
                        <div class="shadow card card-stats full-border">
                            <div class="card-content">
                                <p class="category left-text"><strong>BTS LVD</strong></p>
                                <h5 id="bts-lvd" class="card-title left-text">Getting Data...</h5>
                            </div>
                        </div>
                    </div>

                    <!-- MCB -->
                    {% for i in range(1, 4) %}
                    <div class="col-lg-4">
                        <div class="shadow card card-stats full-border">
                            <div class="card-content">
                                <p class="category left-text"><strong>MCB {{i}} Status</strong></p>
                                <h5 id="mcb{{i}}" class="card-title left-text">Getting Data...</h5>
                            </div>
                        </div>
                    </div>
                    {% endfor %}

                    <!-- System Voltage -->
                    <div class="col">
                        <div class="shadow card card-stats full-border">
                            <div class="card-content">
                                <p class="category left-text"><strong>System Voltage</strong></p>
                                <h5 id="system-voltage" class="card-title left-text">Getting Data...</h5>
                            </div>
                        </div>
                    </div>

                    
                    {% for i in range(1, number_of_scc+1) %}
                    <div class="col">
                        <div class="shadow card card-stats full-border">
                            <div class="card-content">
                                <p class="category left-text"><strong>Load {{i}} Voltage</strong></p>
                                <h5 id="load{{i}}-voltage" class="card-title left-text">Getting Data...</h5>
                            </div>
                        </div>
                    </div>

                    <div class="col">
                        <div class="shadow card card-stats full-border">
                            <div class="card-content">
                                <p class="category left-text"><strong>Load {{i}} Current</strong></p>
                                <h5 id="load{{i}}-current" class="card-title left-text">Getting Data...</h5>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- SCC Overview -->
<div class="row">
    <div class="col-lg-12 col-md-12">
        <div class="card">
            <div class="card-header card-header-text titel-border d-flex justify-content-between align-items-center">
                <h4 class="card-title left-text">
                    <a href="#" style="text-decoration: none;">
                        <i class="fas fa-solar-panel"></i> SCC Overview
                    </a>
                </h4>
            </div>
            <div class="card-content">
                <div class="row">
                    {% for i in range(1, number_of_scc+1) %}
                    <!-- SCC Counter Heartbeat -->
                    <div class="col">
                        <div class="shadow card card-stats full-border">
                            <div class="card-content">
                                <p class="category left-text"><strong>Heartbeat {{i}} </strong></p>
                                <h5 id="scc{{i}}-counter-heartbeat" class="card-title left-text">Getting Data...</h5>
                            </div>
                        </div>
                    </div>
                    
                    <!-- PV Voltage -->
                    <div class="col">
                        <div class="shadow card card-stats full-border">
                            <div class="card-content">
                                <p class="category left-text"><strong>PV{{i}} Voltage</strong></p>
                                <h5 id="pv{{i}}-voltage" class="card-title left-text">Getting Data...</h5>
                            </div>
                        </div>
                    </div>
                    
                    <!-- PV Current -->
                    <div class="col">
                        <div class="shadow card card-stats full-border">
                            <div class="card-content">
                                <p class="category left-text"><strong>PV{{i}} Current</strong></p>
                                <h5 id="pv{{i}}-current" class="card-title left-text">Getting Data...</h5>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block js %}
<script> 
const deviceInformation = async () => {
    try {
        const response = await fetch('/api/device-information/', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            },
        });
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();

        if (data.code == 500) {
            console.log(`Error: ${data.status}`);
            return;
        }

        // SCC Type
        document.getElementById('scc-type').innerHTML = data.data.device_information.scc_type.toUpperCase();
        
        // Disk Usage
        if (data.data.disk_ram.disk.used > 11) {
            document.getElementById('disk-usage').innerHTML = `<mark class="status-danger">used: ${data.data.disk_ram.disk.used} | free: ${data.data.disk_ram.disk.free} / ${data.data.disk_ram.disk.total} GB</mark>`;
        } else {
            document.getElementById('disk-usage').innerHTML = `used: ${data.data.disk_ram.disk.used} | free: ${data.data.disk_ram.disk.free} / ${data.data.disk_ram.disk.total} GB`;
        }
    } catch (error) {
        console.error(`Failed to fetch data: ${error.message}`);
    }
};

const powerOverview = async () => {
    try {
        const response = await fetch('/api/realtime/lvd/', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            },
        });
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();

        if (data.code == 500) {
            console.log(`Error: ${data.status}`);
            return;
        }
    
        // Counter Heartbeat
        if (data.data.counter_heartbeat == -1) {
            document.getElementById('lvd-counter-heartbeat').innerHTML = `<mark class="status-inactive">Heartbeat: ${data.data.counter_heartbeat}</mark>`;
        } else {
            document.getElementById('lvd-counter-heartbeat').innerHTML = `Heartbeat: ${data.data.counter_heartbeat}`;
        }
    
        // System Voltage
        if (data.data.system_voltage === -1){
            document.getElementById('system-voltage').innerHTML = `<mark class="status-inactive">${data.data.system_voltage}</mark>`;
        } else {
            document.getElementById('system-voltage').innerHTML = `${data.data.system_voltage} V`;
        }
    
        // Relay and MCB Status
        // MCB Status
        {% for i in range(1, 4) %}
            if (data.data.relay_status.relay{{i}} === "CLOSED") {
                document.getElementById('mcb{{i}}').innerHTML = `<mark class="status-active">${data.data.relay_status.relay{{i}}}</mark>`;
            } else {
                document.getElementById('mcb{{i}}').innerHTML = `<mark class="status-inactive">${data.data.relay_status.relay{{i}}}</mark>`;
            }
        {% endfor %}
    
        // VSAT LVD
        if (data.data.relay_status.relay1 === "CLOSED") {
            document.getElementById('vsat-lvd').innerHTML = `<mark class="status-active">${data.data.relay_status.relay1}</mark>`;
        } else {
            document.getElementById('vsat-lvd').innerHTML = `<mark class="status-inactive">${data.data.relay_status.relay1}</mark>`;
        }
        
        // BTS LVD
        if (data.data.relay_status.relay2 === "CLOSED") {
            document.getElementById('bts-lvd').innerHTML = `<mark class="status-active">${data.data.relay_status.relay2}</mark>`;
        } else {
            document.getElementById('bts-lvd').innerHTML = `<mark class="status-inactive">${data.data.relay_status.relay2}</mark>`;
        }
    
        // Load Voltage
        {% if number_of_scc == 2 %}
        {% for i in range(1, number_of_scc+1) %}
            if (data.data.lvd.lvd{{i}} === -1){
                document.getElementById('load{{i}}-voltage').innerHTML = `<mark class="status-inactive">${data.data.lvd.lvd{{i}}}</mark>`;
            } else {
                document.getElementById('load{{i}}-voltage').innerHTML = `${data.data.lvd.lvd{{i}}} V`;
            }
    
            if (data.data.load_current.load{{i}}_current === -1){
                document.getElementById('load{{i}}-current').innerHTML = `<mark class="status-inactive">${data.data.load_current.load{{i}}_current}</mark>`;
            } else {
                document.getElementById('load{{i}}-current').innerHTML = `${data.data.load_current.load{{i}}_current} A`;
            }
        {% endfor %}
        {% endif %}
    
        {% if number_of_scc == 3 %}
        {% for i in range(1, number_of_scc+1) %}
            if (data.data.lvd.lvd{{i}} === -1){
                document.getElementById('load{{i}}-voltage').innerHTML = `<mark class="status-inactive">${data.data.lvd.lvd{{i}}}</mark>`;
            } else {
                document.getElementById('load{{i}}-voltage').innerHTML = `${data.data.lvd.lvd{{i}}} V`;
            }
    
            if (data.data.load_current.load{{i}}_current === -1){
                document.getElementById('load{{i}}-current').innerHTML = `<mark class="status-inactive">${data.data.load_current.load{{i}}_current}</mark>`;
            } else {
                document.getElementById('load{{i}}-current').innerHTML = `${data.data.load_current.load{{i}}_current} A`;
            }
        {% endfor %}
        {% endif %}

    } catch {
        console.error(`Failed to fetch data: ${error.message}`);
    }
    
};

const sccOverview = async () => {
    try {
        const response = await fetch('/api/realtime/scc/', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            },
        });
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();

        if (data.code == 500) {
            console.log(`Error: ${data.status}`);
            return;
        }

        // SCC Status
        {% for i in range(1, number_of_scc+1) %}
            // PV Voltage
            if (data.data.scc{{i}}.pv_voltage === -1){
                document.getElementById('pv{{i}}-voltage').innerHTML = `<mark class="status-inactive">${data.data.scc{{i}}.pv_voltage}</mark>`;
            } else {
                document.getElementById('pv{{i}}-voltage').innerHTML = `${data.data.scc{{i}}.pv_voltage} V`;
            }

            // PV Current
            if (data.data.scc{{i}}.pv_current === -1){
                document.getElementById('pv{{i}}-current').innerHTML = `<mark class="status-inactive">${data.data.scc{{i}}.pv_current}</mark>`;
            } else {
                document.getElementById('pv{{i}}-current').innerHTML = `${data.data.scc{{i}}.pv_current} A`;
            }

            // SCC Counter Heartbeat
            if (data.data.scc{{i}}.counter_heartbeat == -1) {
                document.getElementById('scc{{i}}-counter-heartbeat').innerHTML = `<mark class="status-inactive">Heartbeat:${data.data.scc{{i}}.counter_heartbeat}</mark>`;
            } else {
                document.getElementById('scc{{i}}-counter-heartbeat').innerHTML = `Heartbeat: ${data.data.scc{{i}}.counter_heartbeat}`;
            }
        {% endfor %}
    } catch {
        console.error(`Failed to fetch data: ${error.message}`);
    }
}

setInterval(() => {
    deviceInformation();
    powerOverview();
    sccOverview();
}, 1000);
</script>
{% endblock js %}
