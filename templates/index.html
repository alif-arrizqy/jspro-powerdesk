{% extends 'modern-layout.html' %}
{% block breadcrumbs %}Dashboard{% endblock breadcrumbs %}

{% block content %}

<!-- System Status Overview -->
<div class="row mb-4">
    <div class="col-12">
        <div class="modern-card">
            <div class="modern-card-header">
                <h2 class="modern-card-title">
                    <i class="fas fa-server"></i>
                    System Resources & Services
                </h2>
            </div>
            <div class="modern-card-body">
                <div class="row g-3">
                    <!-- CPU Usage -->
                    <div class="col-md-3">
                        <div class="stats-card">
                            <div class="stats-card-header">
                                <h6 class="stats-card-title">CPU Usage</h6>
                                <div class="stats-card-icon bg-primary">
                                    <i class="fas fa-microchip"></i>
                                </div>
                            </div>
                            <h3 class="stats-card-value" id="cpu-usage">Loading...</h3>
                            <p class="stats-card-subtitle">Processor Load</p>
                        </div>
                    </div>
                    <!-- Memory Usage -->
                    <div class="col-md-3">
                        <div class="stats-card">
                            <div class="stats-card-header">
                                <h6 class="stats-card-title">Memory Usage</h6>
                                <div class="stats-card-icon bg-info">
                                    <i class="fas fa-memory"></i>
                                </div>
                            </div>
                            <h3 class="stats-card-value" id="memory-usage">Loading...</h3>
                            <p class="stats-card-subtitle">RAM Consumption</p>
                        </div>
                    </div>
                    <!-- System Temperature -->
                    <div class="col-md-3">
                        <div class="stats-card">
                            <div class="stats-card-header">
                                <h6 class="stats-card-title">Temperature</h6>
                                <div class="stats-card-icon bg-warning">
                                    <i class="fas fa-thermometer-half"></i>
                                </div>
                            </div>
                            <h3 class="stats-card-value" id="system-temp">Loading...</h3>
                            <p class="stats-card-subtitle">System Temperature</p>
                        </div>
                    </div>
                    <!-- Disk Usage -->
                    <div class="col-md-3">
                        <div class="stats-card">
                            <div class="stats-card-header">
                                <h6 class="stats-card-title">Disk Usage</h6>
                                <div class="stats-card-icon bg-success">
                                    <i class="fas fa-hdd"></i>
                                </div>
                            </div>
                            <h3 class="stats-card-value" id="disk-usage">Loading...</h3>
                            <p class="stats-card-subtitle">Storage Space</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Service Status Overview -->
<div class="row mb-4">
    <div class="col-12">
        <div class="modern-card">
            <div class="modern-card-header">
                <h2 class="modern-card-title">
                    <i class="fas fa-cogs"></i>
                    Service Status Overview
                </h2>
            </div>
            <div class="modern-card-body">
                <div class="row g-3">
                    <!-- Redis Service -->
                    <div class="col-md-3">
                        <div class="stats-card">
                            <div class="stats-card-header">
                                <h6 class="stats-card-title">Redis Service</h6>
                                <div class="stats-card-icon bg-danger">
                                    <i class="fas fa-database"></i>
                                </div>
                            </div>
                            <h3 class="stats-card-value">
                                <span class="status-indicator" id="redis-status">Loading...</span>
                            </h3>
                            <p class="stats-card-subtitle">Database Service</p>
                        </div>
                    </div>
                    <!-- SNMP Service -->
                    <div class="col-md-3">
                        <div class="stats-card">
                            <div class="stats-card-header">
                                <h6 class="stats-card-title">SNMP Service</h6>
                                <div class="stats-card-icon bg-primary">
                                    <i class="fas fa-network-wired"></i>
                                </div>
                            </div>
                            <h3 class="stats-card-value">
                                <span class="status-indicator" id="snmp-status">Loading...</span>
                            </h3>
                            <p class="stats-card-subtitle">Network Monitoring</p>
                        </div>
                    </div>
                    <!-- MQTT Service -->
                    <div class="col-md-3">
                        <div class="stats-card">
                            <div class="stats-card-header">
                                <h6 class="stats-card-title">MQTT Service</h6>
                                <div class="stats-card-icon bg-success">
                                    <i class="fas fa-exchange-alt"></i>
                                </div>
                            </div>
                            <h3 class="stats-card-value">
                                <span class="status-indicator" id="mqtt-status">Loading...</span>
                            </h3>
                            <p class="stats-card-subtitle">Message Broker</p>
                        </div>
                    </div>
                    <!-- System Uptime -->
                    <div class="col-md-3">
                        <div class="stats-card">
                            <div class="stats-card-header">
                                <h6 class="stats-card-title">System Uptime</h6>
                                <div class="stats-card-icon bg-info">
                                    <i class="fas fa-clock"></i>
                                </div>
                            </div>
                            <h3 class="stats-card-value" id="system-uptime">Loading...</h3>
                            <p class="stats-card-subtitle">Operational Time</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Device Information -->
<div class="row mb-4">
    <div class="col-12">
        <div class="modern-card">
            <div class="modern-card-header">
                <h2 class="modern-card-title">
                    <i class="fas fa-info-circle"></i>
                    Device Information
                </h2>
            </div>
            <div class="modern-card-body">
                <div class="row g-3">
                    <div class="col-md-3">
                        <div class="stats-card">
                            <div class="stats-card-header">
                                <h6 class="stats-card-title">Battery Type</h6>
                                <div class="stats-card-icon bg-primary">
                                    <i class="fas fa-battery"></i>
                                </div>
                            </div>
                            <h3 class="stats-card-value" id="battery-type">Loading...</h3>
                            <p class="stats-card-subtitle">Battery in Use</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-card">
                            <div class="stats-card-header">
                                <h6 class="stats-card-title">SCC Type</h6>
                                <div class="stats-card-icon bg-primary">
                                    <i class="fas fa-solar-panel"></i>
                                </div>
                            </div>
                            <h3 class="stats-card-value" id="scc-type">Loading...</h3>
                            <p class="stats-card-subtitle">Solar Charge Controller</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-card">
                            <div class="stats-card-header">
                                <h6 class="stats-card-title">SCC IDs</h6>
                                <div class="stats-card-icon bg-warning">
                                    <i class="fas fa-hashtag"></i>
                                </div>
                            </div>
                            <h3 class="stats-card-value" id="scc-ids">Loading...</h3>
                            <p class="stats-card-subtitle">Controller IDs</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-card">
                            <div class="stats-card-header">
                                <h6 class="stats-card-title">Data Logs</h6>
                                <div class="stats-card-icon bg-info">
                                    <i class="fas fa-database"></i>
                                </div>
                            </div>
                            <h3 class="stats-card-value" id="datalog-length">Loading...</h3>
                            <p class="stats-card-subtitle">Total Records</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Power & LVD Status -->
<div class="row mb-4">
    <div class="col-12">
        <div class="modern-card">
            <div class="modern-card-header">
                <h2 class="modern-card-title">
                    <i class="fas fa-bolt"></i>
                    Power System Status
                </h2>
                <div class="d-flex align-items-center">
                    <i class="fas fa-heartbeat text-danger me-2"></i>
                    <span class="text-muted" id="lvd-counter-heartbeat">Heartbeat: Loading...</span>
                </div>
            </div>
            <div class="modern-card-body">
                <div class="row g-3">
                    <!-- LVD Status -->
                    <div class="col-md-6">
                        <div class="stats-card">
                            <div class="stats-card-header">
                                <h6 class="stats-card-title">VSAT LVD</h6>
                                <div class="stats-card-icon bg-primary">
                                    <i class="fas fa-satellite"></i>
                                </div>
                            </div>
                            <h3 class="stats-card-value">
                                <span class="status-indicator" id="vsat-lvd">Loading...</span>
                            </h3>
                            <p class="stats-card-subtitle">VSAT Low Voltage Disconnect</p>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="stats-card">
                            <div class="stats-card-header">
                                <h6 class="stats-card-title">BTS LVD</h6>
                                <div class="stats-card-icon bg-success">
                                    <i class="fas fa-broadcast-tower"></i>
                                </div>
                            </div>
                            <h3 class="stats-card-value">
                                <span class="status-indicator" id="bts-lvd">Loading...</span>
                            </h3>
                            <p class="stats-card-subtitle">BTS Low Voltage Disconnect</p>
                        </div>
                    </div>
                    
                    <!-- MCB Status -->
                    <div class="col-md-4">
                        <div class="stats-card">
                            <div class="stats-card-header">
                                <h6 class="stats-card-title">MCB 1</h6>
                                <div class="stats-card-icon bg-info">
                                    <i class="fas fa-toggle-on"></i>
                                </div>
                            </div>
                            <h3 class="stats-card-value">
                                <span class="status-indicator" id="mcb1">Loading...</span>
                            </h3>
                            <p class="stats-card-subtitle">Circuit Breaker 1</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stats-card">
                            <div class="stats-card-header">
                                <h6 class="stats-card-title">MCB 2</h6>
                                <div class="stats-card-icon bg-warning">
                                    <i class="fas fa-toggle-on"></i>
                                </div>
                            </div>
                            <h3 class="stats-card-value">
                                <span class="status-indicator" id="mcb2">Loading...</span>
                            </h3>
                            <p class="stats-card-subtitle">Circuit Breaker 2</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stats-card">
                            <div class="stats-card-header">
                                <h6 class="stats-card-title">MCB 3</h6>
                                <div class="stats-card-icon bg-danger">
                                    <i class="fas fa-toggle-on"></i>
                                </div>
                            </div>
                            <h3 class="stats-card-value">
                                <span class="status-indicator" id="mcb3">Loading...</span>
                            </h3>
                            <p class="stats-card-subtitle">Circuit Breaker 3</p>
                        </div>
                    </div>
                    
                    <!-- Voltage Readings -->
                    <div class="col-md-4">
                        <div class="stats-card">
                            <div class="stats-card-header">
                                <h6 class="stats-card-title">System Voltage</h6>
                                <div class="stats-card-icon bg-primary">
                                    <i class="fas fa-plug"></i>
                                </div>
                            </div>
                            <h3 class="stats-card-value" id="system-voltage">Loading...</h3>
                            <p class="stats-card-subtitle">Main System Voltage</p>
                        </div>
                    </div>
                    
                    {% for i in range(1, number_of_scc+1) %}
                    <div class="col-md-4">
                        <div class="stats-card">
                            <div class="stats-card-header">
                                <h6 class="stats-card-title">Load {{i}} Voltage</h6>
                                <div class="stats-card-icon bg-success">
                                    <i class="fas fa-bolt"></i>
                                </div>
                            </div>
                            <h3 class="stats-card-value" id="load{{i}}-voltage">Loading...</h3>
                            <p class="stats-card-subtitle">Load {{i}} Voltage Reading</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stats-card">
                            <div class="stats-card-header">
                                <h6 class="stats-card-title">Load {{i}} Current</h6>
                                <div class="stats-card-icon bg-info">
                                    <i class="fas fa-tachometer-alt"></i>
                                </div>
                            </div>
                            <h3 class="stats-card-value" id="load{{i}}-current">Loading...</h3>
                            <p class="stats-card-subtitle">Load {{i}} Current Reading</p>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- SCC Overview -->
<div class="row mb-4">
    <div class="col-12">
        <div class="modern-card">
            <div class="modern-card-header">
                <h2 class="modern-card-title">
                    <i class="fas fa-solar-panel"></i>
                    Solar Charge Controller Overview
                </h2>
            </div>
            <div class="modern-card-body">
                {% if number_of_scc == 2 %}
                <div class="row g-4">
                    {% for i in range(1, number_of_scc+1) %}
                    <div class="col-lg-6">
                        <div class="modern-card">
                            <div class="modern-card-header">
                                <h5 class="modern-card-title">
                                    <i class="fas fa-solar-panel"></i>
                                    SCC {{i}} Status
                                </h5>
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-info-circle text-primary me-2"></i>
                                    <span class="text-muted" id="scc{{i}}-device-id">SCC ID: Loading...</span>
                                    <span class="text-muted mx-2">|</span>
                                    <i class="fas fa-heartbeat text-danger me-2"></i>
                                    <span class="text-muted" id="scc{{i}}-counter-heartbeat">Heartbeat: Loading...</span>
                                </div>
                            </div>
                            <div class="modern-card-body">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <div class="stats-card">
                                            <div class="stats-card-header">
                                                <h6 class="stats-card-title">Status</h6>
                                                <div class="stats-card-icon bg-primary">
                                                    <i class="fas fa-power-off"></i>
                                                </div>
                                            </div>
                                            <h4 class="stats-card-value">
                                                <span class="status-indicator" id="scc{{i}}-status">Loading...</span>
                                            </h4>
                                            <p class="stats-card-subtitle">SCC {{i}} Status</p>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="stats-card">
                                            <div class="stats-card-header">
                                                <h6 class="stats-card-title">PV {{i}} Voltage</h6>
                                                <div class="stats-card-icon bg-success">
                                                    <i class="fas fa-sun"></i>
                                                </div>
                                            </div>
                                            <h4 class="stats-card-value" id="pv{{i}}-voltage">Loading...</h4>
                                            <p class="stats-card-subtitle">Photovoltaic Voltage</p>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="stats-card">
                                            <div class="stats-card-header">
                                                <h6 class="stats-card-title">PV {{i}} Current</h6>
                                                <div class="stats-card-icon bg-info">
                                                    <i class="fas fa-tachometer-alt"></i>
                                                </div>
                                            </div>
                                            <h4 class="stats-card-value" id="pv{{i}}-current">Loading...</h4>
                                            <p class="stats-card-subtitle">Photovoltaic Current</p>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="stats-card">
                                            <div class="stats-card-header">
                                                <h6 class="stats-card-title">Load Voltage</h6>
                                                <div class="stats-card-icon bg-info">
                                                    <i class="fas fa-plug"></i>
                                                </div>
                                            </div>
                                            <h4 class="stats-card-value" id="load{{i}}-voltage">Loading...</h4>
                                            <p class="stats-card-subtitle">Load Voltage</p>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="stats-card">
                                            <div class="stats-card-header">
                                                <h6 class="stats-card-title">Load Current</h6>
                                                <div class="stats-card-icon bg-primary">
                                                    <i class="fas fa-arrow-left"></i>
                                                </div>
                                            </div>
                                            <h4 class="stats-card-value" id="load{{i}}-voltage">Loading...</h4>
                                            <p class="stats-card-subtitle">Load Current</p>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="stats-card">
                                            <div class="stats-card-header">
                                                <h6 class="stats-card-title">Load Power</h6>
                                                <div class="stats-card-icon bg-warning">
                                                    <i class="fas fa-bolt"></i>
                                                </div>
                                            </div>
                                            <h4 class="stats-card-value" id="load{{i}}-voltage">Loading...</h4>
                                            <p class="stats-card-subtitle">Load Power</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <!-- Handle different number of SCCs -->
                <div class="row g-3">
                    {% for i in range(1, number_of_scc+1) %}
                    <div class="col-lg-4">
                        <div class="stats-card">
                            <div class="stats-card-header">
                                <h6 class="stats-card-title">SCC {{i}} Status</h6>
                                <div class="stats-card-icon bg-primary">
                                    <i class="fas fa-power-off"></i>
                                </div>
                            </div>
                            <h3 class="stats-card-value">
                                <span class="status-indicator" id="scc{{i}}-status">Loading...</span>
                            </h3>
                            <p class="stats-card-subtitle">Solar Charge Controller {{i}}</p>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- SCC Relay Configuration -->
<div class="row mb-4">
    <div class="col-12">
        <div class="modern-card">
            <div class="modern-card-header">
                <h5 class="modern-card-title">
                    <i class="fas fa-chart-bar text-info me-2"></i>
                    SCC Relay Configuration
                </h5>
            </div>
            <div class="modern-card-body">
                <div class="row g-4">
                    <div class="col-lg-3 col-md-6">
                        <div class="stats-card">
                            <div class="stats-card-header">
                                <h6 class="stats-card-title">Vsat Reconnect</h6>
                                <div class="stats-card-icon bg-success">
                                    <i class="fas fa-satellite"></i>
                                </div>
                            </div>
                            <h3 class="stats-card-value">4700</h3>
                            <p class="stats-card-subtitle">
                                <i class="fas fa-arrow-up me-2"></i>
                                Vsat Reconnect (mV)
                            </p>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <div class="stats-card">
                            <div class="stats-card-header">
                                <h6 class="stats-card-title">Vsat Cut Off</h6>
                                <div class="stats-card-icon bg-success">
                                    <i class="fas fa-satellite"></i>
                                </div>
                            </div>
                            <h3 class="stats-card-value">4600</h3>
                            <p class="stats-card-subtitle">
                                <i class="fas fa-arrow-down me-2"></i>
                                Vsat Cut Off (mV)
                            </p>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <div class="stats-card">
                            <div class="stats-card-header">
                                <h6 class="stats-card-title">BTS Reconnect</h6>
                                <div class="stats-card-icon bg-primary">
                                    <i class="fas fa-broadcast-tower"></i>
                                </div>
                            </div>
                            <h3 class="stats-card-value">4900</h3>
                            <p class="stats-card-subtitle">
                                <i class="fas fa-arrow-up me-2"></i>
                                BTS Reconnect (mV)
                            </p>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <div class="stats-card">
                            <div class="stats-card-header">
                                <h6 class="stats-card-title">BTS Cut Off</h6>
                                <div class="stats-card-icon bg-primary">
                                    <i class="fas fa-broadcast-tower"></i>
                                </div>
                            </div>
                            <h3 class="stats-card-value">4800</h3>
                            <p class="stats-card-subtitle">
                                <i class="fas fa-arrow-down me-2"></i>
                                BTS Cut Off (mV)
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="row">
    <div class="col-12">
        <div class="modern-card">
            <div class="modern-card-header">
                <h2 class="modern-card-title">
                    <i class="fas fa-tools"></i>
                    Quick Actions
                </h2>
            </div>
            <div class="modern-card-body">
                <div class="row g-3">
                    <div class="col-md-3">
                        <a href="/scc" class="btn btn-modern btn-primary w-100">
                            <i class="fas fa-solar-panel"></i>
                            Monitor SCC
                        </a>
                    </div>
                    {% if username == 'teknisi' %}
                    <div class="col-md-3">
                        <a href="/battery" class="btn btn-modern btn-success w-100">
                            <i class="fas fa-battery-full"></i>
                            Battery Status
                        </a>
                    </div>
                    <div class="col-md-3">
                        <a href="/datalog" class="btn btn-modern btn-info w-100">
                            <i class="fas fa-database"></i>
                            View Data Logs
                        </a>
                    </div>
                    {% endif %}
                    <div class="col-md-3">
                        <a href="/site-information" class="btn btn-modern btn-secondary w-100">
                            <i class="fas fa-info-circle"></i>
                            Site Information
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// Enhanced dashboard functionality with modern approach
document.addEventListener('DOMContentLoaded', function() {
    // Initialize system monitoring
    initializeSystemMonitoring();
    
    // Initialize dashboard data updates
    if (window.powerDeskApp) {
        // Override the default data processing for dashboard
        window.powerDeskApp.processData = function(endpoint, data) {
            switch (endpoint) {
                case '/api/device-information':
                    updateDeviceInformation(data);
                    break;
                case '/api/lvd-realtime':
                    updatePowerOverview(data);
                    break;
                case '/api/scc-realtime':
                    updateSCCOverview(data);
                    break;
                case '/api/system-resources':
                    updateSystemResources(data);
                    break;
                case '/api/service-status':
                    updateServiceStatus(data);
                    break;
            }
        };
    }
});

// Helper function to update status indicators
function updateStatusIndicator(elementId, status, activeStates = ['active', 'online', 'running'], dangerStates = ['error', 'offline', 'stopped']) {
    const element = document.getElementById(elementId);
    if (element) {
        element.textContent = status;
        
        const statusLower = status.toLowerCase();
        if (activeStates.some(state => statusLower.includes(state))) {
            element.className = 'status-indicator active';
        } else if (dangerStates.some(state => statusLower.includes(state))) {
            element.className = 'status-indicator danger';
        } else {
            element.className = 'status-indicator inactive';
        }
    }
}

// System monitoring initialization
function initializeSystemMonitoring() {
    // Generate dummy system data
    generateDummySystemData();
    
    // Update every 5 seconds
    setInterval(generateDummySystemData, 5000);
}

// Generate dummy system resource data
function generateDummySystemData() {
    // CPU Usage
    const cpuUsage = Math.floor(Math.random() * 80) + 10; // 10-90%
    const cpuElement = document.getElementById('cpu-usage');
    if (cpuElement) {
        cpuElement.textContent = `${cpuUsage}%`;
        cpuElement.className = cpuUsage > 80 ? 'stats-card-value text-danger' : 'stats-card-value';
    }
    
    // Memory Usage
    const memoryUsage = Math.floor(Math.random() * 70) + 20; // 20-90%
    const memoryElement = document.getElementById('memory-usage');
    if (memoryElement) {
        memoryElement.textContent = `${memoryUsage}%`;
        memoryElement.className = memoryUsage > 85 ? 'stats-card-value text-danger' : 'stats-card-value';
    }
    
    // System Temperature
    const systemTemp = (Math.random() * 20 + 35).toFixed(1); // 35-55°C
    const tempElement = document.getElementById('system-temp');
    if (tempElement) {
        tempElement.textContent = `${systemTemp}°C`;
        tempElement.className = systemTemp > 50 ? 'stats-card-value text-danger' : 'stats-card-value';
    }
    
    // System Uptime
    const uptimeHours = Math.floor(Math.random() * 720) + 1; // 1-720 hours
    const days = Math.floor(uptimeHours / 24);
    const hours = uptimeHours % 24;
    const uptimeElement = document.getElementById('system-uptime');
    if (uptimeElement) {
        uptimeElement.textContent = `${days}d ${hours}h`;
    }
    
    // Service Status
    const services = ['redis', 'snmp', 'mqtt'];
    const serviceStates = ['active', 'active', 'active', 'inactive', 'error'];
    
    services.forEach(service => {
        const status = serviceStates[Math.floor(Math.random() * serviceStates.length)];
        updateStatusIndicator(`${service}-status`, status, ['active'], ['inactive', 'error']);
    });
}

// SCC Device ID mapping
const sccDeviceIds = {
    'scc-srne': ['122', '123', '124'],
    'scc-epveper': ['1', '2']
};

// Update SCC IDs based on type
function updateSCCIds(sccType) {
    const sccIdsElement = document.getElementById('scc-ids');
    if (sccIdsElement && sccDeviceIds[sccType]) {
        sccIdsElement.textContent = sccDeviceIds[sccType].join(', ');
    }
}

// Device Information Update
const updateDeviceInformation = (data) => {
    if (data.code == 500) {
        console.log(`Error: ${data.status}`);
        return;
    }

    // Battery Type
    const batteryTypeElement = document.getElementById('battery-type');
    if (batteryTypeElement && data.data.device_information) {
        batteryTypeElement.textContent = data.data.device_information.battery_type.toUpperCase();
    }
    
    // SCC Type and IDs
    const sccTypeElement = document.getElementById('scc-type');
    if (sccTypeElement && data.data.device_information) {
        const sccType = data.data.device_information.scc_type;
        sccTypeElement.textContent = sccType.toUpperCase();
        
        // Update SCC IDs based on type
        updateSCCIds(sccType);
    }
    
    // Disk Usage
    const diskUsageElement = document.getElementById('disk-usage');
    if (diskUsageElement && data.data.disk_ram) {
        const disk = data.data.disk_ram.disk;
        const usagePercent = ((disk.used / disk.total) * 100).toFixed(1);
        const usageText = `${usagePercent}% (${disk.used}/${disk.total} GB)`;
        diskUsageElement.textContent = usageText;
        
        // Update status indicator
        if (usagePercent > 85) {
            diskUsageElement.classList.add('text-danger');
        } else if (usagePercent > 70) {
            diskUsageElement.classList.add('text-warning');
        } else {
            diskUsageElement.classList.remove('text-danger', 'text-warning');
        }
    }
    
    // Datalog length
    const datalogElement = document.getElementById('datalog-length');
    if (datalogElement && data.data.datalog_length !== undefined) {
        datalogElement.textContent = data.data.datalog_length.toLocaleString();
        
        // Update status indicator
        if (data.data.datalog_length > 1000) {
            datalogElement.classList.add('text-warning');
        } else {
            datalogElement.classList.remove('text-warning');
        }
    }
};

// Power Overview Update
const updatePowerOverview = (data) => {
    if (data.code == 500) {
        console.log(`Error: ${data.status}`);
        return;
    }

    // Counter Heartbeat
    const heartbeatElement = document.getElementById('lvd-counter-heartbeat');
    if (heartbeatElement) {
        const heartbeatText = `Heartbeat: ${data.data.counter_heartbeat}`;
        heartbeatElement.textContent = heartbeatText;
        
        if (data.data.counter_heartbeat == -1) {
            heartbeatElement.classList.add('text-danger');
        } else {
            heartbeatElement.classList.remove('text-danger');
        }
    }

    // System Voltage
    const systemVoltageElement = document.getElementById('system-voltage');
    if (systemVoltageElement) {
        if (data.data.system_voltage === -1) {
            systemVoltageElement.textContent = 'N/A';
            systemVoltageElement.classList.add('text-muted');
        } else {
            systemVoltageElement.textContent = `${data.data.system_voltage} V`;
            systemVoltageElement.classList.remove('text-muted');
        }
    }

    // MCB Status
    {% for i in range(1, 4) %}
    const mcb{{i}}Element = document.getElementById('mcb{{i}}');
    if (mcb{{i}}Element && data.data.relay_status) {
        const status = data.data.relay_status.relay{{i}};
        const statusSpan = mcb{{i}}Element.querySelector('.status-indicator') || mcb{{i}}Element;
        statusSpan.textContent = status;
        
        if (status === "CLOSED") {
            statusSpan.className = 'status-indicator active';
        } else {
            statusSpan.className = 'status-indicator inactive';
        }
    }
    {% endfor %}

    // VSAT LVD
    const vsatLvdElement = document.getElementById('vsat-lvd');
    if (vsatLvdElement && data.data.relay_status) {
        const status = data.data.relay_status.relay1;
        vsatLvdElement.textContent = status;
        
        if (status === "CLOSED") {
            vsatLvdElement.className = 'status-indicator active';
        } else {
            vsatLvdElement.className = 'status-indicator inactive';
        }
    }
    
    // BTS LVD
    const btsLvdElement = document.getElementById('bts-lvd');
    if (btsLvdElement && data.data.relay_status) {
        const status = data.data.relay_status.relay2;
        btsLvdElement.textContent = status;
        
        if (status === "CLOSED") {
            btsLvdElement.className = 'status-indicator active';
        } else {
            btsLvdElement.className = 'status-indicator inactive';
        }
    }

    // Load Voltage and Current
    {% if number_of_scc >= 2 %}
    {% for i in range(1, number_of_scc+1) %}
    const load{{i}}VoltageElement = document.getElementById('load{{i}}-voltage');
    if (load{{i}}VoltageElement && data.data.lvd) {
        if (data.data.lvd.lvd{{i}} === -1) {
            load{{i}}VoltageElement.textContent = 'N/A';
            load{{i}}VoltageElement.classList.add('text-muted');
        } else {
            load{{i}}VoltageElement.textContent = `${data.data.lvd.lvd{{i}}} V`;
            load{{i}}VoltageElement.classList.remove('text-muted');
        }
    }

    const load{{i}}CurrentElement = document.getElementById('load{{i}}-current');
    if (load{{i}}CurrentElement && data.data.load_current) {
        if (data.data.load_current.load{{i}}_current === -1) {
            load{{i}}CurrentElement.textContent = 'N/A';
            load{{i}}CurrentElement.classList.add('text-muted');
        } else {
            load{{i}}CurrentElement.textContent = `${data.data.load_current.load{{i}}_current} A`;
            load{{i}}CurrentElement.classList.remove('text-muted');
        }
    }
    {% endfor %}
    {% endif %}
};

// SCC Overview Update
const updateSCCOverview = (data) => {
    if (data.code == 500) {
        console.log(`Error: ${data.status}`);
        return;
    }

    // Get SCC type to determine device IDs
    const sccType = document.getElementById('scc-type')?.textContent?.toLowerCase() || 'unknown';
    const deviceIds = sccDeviceIds[sccType] || [];

    {% if number_of_scc >= 2 %}
    {% for i in range(1, number_of_scc+1) %}
    // SCC {{i}} Device ID
    const scc{{i}}DeviceIdElement = document.getElementById('scc{{i}}-device-id');
    if (scc{{i}}DeviceIdElement && deviceIds[{{i-1}}]) {
        scc{{i}}DeviceIdElement.textContent = `ID: ${deviceIds[{{i-1}}]}`;
    }

    // SCC {{i}} Status
    const scc{{i}}StatusElement = document.getElementById('scc{{i}}-status');
    if (scc{{i}}StatusElement && data.data.scc{{i}}) {
        const status = data.data.scc{{i}}.load_status;
        scc{{i}}StatusElement.textContent = status;
        
        if (status === 'is standby') {
            scc{{i}}StatusElement.className = 'status-indicator inactive';
        } else if (status === 'modbus error' || status === 'unknown status') {
            scc{{i}}StatusElement.className = 'status-indicator danger';
        } else {
            scc{{i}}StatusElement.className = 'status-indicator active';
        }
    }

    // PV {{i}} Voltage
    const pv{{i}}VoltageElement = document.getElementById('pv{{i}}-voltage');
    if (pv{{i}}VoltageElement && data.data.scc{{i}}) {
        if (data.data.scc{{i}}.pv_voltage === -1) {
            pv{{i}}VoltageElement.textContent = 'N/A';
            pv{{i}}VoltageElement.classList.add('text-muted');
        } else {
            pv{{i}}VoltageElement.textContent = `${data.data.scc{{i}}.pv_voltage} V`;
            pv{{i}}VoltageElement.classList.remove('text-muted');
        }
    }

    // PV {{i}} Current
    const pv{{i}}CurrentElement = document.getElementById('pv{{i}}-current');
    if (pv{{i}}CurrentElement && data.data.scc{{i}}) {
        if (data.data.scc{{i}}.pv_current === -1) {
            pv{{i}}CurrentElement.textContent = 'N/A';
            pv{{i}}CurrentElement.classList.add('text-muted');
        } else {
            pv{{i}}CurrentElement.textContent = `${data.data.scc{{i}}.pv_current} A`;
            pv{{i}}CurrentElement.classList.remove('text-muted');
        }
    }

    // PV {{i}} Power (calculate from voltage and current)
    const pv{{i}}PowerElement = document.getElementById('pv{{i}}-power');
    if (pv{{i}}PowerElement && data.data.scc{{i}}) {
        const voltage = data.data.scc{{i}}.pv_voltage;
        const current = data.data.scc{{i}}.pv_current;
        
        if (voltage === -1 || current === -1) {
            pv{{i}}PowerElement.textContent = 'N/A';
            pv{{i}}PowerElement.classList.add('text-muted');
        } else {
            const power = (voltage * current).toFixed(2);
            pv{{i}}PowerElement.textContent = `${power} W`;
            pv{{i}}PowerElement.classList.remove('text-muted');
        }
    }

    // SCC {{i}} Counter Heartbeat
    const scc{{i}}HeartbeatElement = document.getElementById('scc{{i}}-counter-heartbeat');
    if (scc{{i}}HeartbeatElement && data.data.scc{{i}}) {
        const heartbeat = data.data.scc{{i}}.counter_heartbeat;
        scc{{i}}HeartbeatElement.textContent = `Heartbeat: ${heartbeat}`;
        
        if (heartbeat == -1) {
            scc{{i}}HeartbeatElement.classList.add('text-danger');
        } else {
            scc{{i}}HeartbeatElement.classList.remove('text-danger');
        }
    }
    {% endfor %}
    {% endif %}
};

// Fallback for manual data fetching if PowerDeskApp is not available
if (!window.powerDeskApp) {
    const fetchData = async (endpoint) => {
        try {
            const response = await fetch(endpoint, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                },
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            return await response.json();
        } catch (error) {
            console.error(`Failed to fetch data from ${endpoint}:`, error);
            return null;
        }
    };

    const updateAllData = async () => {
        const deviceData = await fetchData('/api/device-information/');
        const lvdData = await fetchData('/api/realtime/lvd/');
        const sccData = await fetchData('/api/realtime/scc/');
        
        if (deviceData) updateDeviceInformation(deviceData);
        if (lvdData) updatePowerOverview(lvdData);
        if (sccData) updateSCCOverview(sccData);
    };

    // Initial load and periodic updates
    updateAllData();
    setInterval(updateAllData, 5000);
}
</script>
{% endblock %}
