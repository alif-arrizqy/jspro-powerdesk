{% extends 'modern-layout.html' %}
{% block breadcrumbs %}Dashboard{% endblock breadcrumbs %}

{% block content %}

<!-- System Status Overview -->
<div class="row mb-4">
    <div class="col-12">
        <div class="modern-card">
            <div class="modern-card-header">
                <h2 class="modern-card-title">
                    <i class="fas fa-server"></i>
                    System Resources & Services
                </h2>
            </div>
            <div class="modern-card-body">
                <div class="row g-3">
                    <!-- CPU Usage -->
                    <div class="col-md-3">
                        <div class="stats-card">
                            <div class="stats-card-header">
                                <h6 class="stats-card-title">CPU Usage</h6>
                                <div class="stats-card-icon bg-primary">
                                    <i class="fas fa-microchip"></i>
                                </div>
                            </div>
                            <h3 class="stats-card-value" id="cpu-usage">Loading...</h3>
                            <p class="stats-card-subtitle">Processor Load</p>
                        </div>
                    </div>
                    <!-- Memory Usage -->
                    <div class="col-md-3">
                        <div class="stats-card">
                            <div class="stats-card-header">
                                <h6 class="stats-card-title">Memory Usage</h6>
                                <div class="stats-card-icon bg-info">
                                    <i class="fas fa-memory"></i>
                                </div>
                            </div>
                            <h3 class="stats-card-value" id="memory-usage">Loading...</h3>
                            <p class="stats-card-subtitle">RAM Consumption</p>
                        </div>
                    </div>
                    <!-- System Temperature -->
                    <div class="col-md-3">
                        <div class="stats-card">
                            <div class="stats-card-header">
                                <h6 class="stats-card-title">Temperature</h6>
                                <div class="stats-card-icon bg-warning">
                                    <i class="fas fa-thermometer-half"></i>
                                </div>
                            </div>
                            <h3 class="stats-card-value" id="system-temp">Loading...</h3>
                            <p class="stats-card-subtitle">System Temperature</p>
                        </div>
                    </div>
                    <!-- Disk Usage -->
                    <div class="col-md-3">
                        <div class="stats-card">
                            <div class="stats-card-header">
                                <h6 class="stats-card-title">Disk Usage</h6>
                                <div class="stats-card-icon bg-success">
                                    <i class="fas fa-hdd"></i>
                                </div>
                            </div>
                            <h3 class="stats-card-value" id="disk-usage-percentage">Loading...</h3>
                            <p class="stats-card-subtitle">Storage Space</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Device Information -->
<div class="row mb-4">
    <div class="col-12">
        <div class="modern-card">
            <div class="modern-card-header">
                <h2 class="modern-card-title">
                    <i class="fas fa-info-circle"></i>
                    Device Information
                </h2>
            </div>
            <div class="modern-card-body">
                <div class="row g-3">
                    <div class="col-md-3">
                        <div class="stats-card">
                            <div class="stats-card-header">
                                <h6 class="stats-card-title">Battery Type</h6>
                                <div class="stats-card-icon bg-primary">
                                    <i class="fas fa-battery"></i>
                                </div>
                            </div>
                            <h3 class="stats-card-value" id="battery-type">Loading...</h3>
                            <p class="stats-card-subtitle">Battery in Use</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-card">
                            <div class="stats-card-header">
                                <h6 class="stats-card-title">SCC Type</h6>
                                <div class="stats-card-icon bg-primary">
                                    <i class="fas fa-solar-panel"></i>
                                </div>
                            </div>
                            <h3 class="stats-card-value" id="scc-type">Loading...</h3>
                            <p class="stats-card-subtitle">Solar Charge Controller</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-card">
                            <div class="stats-card-header">
                                <h6 class="stats-card-title">SCC IDs</h6>
                                <div class="stats-card-icon bg-warning">
                                    <i class="fas fa-hashtag"></i>
                                </div>
                            </div>
                            <h3 class="stats-card-value" id="scc-ids">Loading...</h3>
                            <p class="stats-card-subtitle">Controller IDs</p>
                        </div>
                    </div>
                    <!-- System Uptime -->
                    <div class="col-md-3">
                        <div class="stats-card">
                            <div class="stats-card-header">
                                <h6 class="stats-card-title">System Uptime</h6>
                                <div class="stats-card-icon bg-info">
                                    <i class="fas fa-clock"></i>
                                </div>
                            </div>
                            <h3 class="stats-card-value" id="system-uptime">Loading...</h3>
                            <p class="stats-card-subtitle">Operational Time</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Battery Overview -->
<div class="row mb-4">
    <div class="col-12">
        <div class="modern-card">
            <div class="modern-card-header">
                <h2 class="modern-card-title">
                    <i class="fas fa-battery"></i>
                    Battery Overview
                </h2>
            </div>
            <div class="modern-card-body">
                <div class="row g-3">
                    <!-- Battery Voltage Card -->
                    <div class="col-md-3">
                        <div class="stats-card">
                            <div class="stats-card-header">
                                <h6 class="stats-card-title">Battery Voltage</h6>
                                <div class="stats-card-icon bg-success">
                                    <i class="fas fa-battery-full"></i>
                                </div>
                            </div>
                            <h3 class="stats-card-value" id="battery-voltage">Loading...</h3>
                            <p class="stats-card-subtitle">Total Pack Voltage</p>
                        </div>
                    </div>

                    <!-- Battery Pack Buttons -->
                    <div class="col-md-9">
                        <div class="d-flex flex-wrap gap-3 justify-content-start">
                            {% for i in range(1, number_of_battery+1) %}
                            <button class="btn btn-modern btn-secondary pack-selector btn-display" id="pack{{i}}-status">
                                <i class="fas fa-battery-full"></i>
                                Pack {{i}}
                            </button>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- SCC Relay Configuration -->
<div class="row mb-4">
    <div class="col-12">
        <div class="modern-card">
            <div class="modern-card-header">
                <h5 class="modern-card-title">
                    <i class="fas fa-chart-bar"></i>
                    SCC Relay Configuration
                </h5>
            </div>
            <div class="modern-card-body">
                <div class="row g-4">
                    <div class="col-lg-3 col-md-6">
                        <div class="stats-card">
                            <div class="stats-card-header">
                                <h6 class="stats-card-title">Vsat Reconnect</h6>
                                <div class="stats-card-icon bg-success">
                                    <i class="fas fa-satellite"></i>
                                </div>
                            </div>
                            <h3 class="stats-card-value" id="vsat-reconnect">Loading...</h3>
                            <p class="stats-card-subtitle">
                                <i class="fas fa-arrow-up me-2"></i>
                                Vsat Reconnect (mV)
                            </p>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <div class="stats-card">
                            <div class="stats-card-header">
                                <h6 class="stats-card-title">Vsat Cut Off</h6>
                                <div class="stats-card-icon bg-success">
                                    <i class="fas fa-satellite"></i>
                                </div>
                            </div>
                            <h3 class="stats-card-value" id="vsat-cutoff">Loading...</h3>
                            <p class="stats-card-subtitle">
                                <i class="fas fa-arrow-down me-2"></i>
                                Vsat Cut Off (mV)
                            </p>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <div class="stats-card">
                            <div class="stats-card-header">
                                <h6 class="stats-card-title">BTS Reconnect</h6>
                                <div class="stats-card-icon bg-primary">
                                    <i class="fas fa-broadcast-tower"></i>
                                </div>
                            </div>
                            <h3 class="stats-card-value" id="bts-reconnect">Loading...</h3>
                            <p class="stats-card-subtitle">
                                <i class="fas fa-arrow-up me-2"></i>
                                BTS Reconnect (mV)
                            </p>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <div class="stats-card">
                            <div class="stats-card-header">
                                <h6 class="stats-card-title">BTS Cut Off</h6>
                                <div class="stats-card-icon bg-primary">
                                    <i class="fas fa-broadcast-tower"></i>
                                </div>
                            </div>
                            <h3 class="stats-card-value" id="bts-cutoff">Loading...</h3>
                            <p class="stats-card-subtitle">
                                <i class="fas fa-arrow-down me-2"></i>
                                BTS Cut Off (mV)
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- SCC Overview -->
<div class="row mb-4">
    <div class="col-12">
        <div class="modern-card">
            <div class="modern-card-header">
                <h2 class="modern-card-title">
                    <i class="fas fa-solar-panel"></i>
                    Solar Charge Controller Overview
                </h2>
            </div>
            <div class="modern-card-body">
                <div class="row g-4">
                    {% for i in range(1, number_of_scc+1) %}
                    {% if number_of_scc <= 2 %}
                    <div class="col-lg-6">
                    {% elif number_of_scc == 3 %}
                    <div class="col-xl-4 col-lg-6 col-md-12">
                    {% else %}
                    <div class="col-xl-3 col-lg-6 col-md-12">
                    {% endif %}
                        <div class="modern-card">
                            <div class="modern-card-header">
                                <h5 class="modern-card-title">
                                    <i class="fas fa-solar-panel"></i>
                                    SCC {{i}} Status
                                </h5>
                                <div class="d-flex align-items-center flex-wrap">
                                    <i class="fas fa-info-circle text-primary me-2"></i>
                                    <span class="text-muted small" id="scc{{i}}-id">SCC ID: Loading...</span>
                                    <span class="text-muted mx-1">|</span>
                                    <i class="fas fa-heartbeat text-danger me-1"></i>
                                    <span class="text-muted small" id="scc{{i}}-counter-heartbeat">Heartbeat: Loading...</span>
                                    <span class="text-muted mx-1">|</span>
                                    <i class="fas fa-clock text-info me-1"></i>
                                    <span class="text-muted small" id="last-update-{{i}}">Last Update: Loading...</span>
                                </div>
                            </div>
                            <div class="modern-card-body">
                                <div class="row g-2">
                                    <div class="col-6">
                                        <div class="stats-card">
                                            <div class="stats-card-header">
                                                <h6 class="stats-card-title small">Status</h6>
                                                <div class="stats-card-icon bg-primary">
                                                    <i class="fas fa-power-off"></i>
                                                </div>
                                            </div>
                                            <h5 class="stats-card-value">
                                                <span class="status-indicator" id="scc{{i}}-status">Loading...</span>
                                            </h5>
                                            <p class="stats-card-subtitle small">SCC {{i}} Status</p>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="stats-card">
                                            <div class="stats-card-header">
                                                <h6 class="stats-card-title small">PV {{i}} Voltage</h6>
                                                <div class="stats-card-icon bg-success">
                                                    <i class="fas fa-sun"></i>
                                                </div>
                                            </div>
                                            <h5 class="stats-card-value" id="pv{{i}}-voltage">Loading...</h5>
                                            <p class="stats-card-subtitle small">Solar Input</p>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="stats-card">
                                            <div class="stats-card-header">
                                                <h6 class="stats-card-title small">PV {{i}} Current</h6>
                                                <div class="stats-card-icon bg-info">
                                                    <i class="fas fa-tachometer-alt"></i>
                                                </div>
                                            </div>
                                            <h5 class="stats-card-value" id="pv{{i}}-current">Loading...</h5>
                                            <p class="stats-card-subtitle small">Charging Input</p>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="stats-card">
                                            <div class="stats-card-header">
                                                <h6 class="stats-card-title small">Load Voltage</h6>
                                                <div class="stats-card-icon bg-info">
                                                    <i class="fas fa-battery-full"></i>
                                                </div>
                                            </div>
                                            <h5 class="stats-card-value" id="load{{i}}-voltage-detail">Loading...</h5>
                                            <p class="stats-card-subtitle small">Battery Voltage</p>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="stats-card">
                                            <div class="stats-card-header">
                                                <h6 class="stats-card-title small">Load Current</h6>
                                                <div class="stats-card-icon bg-primary">
                                                    <i class="fas fa-arrow-left"></i>
                                                </div>
                                            </div>
                                            <h5 class="stats-card-value" id="load{{i}}-current-detail">Loading...</h5>
                                            <p class="stats-card-subtitle small">Load Current</p>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="stats-card">
                                            <div class="stats-card-header">
                                                <h6 class="stats-card-title small">Load Power</h6>
                                                <div class="stats-card-icon bg-warning">
                                                    <i class="fas fa-bolt"></i>
                                                </div>
                                            </div>
                                            <h5 class="stats-card-value" id="load{{i}}-power-detail">Loading...</h5>
                                            <p class="stats-card-subtitle small">Load Power</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="row mb-4">
    <div class="col-12">
        <div class="modern-card">
            <div class="modern-card-header">
                <h2 class="modern-card-title">
                    <i class="fas fa-tools"></i>
                    Quick Actions
                </h2>
            </div>
            <div class="modern-card-body">
                <div class="row g-3">
                    {% if menu_access.monitoring.scc %}
                    <div class="col-md-3">
                        <a href="/scc" class="btn btn-modern btn-primary w-100">
                            <i class="fas fa-solar-panel"></i>
                            Monitor SCC
                        </a>
                    </div>
                    {% endif %}
                    {% if menu_access.monitoring.battery %}
                    <div class="col-md-3">
                        <a href="/battery" class="btn btn-modern btn-success w-100">
                            <i class="fas fa-battery-full"></i>
                            Battery Status
                        </a>
                    </div>
                    {% endif %}
                    {% if menu_access.historical.datalog %}
                    <div class="col-md-3">
                        <a href="/datalog" class="btn btn-modern btn-info w-100">
                            <i class="fas fa-database"></i>
                            View Data Logs
                        </a>
                    </div>
                    {% endif %}
                    {% if menu_access.site_information %}
                    <div class="col-md-3">
                        <a href="/site-information" class="btn btn-modern btn-secondary w-100">
                            <i class="fas fa-info-circle"></i>
                            Site Information
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Enhanced dashboard functionality with real API integration
document.addEventListener('DOMContentLoaded', function() {
    // Get authentication token and user role from server
    const userToken = '{{ session.get("auth_token", "") }}';
    const userRole = '{{ user_role }}';
    
    // Initialize dashboard with real API data
    initializeDashboardData();
    
    // Set up periodic updates every 5 seconds
    setInterval(initializeDashboardData, 5000);
});

// Main dashboard data initialization
async function initializeDashboardData() {
    try {
        // Fetch all dashboard data concurrently
        const [systemResources, deviceInfo, systemdStatus, sccData] = await Promise.all([
            fetchAPIData('/api/v1/device/system-resources'),
            fetchAPIData('/api/v1/device/information'),
            fetchAPIData('/api/v1/device/systemd-status'),
            fetchAPIData('/api/v1/monitoring/scc')
        ]);

        // Update UI with fetched data
        if (systemResources) updateSystemResources(systemResources);
        if (deviceInfo) updateDeviceInformation(deviceInfo);
        if (systemdStatus) updateServiceStatus(systemdStatus);
        if (batteryData) updateBatteryOverview(batteryData);
        if (sccData) updateSCCOverview(sccData);

    } catch (error) {
        console.error('Error initializing dashboard data:', error);
    }
}

// Generic API fetch function with Bearer token authentication
async function fetchAPIData(endpoint) {
    const userToken = '{{ session.get("auth_token", "") }}';
    
    try {
        const response = await fetch(endpoint, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${userToken}`,
                'X-Requested-With': 'XMLHttpRequest'
            },
            credentials: 'same-origin'
        });
        
        if (!response.ok) {
            console.error(`❌ HTTP error for ${endpoint}: ${response.status} ${response.statusText}`);
            if (response.status === 401) {
                console.warn('Authentication failed, redirecting to login...');
                window.location.href = '/login';
                return null;
            } else if (response.status === 403) {
                console.warn(`Access denied to ${endpoint} for current user role`);
                return null;
            }
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log(`✅ Successfully fetched data from ${endpoint}:`, data);
        return data;
        
    } catch (error) {
        console.error(`❌ Failed to fetch data from ${endpoint}:`, error);
        return null;
    }
}

// Update system resources data
function updateSystemResources(data) {
    console.log('System resources data received:', data);
    
    if (!data || data.status_code !== 200) {
        console.warn('Invalid system resources data received');
        console.warn('Data:', data);
        return;
    }

    const resourceData = data.data;
    
    // CPU Usage
    const cpuElement = document.getElementById('cpu-usage');
    if (cpuElement && resourceData.cpu_usage !== undefined) {
        const cpuUsage = parseFloat(resourceData.cpu_usage.value);
        const cpuUnit = resourceData.cpu_usage.unit || '%';
        cpuElement.textContent = `${cpuUsage.toFixed(1)}${cpuUnit}`;
        cpuElement.className = cpuUsage > 80 ? 'stats-card-value text-danger' : 
                                cpuUsage > 60 ? 'stats-card-value text-warning' : 'stats-card-value';
    }
    
    // Memory Usage
    const memoryElement = document.getElementById('memory-usage');
    if (memoryElement && resourceData.memory_usage !== undefined) {
        const memoryUsage = parseFloat(resourceData.memory_usage.value);
        const memoryUnit = resourceData.memory_usage.unit || '%';
        memoryElement.textContent = `${memoryUsage.toFixed(1)}${memoryUnit}`;
        memoryElement.className = memoryUsage > 80 ? 'stats-card-value text-danger'
                                : memoryUsage > 60 ? 'stats-card-value text-warning' : 'stats-card-value';
    }
    
    // System Temperature
    const tempElement = document.getElementById('system-temp');
    if (tempElement && resourceData.temperature !== undefined) {
        const temp = parseFloat(resourceData.temperature.value);
        const tempUnit = resourceData.temperature.unit || '°C';
        tempElement.textContent = `${temp.toFixed(1)}${tempUnit}`;
        tempElement.className = temp > 70 ? 'stats-card-value text-danger' : 
                                temp > 60 ? 'stats-card-value text-warning' : 'stats-card-value';
    }
    
    // Disk Usage
    if (resourceData.disk_usage) {
        const diskUsed = resourceData.disk_usage.used || 0;
        const diskTotal = resourceData.disk_usage.total || 1;
        const diskUsagePercentage = (diskUsed / diskTotal * 100);
        
        // Update percentage display with color coding (matching other resources)
        const diskPercentageElement = document.getElementById('disk-usage-percentage');
        if (diskPercentageElement) {
            diskPercentageElement.textContent = `${diskUsagePercentage.toFixed(1)}%`;
            // Apply color coding based on usage (consistent with CPU and Memory)
            diskPercentageElement.className = diskUsagePercentage > 90 ? 'stats-card-value text-danger' : 
                                            diskUsagePercentage > 80 ? 'stats-card-value text-warning' : 
                                            'stats-card-value';
        }
    }
}

// Update status indicator with color coding
function updateStatusIndicator(elementId, status) {
    const element = document.getElementById(elementId);
    if (!element) return;
    
    // Normalize status to handle variations
    const normalizedStatus = status.toLowerCase().trim();
    
    // Green status indicators (working/active states)
    if (normalizedStatus === 'active' || normalizedStatus === 'is running') {
        const displayText = normalizedStatus === 'active' ? 'Active' : 'Running';
        element.textContent = displayText;
        element.className = 'status-indicator badge bg-success text-white';
    } 
    // Red status indicators (error/inactive states)
    else if (normalizedStatus === 'inactive' || normalizedStatus === 'is standby' || normalizedStatus === 'modbus error') {
        let displayText = 'Inactive';
        if (normalizedStatus === 'standby') displayText = 'Standby';
        else if (normalizedStatus === 'modbus error') displayText = 'Modbus Error';
        
        element.textContent = displayText;
        element.className = 'status-indicator badge bg-danger text-white';
    } 
    else {
        // Default fallback for any unexpected status
        element.textContent = status;
        element.className = 'status-indicator badge bg-secondary text-white';
    }
}

// Update service status data
function updateServiceStatus(data) {
    if (!data || data.status_code !== 200) {
        console.warn('Invalid service status data received');
        return;
    }

    const services = data.data;
    
    // Update each service status
    const serviceMapping = {
        'redis.service': 'redis-status',
        'mqtt_publish.service': 'mqtt-status', 
        'snmp_handler.service': 'snmp-status'
    };
    
    Object.keys(serviceMapping).forEach(serviceName => {
        const elementId = serviceMapping[serviceName];
        const statusElement = document.getElementById(elementId);
        
        if (statusElement && services.services_status[serviceName]) {
            const status = services.services_status[serviceName].toLowerCase();
            updateStatusIndicator(elementId, status);
        }
    });

    // Update system uptime
    const uptimeElement = document.getElementById('system-uptime');
    if (uptimeElement && services.system_uptime) {
        const uptime = services.system_uptime || 'N/A';
        uptimeElement.textContent = uptime;
        uptimeElement.className = 'stats-card-value';
    }
}

// Device Information Update
function updateDeviceInformation(data) {
    if (!data || data.status_code !== 200) {
        console.warn('Invalid device information data received');
        return;
    }

    const deviceData = data.data.device_version;
    
    // Battery Type
    const batteryTypeElement = document.getElementById('battery-type');
    if (batteryTypeElement && deviceData.battery_type) {
        batteryTypeElement.textContent = deviceData.battery_type.toUpperCase();
    }
    
    // SCC Type
    const sccTypeElement = document.getElementById('scc-type');
    if (sccTypeElement && deviceData.scc_type) {
        const sccType = deviceData.scc_type;
        sccTypeElement.textContent = sccType.toUpperCase();
        
        // Update SCC IDs based on type
        updateSCCIds(sccType);
    }
    
    // SCC IDs
    const sccIdsElement = document.getElementById('scc-ids');
    if (sccIdsElement && deviceData.scc_id) {
        if (Array.isArray(deviceData.scc_id)) {
            sccIdsElement.textContent = deviceData.scc_id.join(', ');
        } else {
            sccIdsElement.textContent = deviceData.scc_id.toString();
        }
    }
    
    // Datalog length
    const datalogElement = document.getElementById('datalog-length');
}

// SCC Device ID mapping
const sccDeviceIds = {
    'scc-srne': ['122', '123', '124'],
    'scc-epveper': ['1', '2'],
    'srne': ['122', '123', '124'],
    'epveper': ['1', '2']
};

// Update Battery Overview
function updateBatteryOverview(data) {
    if (!data || data.status_code !== 200) {
        console.warn('Invalid battery data received');
        return;
    }

    const batteryData = data.data;

    // Battery Voltage
    const batteryVoltageElement = document.getElementById('battery-voltage');
    if (batteryVoltageElement && batteryData.battery_voltage !== undefined) {
        const voltage = (batteryData.battery_voltage / 100);
        if (voltage === -1 || isNaN(voltage)) {
            batteryVoltageElement.textContent = 'N/A';
            batteryVoltageElement.classList.add('text-muted');
        } else {
            batteryVoltageElement.textContent = `${voltage.toFixed(2)} V`;
            batteryVoltageElement.classList.remove('text-muted');
        }
    }
    
    const activePack = batteryData.bms_data.forEach((pack, index) => {
        const packButton = document.getElementById(`pack${index + 1}-status`);
        if (packButton) {
            packButton.classList.remove('btn-secondary');
            packButton.classList.add(pack.status ? 'btn-success' : 'btn-dark');
        }
    });


}
// Update SCC IDs based on type
function updateSCCIds(sccType) {
    const sccIdsElement = document.getElementById('scc-ids');
    const normalizedType = sccType.toLowerCase().replace(/[^a-z]/g, '');
    
    if (sccIdsElement && sccDeviceIds[normalizedType]) {
        sccIdsElement.textContent = sccDeviceIds[normalizedType].join(', ');
    }
}

// SCC Overview Update
function updateSCCOverview(data) {
    if (!data || data.status_code !== 200) {
        console.warn('Invalid SCC data received');
        return;
    }

    const sccData = data.data;

    // Relay Configuration
    const vsatReconnectElement = document.getElementById('vsat-reconnect');
    if (vsatReconnectElement && sccData.relay_configuration.vsat_reconnect !== undefined) {
        const vsatReconnect = parseFloat(sccData.relay_configuration.vsat_reconnect);
        vsatReconnectElement.textContent = vsatReconnect;
    }
    const vsatCutoffElement = document.getElementById('vsat-cutoff');
    if (vsatCutoffElement && sccData.relay_configuration.vsat_cutoff !== undefined) {
        const vsatCutoff = parseFloat(sccData.relay_configuration.vsat_cutoff);
        vsatCutoffElement.textContent = vsatCutoff;
    }
    const btsReconnectElement = document.getElementById('bts-reconnect');
    if (btsReconnectElement && sccData.relay_configuration.bts_reconnect !== undefined) {
        const btsReconnect = parseFloat(sccData.relay_configuration.bts_reconnect);
        btsReconnectElement.textContent = btsReconnect;
    }
    const btsCutoffElement = document.getElementById('bts-cutoff');
    if (btsCutoffElement && sccData.relay_configuration.bts_cutoff !== undefined) {
        const btsCutoff = parseFloat(sccData.relay_configuration.bts_cutoff);
        btsCutoffElement.textContent = btsCutoff;
    }
    
    {% if number_of_scc >= 2 %}
    {% for i in range(1, number_of_scc+1) %}
    
    // Update SCC {{i}} data if available
    if (sccData.scc{{i}}) {
        const scc{{i}}Data = sccData.scc{{i}};
        
        // SCC {{i}} Status
        const scc{{i}}StatusElement = document.getElementById('scc{{i}}-status');
        if (scc{{i}}StatusElement && scc{{i}}Data.load_status) {
            const status = scc{{i}}Data.load_status;
            updateStatusIndicator('scc{{i}}-status', status);
        }

        // PV {{i}} Voltage
        const pv{{i}}VoltageElement = document.getElementById('pv{{i}}-voltage');
        if (pv{{i}}VoltageElement && scc{{i}}Data.pv_voltage !== undefined) {
            const voltage = parseFloat(scc{{i}}Data.pv_voltage);
            if (voltage === -1 || isNaN(voltage)) {
                pv{{i}}VoltageElement.textContent = 'N/A';
                pv{{i}}VoltageElement.classList.add('text-muted');
            } else {
                pv{{i}}VoltageElement.textContent = `${voltage.toFixed(1)} V`;
                pv{{i}}VoltageElement.classList.remove('text-muted');
            }
        }

        // PV {{i}} Current
        const pv{{i}}CurrentElement = document.getElementById('pv{{i}}-current');
        if (pv{{i}}CurrentElement && scc{{i}}Data.pv_current !== undefined) {
            const current = parseFloat(scc{{i}}Data.pv_current);
            if (current === -1 || isNaN(current)) {
                pv{{i}}CurrentElement.textContent = 'N/A';
                pv{{i}}CurrentElement.classList.add('text-muted');
            } else {
                pv{{i}}CurrentElement.textContent = `${current.toFixed(2)} A`;
                pv{{i}}CurrentElement.classList.remove('text-muted');
            }
        }

        // Load Voltage Detail for SCC {{i}}
        const load{{i}}VoltageDetailElement = document.getElementById('load{{i}}-voltage-detail');
        if (load{{i}}VoltageDetailElement && scc{{i}}Data.load_voltage !== undefined) {
            const voltage = parseFloat(scc{{i}}Data.load_voltage);
            if (voltage === -1 || isNaN(voltage)) {
                load{{i}}VoltageDetailElement.textContent = 'N/A';
                load{{i}}VoltageDetailElement.classList.add('text-muted');
            } else {
                load{{i}}VoltageDetailElement.textContent = `${voltage.toFixed(1)} V`;
                load{{i}}VoltageDetailElement.classList.remove('text-muted');
            }
        }

        // Load Current Detail for SCC {{i}}
        const load{{i}}CurrentDetailElement = document.getElementById('load{{i}}-current-detail');
        if (load{{i}}CurrentDetailElement && scc{{i}}Data.load_current !== undefined) {
            const current = parseFloat(scc{{i}}Data.load_current);
            if (current === -1 || isNaN(current)) {
                load{{i}}CurrentDetailElement.textContent = 'N/A';
                load{{i}}CurrentDetailElement.classList.add('text-muted');
            } else {
                load{{i}}CurrentDetailElement.textContent = `${current.toFixed(2)} A`;
                load{{i}}CurrentDetailElement.classList.remove('text-muted');
            }
        }

        // Load Power Detail for SCC {{i}} (calculated)
        const load{{i}}PowerDetailElement = document.getElementById('load{{i}}-power-detail');
        if (load{{i}}PowerDetailElement && scc{{i}}Data.load_voltage !== undefined && scc{{i}}Data.load_current !== undefined) {
            const voltage = parseFloat(scc{{i}}Data.load_voltage);
            const current = parseFloat(scc{{i}}Data.load_current);
            
            if (voltage === -1 || current === -1 || isNaN(voltage) || isNaN(current)) {
                load{{i}}PowerDetailElement.textContent = 'N/A';
                load{{i}}PowerDetailElement.classList.add('text-muted');
            } else {
                const power = (voltage * current).toFixed(2);
                load{{i}}PowerDetailElement.textContent = `${power} W`;
                load{{i}}PowerDetailElement.classList.remove('text-muted');
            }
        }

        // SCC {{i}} Device ID
        const scc{{i}}DeviceIdElement = document.getElementById('scc{{i}}-id');
        if (scc{{i}}DeviceIdElement && scc{{i}}Data.scc_id !== undefined) {
            scc{{i}}DeviceIdElement.textContent = `SCC ID: ${scc{{i}}Data.scc_id}`;
        }

        // SCC {{i}} Counter Heartbeat
        const scc{{i}}HeartbeatElement = document.getElementById('scc{{i}}-counter-heartbeat');
        if (scc{{i}}HeartbeatElement && scc{{i}}Data.counter_heartbeat !== undefined) {
            const heartbeat = scc{{i}}Data.counter_heartbeat;
            scc{{i}}HeartbeatElement.textContent = `Heartbeat: ${heartbeat}`;
        }
        
        // Last Update for SCC {{i}}
        const lastUpdate{{i}}Element = document.getElementById('last-update-{{i}}');
        if (lastUpdate{{i}}Element && sccData.last_update !== undefined) {
            lastUpdate{{i}}Element.textContent = `Last Update: ${sccData.last_update}`;
        }
    } else {
        console.warn(`SCC{{i}} data not available in API response`);
    }
    
    {% endfor %}
    {% endif %}
}

// Error handling for authentication failures
window.addEventListener('unhandledrejection', function(event) {
    if (event.reason && event.reason.message && event.reason.message.includes('401')) {
        console.warn('Authentication session expired, redirecting to login...');
        window.location.href = '/login';
    }
});

console.log('🚀 Dashboard initialized with role-based API authentication');
console.log(`👤 Current user role: {{ user_role }}`);
</script>
{% endblock %}
