{% extends 'modern-layout.html' %}
{% block breadcrumbs %}Battery Monitoring{% endblock breadcrumbs %}

{% block content %}
<!-- Battery Pack Selection -->
<div class="row mb-4">
    <div class="col-12">
        <div class="modern-card">
            <div class="modern-card-header">
                <h2 class="modern-card-title">
                    <i class="fas fa-battery-full"></i>
                    Battery Pack Management
                </h2>
            </div>
            <div class="modern-card-body">
                <div class="d-flex flex-wrap gap-3 justify-content-center">
                    {% for i in range(1, number_of_battery+1) %}
                    <button class="btn btn-modern btn-secondary pack-selector" id="pack{{i}}-button" data-pack="{{i}}">
                        <i class="fas fa-battery-full"></i>
                        Pack {{i}}
                    </button>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Battery Pack Information -->
{% for i in range(1, number_of_battery+1) %}
<div class="pack-information" id="pack-information-{{i}}" style="display: none;">
    <!-- Pack Status Overview -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="modern-card">
                <div class="modern-card-header">
                    <h3 class="modern-card-title">
                        <i class="fas fa-battery-full"></i>
                        Battery Pack {{i}} - Status Overview
                        <div class="d-flex align-items-center">
                            <i class="fas fa-heartbeat text-danger me-2"></i>
                            <span class="text-muted" id="heartbeat-{{i}}">Heartbeat: Loading...</span>
                            <span class="text-muted mx-2">|</span>
                            <i class="fas fa-clock text-info me-2"></i>
                            <span class="text-muted small" id="last-update-{{i}}">Last Update: Loading...</span>
                        </div>
                    </h3>
                </div>
                <div class="modern-card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <div class="stats-card">
                                <div class="stats-card-header">
                                    <h6 class="stats-card-title">Port</h6>
                                    <div class="stats-card-icon bg-info">
                                        <i class="fas fa-plug"></i>
                                    </div>
                                </div>
                                <h3 class="stats-card-value" id="port-{{i}}">Loading...</h3>
                                <p class="stats-card-subtitle">Connection Port</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stats-card">
                                <div class="stats-card-header">
                                    <h6 class="stats-card-title">Pack Status</h6>
                                    <div class="stats-card-icon bg-success">
                                        <i class="fas fa-check-circle"></i>
                                    </div>
                                </div>
                                <h3 class="stats-card-value">
                                    <span class="status-indicator" id="pack-status-{{i}}">Loading...</span>
                                </h3>
                                <p class="stats-card-subtitle">Current Status</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stats-card">
                                <div class="stats-card-header">
                                    <h6 class="stats-card-title">PCB Code</h6>
                                    <div class="stats-card-icon bg-primary">
                                        <i class="fas fa-hashtag"></i>
                                    </div>
                                </div>
                                <h3 class="stats-card-value" id="pcb-code-{{i}}">Loading...</h3>
                                <p class="stats-card-subtitle">PCB Code Battery</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stats-card">
                                <div class="stats-card-header">
                                    <h6 class="stats-card-title">SN Code</h6>
                                    <div class="stats-card-icon bg-primary">
                                        <i class="fas fa-hashtag"></i>
                                    </div>
                                </div>
                                <h3 class="stats-card-value" id="sn-code-{{i}}">Loading...</h3>
                                <p class="stats-card-subtitle">Serial Number Battery</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Battery Metrics -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="modern-card">
                <div class="modern-card-header">
                    <h3 class="modern-card-title">
                        <i class="fas fa-chart-line"></i>
                        Battery Pack {{i}} - Key Metrics
                    </h3>
                </div>
                <div class="modern-card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <div class="stats-card">
                                <div class="stats-card-header">
                                    <h6 class="stats-card-title">Voltage</h6>
                                    <div class="stats-card-icon bg-warning">
                                        <i class="fas fa-bolt"></i>
                                    </div>
                                </div>
                                <h3 class="stats-card-value" id="pack{{i}}-voltage">Loading...</h3>
                                <p class="stats-card-subtitle">Pack Voltage</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stats-card">
                                <div class="stats-card-header">
                                    <h6 class="stats-card-title">Current</h6>
                                    <div class="stats-card-icon bg-primary">
                                        <i class="fas fa-tachometer-alt"></i>
                                    </div>
                                </div>
                                <h3 class="stats-card-value" id="pack{{i}}-current">Loading...</h3>
                                <p class="stats-card-subtitle">Battery Current</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stats-card">
                                <div class="stats-card-header">
                                    <h6 class="stats-card-title">SOC</h6>
                                    <div class="stats-card-icon bg-success">
                                        <i class="fas fa-percentage"></i>
                                    </div>
                                </div>
                                <h3 class="stats-card-value" id="pack{{i}}-soc">Loading...</h3>
                                <p class="stats-card-subtitle">State of Charge</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stats-card">
                                <div class="stats-card-header">
                                    <h6 class="stats-card-title">SOH</h6>
                                    <div class="stats-card-icon bg-info">
                                        <i class="fas fa-heart"></i>
                                    </div>
                                </div>
                                <h3 class="stats-card-value" id="pack{{i}}-soh">Loading...</h3>
                                <p class="stats-card-subtitle">State of Health</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Battery Status -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="modern-card">
                <div class="modern-card-header">
                    <h3 class="modern-card-title">
                        <i class="fas fa-info-circle"></i>
                        Battery Pack {{i}} - Status Information
                    </h3>
                </div>
                <div class="modern-card-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <div class="stats-card">
                                <div class="stats-card-header">
                                    <h6 class="stats-card-title">Cell Max</h6>
                                    <div class="stats-card-icon bg-danger">
                                        <i class="fas fa-arrow-up"></i>
                                    </div>
                                </div>
                                <h3 class="stats-card-value" id="cell-max-{{i}}">Loading...</h3>
                                <p class="stats-card-subtitle">Maximum Cell Voltage</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="stats-card">
                                <div class="stats-card-header">
                                    <h6 class="stats-card-title">Cell Min</h6>
                                    <div class="stats-card-icon bg-success">
                                        <i class="fas fa-arrow-down"></i>
                                    </div>
                                </div>
                                <h3 class="stats-card-value" id="cell-min-{{i}}">Loading...</h3>
                                <p class="stats-card-subtitle">Minimum Cell Voltage</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="stats-card">
                                <div class="stats-card-header">
                                    <h6 class="stats-card-title">Cell Difference</h6>
                                    <div class="stats-card-icon bg-warning">
                                        <i class="fas fa-balance-scale"></i>
                                    </div>
                                </div>
                                <h3 class="stats-card-value" id="cell-diff-{{i}}">Loading...</h3>
                                <p class="stats-card-subtitle">Cell Voltage Difference</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MOSFET Status -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="modern-card">
                <div class="modern-card-header">
                    <h3 class="modern-card-title">
                        <i class="fas fa-microchip"></i>
                        Battery Pack {{i}} - MOSFET Status
                    </h3>
                </div>
                <div class="modern-card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="stats-card">
                                <div class="stats-card-header">
                                    <h6 class="stats-card-title">CMOS State</h6>
                                    <div class="stats-card-icon bg-primary">
                                        <i class="fas fa-power-off"></i>
                                    </div>
                                </div>
                                <h3 class="stats-card-value">
                                    <span class="status-indicator" id="cmos-status-{{i}}">Loading...</span>
                                </h3>
                                <p class="stats-card-subtitle">Charging MOSFET</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="stats-card">
                                <div class="stats-card-header">
                                    <h6 class="stats-card-title">DMOS State</h6>
                                    <div class="stats-card-icon bg-secondary">
                                        <i class="fas fa-power-off"></i>
                                    </div>
                                </div>
                                <h3 class="stats-card-value">
                                    <span class="status-indicator" id="dmos-status-{{i}}">Loading...</span>
                                </h3>
                                <p class="stats-card-subtitle">Discharging MOSFET</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Temperature Status -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="modern-card">
                <div class="modern-card-header">
                    <h3 class="modern-card-title">
                        <i class="fas fa-thermometer-half"></i>
                        Battery Pack {{i}} - Temperature Monitoring
                    </h3>
                </div>
                <div class="modern-card-body">
                    <div class="row g-2">
                        <div class="col-md-6">
                            <div class="stats-card">
                                <div class="stats-card-header">
                                    <h6 class="stats-card-title">CMOS Temp</h6>
                                    <div class="stats-card-icon bg-danger">
                                        <i class="fas fa-thermometer-three-quarters"></i>
                                    </div>
                                </div>
                                <h3 class="stats-card-value" id="cmos-temp-{{i}}">Loading...</h3>
                                <p class="stats-card-subtitle">CMOS Temperature</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="stats-card">
                                <div class="stats-card-header">
                                    <h6 class="stats-card-title">DMOS Temp</h6>
                                    <div class="stats-card-icon bg-warning">
                                        <i class="fas fa-thermometer-three-quarters"></i>
                                    </div>
                                </div>
                                <h3 class="stats-card-value" id="dmos-temp-{{i}}">Loading...</h3>
                                <p class="stats-card-subtitle">DMOS Temperature</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="stats-card">
                                <div class="stats-card-header">
                                    <h6 class="stats-card-title">Temp Top</h6>
                                    <div class="stats-card-icon bg-info">
                                        <i class="fas fa-thermometer-half"></i>
                                    </div>
                                </div>
                                <h3 class="stats-card-value" id="top-temp-{{i}}">Loading...</h3>
                                <p class="stats-card-subtitle">Top Temperature</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="stats-card">
                                <div class="stats-card-header">
                                    <h6 class="stats-card-title">Temp Mid</h6>
                                    <div class="stats-card-icon bg-success">
                                        <i class="fas fa-thermometer-half"></i>
                                    </div>
                                </div>
                                <h3 class="stats-card-value" id="mid-temp-{{i}}">Loading...</h3>
                                <p class="stats-card-subtitle">Middle Temperature</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="stats-card">
                                <div class="stats-card-header">
                                    <h6 class="stats-card-title">Temp Bot</h6>
                                    <div class="stats-card-icon bg-primary">
                                        <i class="fas fa-thermometer-quarter"></i>
                                    </div>
                                </div>
                                <h3 class="stats-card-value" id="bot-temp-{{i}}">Loading...</h3>
                                <p class="stats-card-subtitle">Bottom Temperature</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Cell Voltages -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="modern-card">
                <div class="modern-card-header">
                    <h3 class="modern-card-title">
                        <i class="fas fa-battery-quarter"></i>
                        Battery Pack {{i}} - Cell Voltages
                    </h3>
                </div>
                <div class="modern-card-body">
                    <div class="row g-2">
                        <!-- Cell voltage monitoring grid -->
                        {% for cell in range(1, 17) %}
                        <div class="col-md-3 col-sm-4 col-6">
                            <div class="stats-card">
                                <div class="stats-card-header">
                                    <h6 class="stats-card-title">Cell {{cell}}</h6>
                                    <div class="stats-card-icon bg-primary">
                                        <i class="fas fa-battery-half"></i>
                                    </div>
                                </div>
                                <h4 class="stats-card-value" id="pack{{i}}-cell{{cell}}-voltage">Loading...</h4>
                                <p class="stats-card-subtitle">Cell {{cell}} Voltage</p>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endfor %}

{% endblock %}

{% block scripts %}
<script>
    // const API_BASE_URL = 'http://{{ ip_address }}/api/v1/monitoring';
    const API_BASE_URL = 'http://10.10.10.60/api/v1/monitoring';

    document.addEventListener('DOMContentLoaded', function() {
        // Get authentication token and user role from server
        const userToken = '{{ session.get("auth_token", "") }}';
        const userRole = '{{ user_role }}';

        // Pack selector functionality
        const packSelectors = document.querySelectorAll('.pack-selector');
        const packInformation = document.querySelectorAll('.pack-information');
        
        packSelectors.forEach(selector => {
            selector.addEventListener('click', function() {
                const packNumber = this.getAttribute('data-pack');
                
                // Hide all pack information
                packInformation.forEach(info => {
                    info.style.display = 'none';
                });
                
                // Remove active class from all selectors
                packSelectors.forEach(sel => {
                    sel.classList.remove('btn-primary');
                    sel.classList.add('btn-secondary');
                });
                
                // Show selected pack information
                document.getElementById(`pack-information-${packNumber}`).style.display = 'block';
                
                // Add active class to selected selector
                this.classList.remove('btn-secondary');
                this.classList.add('btn-primary');
            });
        });
        
        // Show first pack by default
        if (packSelectors.length > 0) {
            packSelectors[0].click();
        }
        
        // Start battery monitoring with real API data
        startBatteryMonitoring();
    });

    // API functions to fetch real data
    async function fetchBatteryData() {
        const userToken = '{{ session.get("auth_token", "") }}';

        try {
            const response = await fetch(`${API_BASE_URL}/battery`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${userToken}`
                }
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const result = await response.json();
            return result.data;
        } catch (error) {
            console.error('Error fetching battery data:', error);
            return null;
        }
    }

    async function fetchBatteryActiveData() {
        const userToken = '{{ session.get("auth_token", "") }}';
        
        try {
            const response = await fetch(`${API_BASE_URL}/battery/active`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${userToken}`
                }
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const result = await response.json();
            return result.data;
        } catch (error) {
            console.error('Error fetching battery active data:', error);
            return null;
        }
    }

    // Helper function to update status indicator elements
    function updateStatusIndicator(elementId, status, activeStates = ['Online', 'ON'], dangerStates = ['Offline', 'modbus error', 'unknown status']) {
        const element = document.getElementById(elementId);
        if (element) {
            element.textContent = status;
            
            if (activeStates.includes(status)) {
                element.className = 'status-indicator active';
            } else if (dangerStates.includes(status)) {
                element.className = 'status-indicator danger';
            } else {
                element.className = 'status-indicator inactive';
            }
        }
    }

    // Process real battery data and map to UI
    function updateBatteryUIFromAPI(batteryData, activeData) {
        if (!batteryData || !batteryData.bms_data) {
            console.log('No battery data available');
            return;
        }

        // Create a map of active slaves for quick lookup
        const activeSlaves = {};
        if (activeData && activeData.bms_data) {
            activeData.bms_data.forEach(slave => {
                activeSlaves[slave.slave_id] = slave.status;
            });
        }

        // Process each BMS data entry
        batteryData.bms_data.forEach((bms, index) => {
            const packNumber = bms.slave_id; // Use slave_id as pack number
            const isActive = activeSlaves[bms.slave_id] || false;
            
            // Update pack status overview
            const packStatusEl = document.getElementById(`pack-status-${packNumber}`);
            const portEl = document.getElementById(`port-${packNumber}`);
            const voltageEl = document.getElementById(`pack${packNumber}-voltage`);
            
            // Update pack status based on active status
            updateStatusIndicator(`pack-status-${packNumber}`, isActive ? 'Online' : 'Offline', ['Online'], ['Offline']);
            
            if (portEl) portEl.textContent = bms.port || 'Unknown';
            if (voltageEl) voltageEl.textContent = `${(parseFloat(bms.pack_voltage || 0) / 100).toFixed(2)} V`;

            // Update additional elements
            const pcbCodeEl = document.getElementById(`pcb-code-${packNumber}`);
            const snCodeEl = document.getElementById(`sn-code-${packNumber}`);
            const heartbeatEl = document.getElementById(`heartbeat-${packNumber}`);
            
            if (pcbCodeEl) pcbCodeEl.textContent = bms.pcb_code || 'N/A';
            if (snCodeEl) snCodeEl.textContent = bms.sn1_code || 'N/A';
            if (heartbeatEl) heartbeatEl.textContent = `Heartbeat: ${bms.counter || 0}`;

            // Update last update timestamp
            const lastUpdateEl = document.getElementById(`last-update-${packNumber}`);
            if (lastUpdateEl) lastUpdateEl.textContent = `Last Update: ${bms.last_update || 'N/A'}`;

            // Update key metrics
            const currentEl = document.getElementById(`pack${packNumber}-current`);
            const temperatureEl = document.getElementById(`pack${packNumber}-temperature`);
            const socEl = document.getElementById(`pack${packNumber}-soc`);
            const sohEl = document.getElementById(`pack${packNumber}-soh`);
            const cyclesEl = document.getElementById(`pack${packNumber}-cycles`);
            const capacityEl = document.getElementById(`pack${packNumber}-capacity`);

            if (currentEl) currentEl.textContent = `${parseFloat(bms.pack_current || 0).toFixed(2)} A`;
            if (temperatureEl) temperatureEl.textContent = `${parseFloat(bms.pack_temperature || 0).toFixed(1)} °C`;
            if (socEl) socEl.textContent = `${(bms.soc / 100).toFixed(0) || 0}%`;
            if (sohEl) sohEl.textContent = `${(bms.soh / 100).toFixed(0) || 0}%`;
            if (cyclesEl) cyclesEl.textContent = bms.cycles || 0;
            if (capacityEl) capacityEl.textContent = `${(bms.capacity / 100).toFixed(0) || 0}%`;

            // Update status information
            const cellMaxEl = document.getElementById(`cell-max-${packNumber}`);
            const cellMinEl = document.getElementById(`cell-min-${packNumber}`);
            const cellDiffEl = document.getElementById(`cell-diff-${packNumber}`);

            if (cellMaxEl) cellMaxEl.textContent = `${bms.max_cell_voltage || 0} mV`;
            if (cellMinEl) cellMinEl.textContent = `${bms.min_cell_voltage || 0} mV`;
            if (cellDiffEl) cellDiffEl.textContent = `${bms.cell_difference || 0} mV`;

            // Update MOSFET status
            let cmosStatus = 'OFF';
            let dmosStatus = 'OFF';
            
            if (bms.fault_status_flag && Array.isArray(bms.fault_status_flag)) {
                cmosStatus = bms.fault_status_flag.includes('charge Mosfet ON') ? 'ON' : 'OFF';
                dmosStatus = bms.fault_status_flag.includes('discharge Mosfet ON') ? 'ON' : 'OFF';
            }
            
            updateStatusIndicator(`cmos-status-${packNumber}`, cmosStatus, ['ON'], ['OFF']);
            updateStatusIndicator(`dmos-status-${packNumber}`, dmosStatus, ['ON'], ['OFF']);


            // Update temperature status
            const cmosTemperatureEl = document.getElementById(`cmos-temp-${packNumber}`);
            const dmosTemperatureEl = document.getElementById(`dmos-temp-${packNumber}`);
            const topTemperatureEl = document.getElementById(`top-temp-${packNumber}`);
            const midTemperatureEl = document.getElementById(`mid-temp-${packNumber}`);
            const botTemperatureEl = document.getElementById(`bot-temp-${packNumber}`);

            if (cmosTemperatureEl) cmosTemperatureEl.textContent = `${parseFloat(bms.cmos_temp || 0).toFixed(1)} °C`;
            if (dmosTemperatureEl) dmosTemperatureEl.textContent = `${parseFloat(bms.dmos_temp || 0).toFixed(1)} °C`;
            if (topTemperatureEl) topTemperatureEl.textContent = `${parseFloat(bms.env_temp || 0).toFixed(1)} °C`;
            if (midTemperatureEl) midTemperatureEl.textContent = `${parseFloat(bms.env_temp || 0).toFixed(1)} °C`;
            if (botTemperatureEl) botTemperatureEl.textContent = `${parseFloat(bms.env_temp || 0).toFixed(1)} °C`;

            // Update cell voltages (if available)
            for (let i = 1; i <= 16; i++) {
                const cellEl = document.getElementById(`pack${packNumber}-cell${i}-voltage`);
                if (cellEl) {
                    const cellVoltage = bms[`cell_${i}_voltage`] || 0;
                    cellEl.textContent = `${cellVoltage} mV`;
                }
            }

            // Update chart data
            updateBatteryChart(packNumber, bms);
        });
    }

    function updateBatteryChart(packNumber, data) {
        const chartId = `batteryChart${packNumber}`;
        
        if (window.powerDeskApp && window.powerDeskApp.charts[chartId]) {
            const chart = window.powerDeskApp.charts[chartId];
            const now = new Date().toLocaleTimeString();
            
            // Add new data point
            chart.data.labels.push(now);
            chart.data.datasets[0].data.push(parseFloat(data.pack_voltage || data.voltage || 0));
            chart.data.datasets[1].data.push(parseFloat(data.pack_current || data.current || 0));
            chart.data.datasets[2].data.push(parseFloat(data.max_cell_voltage || data.maxCellVoltage || 0));
            chart.data.datasets[3].data.push(parseFloat(data.min_cell_voltage || data.minCellVoltage || 0));
            chart.data.datasets[4].data.push(parseFloat(data.cell_difference || data.cellDifference || 0));
            
            // Keep only last 20 data points
            if (chart.data.labels.length > 20) {
                chart.data.labels.shift();
                chart.data.datasets.forEach(dataset => dataset.data.shift());
            }
            
            chart.update('none');
        }
    }

    async function startBatteryMonitoring() {
        // Load initial data
        await loadBatteryData();
        
        // Set up periodic updates every 5 seconds
        setInterval(async () => {
            await loadBatteryData();
        }, 5000);
    }

    async function loadBatteryData() {
        try {
            // Fetch both battery and active data
            const [batteryData, activeData] = await Promise.all([
                fetchBatteryData(),
                fetchBatteryActiveData()
            ]);

            if (batteryData && batteryData.bms_data && batteryData.bms_data.length > 0) {
                // Use real API data
                updateBatteryUIFromAPI(batteryData, activeData);
                console.log('Updated UI with real battery data');
            } else {
                console.log('No battery data available from API');
            }
        } catch (error) {
            console.error('Error loading battery data:', error);
        }
    }

</script>
{% endblock %}