{% extends 'modern-layout.html' %}

{% block title %}Rectifier Monitoring - JSPro PowerDesk{% endblock %}

{% block breadcrumbs %}
<i class="fas fa-plug"></i>
Rectifier Monitoring
{% endblock %}

{% block content %}
<div class="content-area">
    <!-- Rectifier System Overview -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="modern-card">
                <div class="modern-card-header">
                    <h4 class="modern-card-title mb-1">
                        <i class="fas fa-plug me-2"></i>
                        Rectifier System Status
                    </h4>
                    <p class="text-muted mb-0">Real-time power system monitoring and alerts</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Rectifier System Overview -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="modern-card">
                <div class="modern-card-header">
                    <h2 class="modern-card-title">
                        <i class="fas fa-plug"></i>
                        Rectifier System Overview
                    </h2>
                </div>
                <div class="modern-card-body">
                    <div class="row g-3">
                        <!-- AC Voltage -->
                        <div class="col-md-3">
                            <div class="stats-card">
                                <div class="stats-card-header">
                                    <h6 class="stats-card-title">AC Input Voltage</h6>
                                    <div class="stats-card-icon bg-warning">
                                        <i class="fas fa-bolt"></i>
                                    </div>
                                </div>
                                <h3 class="stats-card-value" id="ac-voltage">--</h3>
                                <p class="stats-card-subtitle">Volts AC</p>
                            </div>
                        </div>
                        <!-- Battery Voltage -->
                        <div class="col-md-3">
                            <div class="stats-card">
                                <div class="stats-card-header">
                                    <h6 class="stats-card-title">Battery Voltage</h6>
                                    <div class="stats-card-icon bg-success">
                                        <i class="fas fa-battery-half"></i>
                                    </div>
                                </div>
                                <h3 class="stats-card-value" id="battery-voltage">--</h3>
                                <p class="stats-card-subtitle">Volts DC</p>
                            </div>
                        </div>
                        <!-- Temperature -->
                        <div class="col-md-3">
                            <div class="stats-card">
                                <div class="stats-card-header">
                                    <h6 class="stats-card-title">Temperature</h6>
                                    <div class="stats-card-icon bg-info">
                                        <i class="fas fa-thermometer-half"></i>
                                    </div>
                                </div>
                                <h3 class="stats-card-value" id="temperature">--</h3>
                                <p class="stats-card-subtitle">Celsius</p>
                            </div>
                        </div>
                        <!-- System Status -->
                        <div class="col-md-3">
                            <div class="stats-card">
                                <div class="stats-card-header">
                                    <h6 class="stats-card-title">System Status</h6>
                                    <div class="stats-card-icon bg-primary">
                                        <i class="fas fa-power-off"></i>
                                    </div>
                                </div>
                                <h3 class="stats-card-value" id="system-status">--</h3>
                                <p class="stats-card-subtitle">Operational State</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Controls Section -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="alert-panel">
                                <div class="row g-2 mt-2">
                                    <div class="col-md-6">
                                        <small class="text-muted">Last Update: <span id="lastUpdate">Never</span></small>
                                    </div>
                                    <div class="col-md-6 text-end">
                                        <button type="button" class="btn btn-outline-primary btn-sm me-2" id="refreshData">
                                            <i class="fas fa-sync-alt"></i> Refresh
                                        </button>
                                        <div class="form-check form-switch d-inline-block">
                                            <input class="form-check-input" type="checkbox" id="autoRefresh" checked>
                                            <label class="form-check-label" for="autoRefresh">Auto</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Status & Alarm Parameters Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="modern-card">
                <div class="modern-card-header">
                    <h2 class="modern-card-title">
                        <i class="fas fa-exclamation-triangle"></i>
                        Status & Alarms
                    </h2>
                </div>
                <div class="modern-card-body">
                    <div class="row g-3" id="statusParameters">
                        <!-- Status parameter cards will be populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Indicator -->
    <div class="text-center py-5" id="loadingIndicator" style="display: none;">
        <div class="spinner-border text-primary me-2" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <span>Loading rectifier data...</span>
    </div>
</div>


{% endblock %}

{% block scripts %}
<script>
// API Configuration for new monitoring endpoint
const RECTIFIER_API_URL = '/api/v1/monitoring/rectifier';
const USER_TOKEN = '{{ session.get("auth_token", "") }}';

class RectifierMonitor {
    constructor() {
        this.refreshInterval = null;
        this.autoRefreshEnabled = true;
        this.lastUpdateTime = null;
        this.rectifierData = {};
        
        this.powerParams = ['hwRectACVoltage', 'hwBatteryVoltage', 'hwRectifierTemperature'];
        this.statusParams = [
            'hwAcInputStatus', 'hwRectifierStatus', 'hwBatteryDischarge',
            'hwBatteryLowVoltage', 'hwBatteryUltraLowVoltage', 'hwBatteryDisconnect',
            'hwFuseBroken', 'hwLoadFuseAlarmTraps', 'hwTcucDoorOpenAlarmTraps'
        ];
        
        this.init();
    }
    
    init() {
        this.bindEvents();
        this.startAutoRefresh();
        this.loadData();
    }
    
    bindEvents() {
        // Refresh button
        document.getElementById('refreshData').addEventListener('click', () => {
            this.loadData();
        });
        
        // Auto refresh toggle
        document.getElementById('autoRefresh').addEventListener('change', (e) => {
            this.autoRefreshEnabled = e.target.checked;
            if (this.autoRefreshEnabled) {
                this.startAutoRefresh();
            } else {
                this.stopAutoRefresh();
            }
        });
    }
    
    startAutoRefresh() {
        this.stopAutoRefresh();
        if (this.autoRefreshEnabled) {
            this.refreshInterval = setInterval(() => {
                this.loadData();
            }, 10000); // 10 seconds
        }
    }
    
    stopAutoRefresh() {
        if (this.refreshInterval) {
            clearInterval(this.refreshInterval);
            this.refreshInterval = null;
        }
    }
    
    async loadData() {
        try {
            // Show loading indicator
            document.getElementById('loadingIndicator').style.display = 'block';
            
            const response = await fetch(RECTIFIER_API_URL, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${USER_TOKEN}`,
                    'Content-Type': 'application/json'
                },
                credentials: 'same-origin'
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            
            if (data.status_code === 200) {
                this.updateUI(data.data);
                this.updateConnectionStatus('Connected', 'success');
            } else {
                throw new Error(data.message || 'Failed to fetch data');
            }
            
        } catch (error) {
            console.error('Error loading rectifier data:', error);
            this.updateConnectionStatus('Disconnected', 'error');
            this.showError('Failed to load rectifier data: ' + error.message);
        } finally {
            // Hide loading indicator
            document.getElementById('loadingIndicator').style.display = 'none';
        }
    }
    
    updateUI(data) {
        const rectifierData = data.rectifier_data;
        
        // Update main overview cards
        this.updateOverviewCards(rectifierData);
        
        // Update status parameters
        this.updateStatusParameters(rectifierData);
        
        // Update last update time
        document.getElementById('lastUpdate').textContent = data.last_update || 'Never';
        
        this.lastUpdateTime = new Date();
    }
    
    updateOverviewCards(rectifierData) {
        // AC Voltage
        const acVoltage = rectifierData.hwRectACVoltage;
        if (acVoltage) {
            document.getElementById('ac-voltage').textContent = `${acVoltage.value} ${acVoltage.unit}`;
        }
        
        // Battery Voltage
        const batteryVoltage = rectifierData.hwBatteryVoltage;
        if (batteryVoltage) {
            document.getElementById('battery-voltage').textContent = `${batteryVoltage.value} ${batteryVoltage.unit}`;
        }
        
        // Temperature
        const temperature = rectifierData.hwRectifierTemperature;
        if (temperature) {
            document.getElementById('temperature').textContent = `${temperature.value} ${temperature.unit}`;
        }
        
        // System Status - determine overall status from rectifier status
        const rectifierStatus = rectifierData.hwRectifierStatus;
        if (rectifierStatus) {
            const statusText = this.interpretStatusValue(rectifierStatus.value, 'hwRectifierStatus');
            document.getElementById('system-status').textContent = statusText;
        }
    }
    
    updateStatusParameters(rectifierData) {
        const container = document.getElementById('statusParameters');
        container.innerHTML = '';
        
        this.statusParams.forEach(param => {
            const data = rectifierData[param];
            if (data) {
                const card = this.createParameterCard(param, data, true);
                // Update column size for status parameters to fit more per row
                card.className = 'col-md-4 col-lg-3';
                container.appendChild(card);
            }
        });
    }
    
    createParameterCard(param, data, isStatus = false) {
        // Create the column wrapper - using same sizing as index.html
        const colDiv = document.createElement('div');
        colDiv.className = 'col-md-3';
        
        // Create the stats card
        const cardDiv = document.createElement('div');
        cardDiv.className = 'stats-card';
        
        // Get parameter details
        const friendlyName = this.getParameterFriendlyName(param);
        let displayValue = '';
        let subtitle = '';
        let iconClass = '';
        let iconColor = 'bg-primary';
        
        if (isStatus) {
            const statusText = this.interpretStatusValue(data.value, param);
            displayValue = statusText;
            subtitle = 'Status';
            
            // Set icon and color based on parameter type and status
            if (param.includes('Input') || param.includes('Rectifier')) {
                iconClass = 'fas fa-power-off';
                iconColor = statusText === 'Normal' ? 'bg-success' : 'bg-danger';
            } else if (param.includes('Battery')) {
                iconClass = 'fas fa-battery-half';
                iconColor = (statusText === 'Normal' || statusText === 'Connected' || statusText === 'Not Discharging') ? 'bg-success' : 'bg-warning';
            } else if (param.includes('Fuse')) {
                iconClass = 'fas fa-shield-alt';
                iconColor = statusText === 'Normal' ? 'bg-success' : 'bg-danger';
            } else if (param.includes('Door')) {
                iconClass = 'fas fa-door-open';
                iconColor = statusText === 'Closed' ? 'bg-success' : 'bg-warning';
            } else {
                iconClass = 'fas fa-exclamation-triangle';
                iconColor = statusText === 'Normal' ? 'bg-success' : 'bg-warning';
            }
        } else {
            displayValue = `${data.value} ${data.unit || ''}`;
            
            // Set icon and subtitle based on parameter type  
            if (param === 'hwRectACVoltage') {
                iconClass = 'fas fa-bolt';
                iconColor = 'bg-warning';
                subtitle = 'Volts AC';
            } else if (param === 'hwBatteryVoltage') {
                iconClass = 'fas fa-battery-half';
                iconColor = 'bg-success';
                subtitle = 'Volts DC';
            } else if (param === 'hwRectifierTemperature') {
                iconClass = 'fas fa-thermometer-half';
                iconColor = 'bg-info';
                subtitle = 'Celsius';
            } else {
                iconClass = 'fas fa-tachometer-alt';
                iconColor = 'bg-primary';
                subtitle = 'Value';
            }
        }
        
        cardDiv.innerHTML = `
            <div class="stats-card-header">
                <h6 class="stats-card-title">${friendlyName}</h6>
                <div class="stats-card-icon ${iconColor}">
                    <i class="${iconClass}"></i>
                </div>
            </div>
            <h3 class="stats-card-value">${displayValue}</h3>
            <p class="stats-card-subtitle">${subtitle}</p>
        `;
        
        colDiv.appendChild(cardDiv);
        return colDiv;
    }
    
    getParameterFriendlyName(param) {
        const names = {
            'hwRectACVoltage': 'AC Input Voltage',
            'hwBatteryVoltage': 'Battery Voltage',
            'hwRectifierTemperature': 'Temperature',
            'hwAcInputStatus': 'AC Input Status',
            'hwRectifierStatus': 'Rectifier Status',
            'hwBatteryDischarge': 'Battery Discharge',
            'hwBatteryLowVoltage': 'Low Voltage Alarm',
            'hwBatteryUltraLowVoltage': 'Ultra Low Voltage',
            'hwBatteryDisconnect': 'Battery Connection',
            'hwFuseBroken': 'Fuse Status',
            'hwLoadFuseAlarmTraps': 'Load Fuse Alarm',
            'hwTcucDoorOpenAlarmTraps': 'Door Status',
            'hwEsduDoorOpenAlarmTraps': 'ESDU Door Status'
        };
        
        return names[param] || param;
    }
    
    interpretStatusValue(value, param) {
        // Convert numeric status values to meaningful text
        const numericValue = parseInt(value);
        
        const statusMappings = {
            'hwAcInputStatus': { 0: 'No Alarm', 1: 'Alarm' },
            'hwRectifierStatus': { 0: 'No Alarm', 1: 'Alarm' },
            'hwBatteryDischarge': { 0: 'No Alarm', 1: 'Alarm' },
            'hwBatteryLowVoltage': { 0: 'No Alarm', 1: 'Alarm' },
            'hwBatteryUltraLowVoltage': { 0: 'No Alarm', 1: 'Alarm' },
            'hwBatteryDisconnect': { 0: 'No Alarm', 1: 'Alarm' },
            'hwFuseBroken': { 0: 'No Alarm', 1: 'Alarm' },
            'hwLoadFuseAlarmTraps': { 0: 'No Alarm', 1: 'Alarm' },
            'hwTcucDoorOpenAlarmTraps': { 0: 'Closed', 1: 'Open' },
            'hwEsduDoorOpenAlarmTraps': { 0: 'Closed', 1: 'Open' }
        };
        
        if (statusMappings[param] && statusMappings[param][numericValue] !== undefined) {
            return statusMappings[param][numericValue];
        }
        
        return value.toString();
    }
    
    getStatusClass(statusText) {
        // Determine CSS class based on status text
        const normalStatuses = ['Normal', 'Connected', 'Not Discharging', 'Closed'];
        const warningStatuses = ['Discharging', 'Unknown'];
        const errorStatuses = ['Fault', 'Broken', 'Disconnected', 'Low Voltage', 'Ultra Low Voltage', 'Alarm', 'Open', 'Abnormal'];
        
        if (normalStatuses.includes(statusText)) {
            return 'normal';
        } else if (warningStatuses.includes(statusText)) {
            return 'warning';
        } else if (errorStatuses.includes(statusText)) {
            return 'error';
        }
        
        return 'normal';
    }
    
    updateConnectionStatus(status, type) {
        // Connection status can be shown in console or as a toast notification
        console.log(`Connection Status: ${status}`);
    }
    
    showError(message) {
        console.error('Rectifier Monitor Error:', message);
        // You can implement toast notifications here if needed
    }
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
    new RectifierMonitor();
});
</script>
{% endblock %}