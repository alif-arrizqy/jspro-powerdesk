{% extends 'modern-layout.html' %}

{% block title %}Rectifier Monitoring - JSPro PowerDesk{% endblock %}

{% block breadcrumbs %}
<i class="fas fa-battery-three-quarters"></i>
Rectifier Monitoring
{% endblock %}

{% block content %}
<div class="content-area">
    <div class="rectifier-monitor-container">
        <!-- Page Header dengan card -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="modern-card">
                    <div class="modern-card-header">
                        <h4 class="modern-card-title mb-1">
                            <i class="fas fa-battery-three-quarters text-primary me-2"></i>
                            Rectifier System Monitoring
                        </h4>
                        <p class="text-muted mb-0">
                            Real-time monitoring of Huawei rectifier sistem via SNMP
                        </p>
                    </div>
                    <div class="modern-card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted" id="lastUpdate">
                                Last update: Never
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Statistics Overview - menggunakan style yang konsisten -->
        <div class="monitor-stats">
            <div class="stat-item">
                <div class="stat-value text-success" id="successCount">0</div>
                <div class="stat-label">Successful</div>
            </div>
            <div class="stat-item">
                <div class="stat-value text-danger" id="errorCount">0</div>
                <div class="stat-label">Failed</div>
            </div>
            <div class="stat-item">
                <div class="stat-value text-info" id="totalCount">13</div>
                <div class="stat-label">Total OIDs</div>
            </div>
            <div class="stat-item">
                <div class="stat-value text-warning" id="deviceStatus">Unknown</div>
                <div class="stat-label">Device Status</div>
            </div>
        </div>

        <!-- Control Panel Card - menggunakan modern-card -->
        <div class="modern-card mb-4">
            <div class="modern-card-header">
                <h6 class="modern-card-title mb-0">
                    <i class="fas fa-cogs me-2"></i>
                    Rectifier Configuration
                </h6>
            </div>
            <div class="modern-card-body">
                <div class="monitor-controls">
                    <div class="ip-config">
                        <div class="d-flex align-items-center gap-2 mb-2 mb-md-0">
                            <label for="targetIp" class="form-label">Target IP:</label>
                            <input type="text" id="targetIp" class="form-control form-control-sm" 
                                   value="{{ config.rectifier_config.host }}" 
                                   placeholder="Enter device IP" style="width: 160px;">
                        </div>
                        <div class="d-flex align-items-center gap-2 mb-2 mb-md-0">
                            <label for="targetPort" class="form-label">Port:</label>
                            <input type="number" id="targetPort" class="form-control form-control-sm" 
                                   value="{{ config.rectifier_config.port}}" 
                                   placeholder="161" style="width: 100px;">
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            <label for="community" class="form-label">Community:</label>
                            <input type="text" id="community" class="form-control form-control-sm" 
                                   value="public" placeholder="public" style="width: 120px;">
                        </div>
                    </div>
                    <div class="refresh-controls">
                        <div class="d-flex align-items-center gap-2">
                            <label for="refreshInterval" class="form-label">Refresh:</label>
                            <select id="refreshInterval" class="form-select form-select-sm" style="width: auto;">
                                <option value="5">5s</option>
                                <option value="10" selected>10s</option>
                                <option value="30">30s</option>
                                <option value="60">60s</option>
                            </select>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="autoRefresh" checked>
                            <label class="form-check-label" for="autoRefresh">
                                Auto Refresh
                                <span class="auto-refresh-indicator ms-1"></span>
                            </label>
                        </div>
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-primary btn-sm" id="refreshNow">
                                <i class="fas fa-sync-alt me-1"></i> Refresh
                            </button>
                            <button type="button" class="btn btn-success btn-sm" id="saveConfig">
                                <i class="fas fa-save me-1"></i> Save
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#exportModal">
                                <i class="fas fa-download me-1"></i> Export
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Rectifier Monitoring Grid -->
        <div class="monitor-grid" id="rectifierGrid">
            <!-- Grid akan dibuat oleh JavaScript -->
        </div>

        <!-- Loading Indicator -->
        <div class="text-center py-5" id="loadingIndicator" style="display: none;">
            <div class="spinner-border text-primary me-2" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <span>Loading rectifier data...</span>
        </div>
    </div>
</div>

<!-- Rectifier Data Export Modal -->
<div class="modal fade" id="exportModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Export Rectifier Data</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="exportFormat" class="form-label">Export Format</label>
                    <select class="form-select" id="exportFormat">
                        <option value="json">JSON</option>
                        <option value="csv">CSV</option>
                        <option value="txt">Text</option>
                    </select>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="includeTimestamp" checked>
                    <label class="form-check-label" for="includeTimestamp">
                        Include timestamp
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="downloadExport">Download</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// API Configuration
const API_BASE_URL = '/api/v1/service';
const RECTIFIER_API_URL = '/api/v1/service/snmp-rectifier';

class RectifierMonitor {
    constructor() {
        this.rectifierOids = [
            {
                oid: '.1.3.6.1.4.1.2011.6.164.1.3.2.2.1.6',
                name: 'hwRectACVoltage',
                label: 'AC Voltage',
                unit: 'V',
                description: 'AC input voltage measurement'
            },
            {
                oid: '.1.3.6.1.4.1.2011.6.164.1.4.2.12',
                name: 'hwBatteryVoltage',
                label: 'Battery Voltage',
                unit: 'V',
                description: 'Battery voltage measurement'
            },
            {
                oid: '.1.3.6.1.4.1.2011.6.164.1.1.3.1',
                name: 'hwAcInputStatus',
                label: 'AC Input Status',
                unit: '',
                description: 'AC input status indicator'
            },
            {
                oid: '.1.3.6.1.4.1.2011.6.164.1.1.3.2',
                name: 'hwRectifierStatus',
                label: 'Rectifier Status',
                unit: '',
                description: 'Overall rectifier status'
            },
            {
                oid: '.1.3.6.1.4.1.2011.6.164.1.1.3.3',
                name: 'hwBatteryDischarge',
                label: 'Battery Discharge',
                unit: '',
                description: 'Battery discharge status'
            },
            {
                oid: '.1.3.6.1.4.1.2011.6.164.1.1.3.4',
                name: 'hwBatteryLowVoltage',
                label: 'Battery Low Voltage',
                unit: '',
                description: 'Battery low voltage alarm'
            },
            {
                oid: '.1.3.6.1.4.1.2011.6.164.1.1.3.5',
                name: 'hwBatteryUltraLowVoltage',
                label: 'Battery Ultra Low Voltage',
                unit: '',
                description: 'Battery ultra low voltage alarm'
            },
            {
                oid: '.1.3.6.1.4.1.2011.6.164.1.1.3.6',
                name: 'hwBatteryDisconnect',
                label: 'Battery Disconnect',
                unit: '',
                description: 'Battery disconnect status'
            },
            {
                oid: '.1.3.6.1.4.1.2011.6.164.1.1.3.7',
                name: 'hwFuseBroken',
                label: 'Fuse Broken',
                unit: '',
                description: 'Fuse broken alarm status'
            },
            {
                oid: '.1.3.6.1.4.1.2011.6.164.1.3.2.2.1.8',
                name: 'hwRectifierTemperature',
                label: 'Temperature',
                unit: '°C',
                description: 'Rectifier temperature'
            },
            {
                oid: '.1.3.6.1.4.1.2011.6.164.2.1.0.23',
                name: 'hwLoadFuseAlarmTraps',
                label: 'Load Fuse Alarm',
                unit: '',
                description: 'Load fuse alarm traps'
            },
            {
                oid: '.1.3.6.1.4.1.2011.6.164.2.1.0.139',
                name: 'hwTcucDoorOpenAlarmTraps',
                label: 'TCUC Door Alarm',
                unit: '',
                description: 'TCUC door open alarm'
            },
            {
                oid: '.1.3.6.1.4.1.2011.6.164.2.1.0.149',
                name: 'hwEsduDoorOpenAlarmTraps',
                label: 'ESDU Door Alarm',
                unit: '',
                description: 'ESDU door open alarm'
            }
        ];
        
        this.refreshInterval = null;
        this.lastUpdateTime = null;
        this.rectifierData = {};
        
        this.init();
    }
    
    init() {
        this.createGrid();
        this.bindEvents();
        this.startAutoRefresh();
        this.refreshData();
    }
    
    createGrid() {
        const grid = document.getElementById('rectifierGrid');
        grid.innerHTML = '';
        
        this.rectifierOids.forEach(item => {
            const card = document.createElement('div');
            card.className = 'snmp-item';
            card.id = `rectifier-${item.name}`;
            card.innerHTML = `
                <div class="snmp-label">${item.label}</div>
                <div class="snmp-oid">OID: ${item.oid}</div>
                <div class="snmp-value" id="value-${item.name}">--</div>
                <div class="snmp-status" id="status-${item.name}">
                    <span class="snmp-status-indicator loading"></span>
                    <span>${item.description}</span>
                </div>
            `;
            grid.appendChild(card);
        });
    }
    
    bindEvents() {
        // Refresh button
        document.getElementById('refreshNow').addEventListener('click', () => {
            this.refreshData();
        });
        
        // Save config button
        document.getElementById('saveConfig').addEventListener('click', () => {
            this.saveConfiguration();
        });
        
        // Auto refresh toggle
        document.getElementById('autoRefresh').addEventListener('change', (e) => {
            if (e.target.checked) {
                this.startAutoRefresh();
            } else {
                this.stopAutoRefresh();
            }
        });
        
        // Refresh interval change
        document.getElementById('refreshInterval').addEventListener('change', () => {
            if (document.getElementById('autoRefresh').checked) {
                this.startAutoRefresh();
            }
        });
        
        // IP address change
        document.getElementById('targetIp').addEventListener('change', () => {
            this.refreshData();
        });
        
        // Port change
        document.getElementById('targetPort').addEventListener('change', () => {
            this.refreshData();
        });
        
        // Community change
        document.getElementById('community').addEventListener('change', () => {
            this.refreshData();
        });
        
        // Export functionality
        const exportButton = document.getElementById('exportData');
        if (exportButton) {
            exportButton.addEventListener('click', () => {
                const modal = new bootstrap.Modal(document.getElementById('exportModal'));
                modal.show();
            });
        }
        
        document.getElementById('downloadExport').addEventListener('click', () => {
            this.exportData();
        });
    }
    
    startAutoRefresh() {
        this.stopAutoRefresh();
        const interval = parseInt(document.getElementById('refreshInterval').value) * 1000;
        
        this.refreshInterval = setInterval(() => {
            this.refreshData();
        }, interval);
        
        // Update auto refresh indicator
        this.updateAutoRefreshIndicator();
    }
    
    stopAutoRefresh() {
        if (this.refreshInterval) {
            clearInterval(this.refreshInterval);
            this.refreshInterval = null;
        }
    }
    
    updateAutoRefreshIndicator() {
        const indicator = document.querySelector('.auto-refresh-indicator');
        if (!indicator) return;
        
        if (this.refreshInterval) {
            const interval = parseInt(document.getElementById('refreshInterval').value);
            indicator.innerHTML = `<span class="badge bg-success"><i class="fas fa-sync-alt fa-spin"></i> ${interval}s</span>`;
        } else {
            indicator.innerHTML = '<span class="badge bg-secondary">Disabled</span>';
        }
    }
    
    async refreshData() {
        const targetIp = document.getElementById('targetIp').value;
        const targetPort = parseInt(document.getElementById('targetPort').value) || 161;
        const community = document.getElementById('community').value;
        const userToken = '{{ session.get("auth_token", "") }}';
        
        if (!targetIp || !community) {
            this.showError('Please provide IP address and community string');
            return;
        }
        
        // Show loading indicator
        document.getElementById('loadingIndicator').style.display = 'block';
        
        let successCount = 0;
        let errorCount = 0;
        
        // Process each OID
        for (const item of this.rectifierOids) {
            try {
                const response = await fetch(`${RECTIFIER_API_URL}/get`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${userToken}`
                    },
                    body: JSON.stringify({
                        ip: targetIp,
                        port: targetPort,
                        community: community,
                        oid: item.oid,
                        version: '1',
                        timeout: 10
                    })
                });
                
                const data = await response.json();
                
                if (data.success && data.value !== null) {
                    this.updateCard(item, data.value, true);
                    successCount++;
                } else {
                    this.updateCard(item, null, false, data.error || 'Unknown error');
                    errorCount++;
                }
            } catch (error) {
                console.error(`Error fetching ${item.name}:`, error);
                this.updateCard(item, null, false, error.message);
                errorCount++;
            }
        }
        
        // Update statistics
        this.updateStatistics(successCount, errorCount);
        
        // Hide loading indicator
        document.getElementById('loadingIndicator').style.display = 'none';
        
        this.lastUpdateTime = new Date();
    }
    
    updateCard(item, value, success, error = null) {
        const card = document.getElementById(`rectifier-${item.name}`);
        const valueElement = document.getElementById(`value-${item.name}`);
        const statusElement = document.getElementById(`status-${item.name}`);
        
        // Remove loading class
        card.classList.remove('loading');
        
        if (success && value !== null) {
            statusElement.innerHTML = `
                <span class="snmp-status-indicator success"></span>
                <span>Connected</span>
            `;
            card.classList.remove('error');
            card.classList.add('success');
            
            // Format nilai berdasarkan tipe data
            if (item.unit === 'V' || item.unit === '°C') {
                valueElement.innerHTML = `${parseFloat(value).toFixed(2)} ${item.unit}`;
            } else {
                valueElement.textContent = this.interpretStatusValue(value, item.name);
            }
            
            // Store data
            this.rectifierData[item.name] = {
                value: value,
                timestamp: new Date().toISOString(),
                oid: item.oid,
                unit: item.unit
            };
        } else {
            statusElement.innerHTML = `
                <span class="snmp-status-indicator error"></span>
                <span>Error</span>
            `;
            valueElement.textContent = 'Error';
            card.classList.remove('success');
            card.classList.add('error');
            card.title = error || 'Unknown error';
        }
    }
    
    interpretStatusValue(value, name) {
        // Interpretasi nilai status untuk berbagai parameter
        const statusMappings = {
            'hwAcInputStatus': { '1': 'Normal', '2': 'Abnormal', '0': 'Unknown' },
            'hwRectifierStatus': { '1': 'Normal', '2': 'Fault', '0': 'Unknown' },
            'hwBatteryDischarge': { '1': 'Discharging', '2': 'Not Discharging', '0': 'Unknown' },
            'hwBatteryLowVoltage': { '1': 'Normal', '2': 'Low Voltage', '0': 'Unknown' },
            'hwBatteryUltraLowVoltage': { '1': 'Normal', '2': 'Ultra Low', '0': 'Unknown' },
            'hwBatteryDisconnect': { '1': 'Connected', '2': 'Disconnected', '0': 'Unknown' },
            'hwFuseBroken': { '1': 'Normal', '2': 'Broken', '0': 'Unknown' }
        };
        
        if (statusMappings[name] && statusMappings[name][value.toString()]) {
            return statusMappings[name][value.toString()];
        }
        
        return value.toString();
    }
    
    updateStatistics(successCount, errorCount) {
        document.getElementById('successCount').textContent = successCount;
        document.getElementById('errorCount').textContent = errorCount;
        document.getElementById('totalCount').textContent = this.rectifierOids.length;
        
        if (this.lastUpdateTime) {
            const lastUpdateElement = document.getElementById('lastUpdate');
            if (lastUpdateElement) {
                lastUpdateElement.textContent = `Last update: ${this.lastUpdateTime.toLocaleTimeString()}`;
            }
        }  
    }
    
    async saveConfiguration() {
        const config = {
            host: document.getElementById('targetIp').value,
            port: parseInt(document.getElementById('targetPort').value) || 161
        };
        
        try {
            const response = await fetch('/update-rectifier-config', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer {{ session.get("auth_token", "") }}`
                },
                body: JSON.stringify(config)
            });
            
            const result = await response.json();
            
            if (result.success) {
                this.showSuccess('Rectifier configuration saved successfully');
            } else {
                this.showError('Failed to save configuration: ' + result.error);
            }
        } catch (error) {
            this.showError('Error saving configuration: ' + error.message);
        }
    }
    
    exportData() {
        const format = document.getElementById('exportFormat').value;
        const includeTimestamp = document.getElementById('includeTimestamp').checked;
        
        let exportData = { ...this.rectifierData };
        
        if (!includeTimestamp) {
            Object.keys(exportData).forEach(key => {
                delete exportData[key].timestamp;
            });
        }
        
        let content, filename, mimeType;
        
        switch (format) {
            case 'json':
                content = JSON.stringify(exportData, null, 2);
                filename = `rectifier_data_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.json`;
                mimeType = 'application/json';
                break;
            case 'csv':
                const headers = ['Parameter', 'Value', 'Unit', 'OID'];
                if (includeTimestamp) headers.push('Timestamp');
                
                const rows = [headers.join(',')];
                Object.entries(exportData).forEach(([key, data]) => {
                    const row = [key, data.value, data.unit, data.oid];
                    if (includeTimestamp) row.push(data.timestamp);
                    rows.push(row.join(','));
                });
                
                content = rows.join('\n');
                filename = `rectifier_data_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.csv`;
                mimeType = 'text/csv';
                break;
            case 'txt':
                const lines = ['RECTIFIER MONITORING DATA', '='.repeat(30), ''];
                Object.entries(exportData).forEach(([key, data]) => {
                    lines.push(`${key}: ${data.value} ${data.unit}`);
                    lines.push(`OID: ${data.oid}`);
                    if (includeTimestamp) lines.push(`Timestamp: ${data.timestamp}`);
                    lines.push('');
                });
                
                content = lines.join('\n');
                filename = `rectifier_data_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.txt`;
                mimeType = 'text/plain';
                break;
        }
        
        // Download file
        const blob = new Blob([content], { type: mimeType });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        // Close modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('exportModal'));
        modal.hide();
    }
    
    showError(message) {
        // Implementasi toast notification bisa ditambahkan di sini
        console.error('Rectifier Monitor Error:', message);
        alert('Error: ' + message);
    }
    
    showSuccess(message) {
        // Implementasi toast notification bisa ditambahkan di sini
        console.log('Rectifier Monitor Success:', message);
        alert('Success: ' + message);
    }
}

// Initialize Rectifier Monitor when page loads
document.addEventListener('DOMContentLoaded', function() {
    new RectifierMonitor();
});
</script>
{% endblock %}
