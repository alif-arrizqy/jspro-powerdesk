{% extends 'modern-layout.html' %}
{% block breadcrumbs %}SCC Monitoring - {{ scc_type.upper().replace('-', ' ') }}{% endblock breadcrumbs %}

{% block content %}
<!-- SCC Overview Header -->
<div class="row mb-4">
    <div class="col-12">
        <div class="modern-card">
            <div class="modern-card-header">
                <h2 class="modern-card-title">
                    <i class="fas fa-solar-panel"></i>
                    Solar Charge Controller Monitoring
                </h2>
                <div class="d-flex align-items-center">
                    <span class="badge bg-primary me-2">{{ scc_type.upper().replace('-', ' ') }}</span>
                    <span class="text-muted">{{ site_name }} | {{ ip_address }}</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- SCC Relay Configuration -->
<div class="row mb-4">
    <div class="col-12">
        <div class="modern-card">
            <div class="modern-card-header">
                <h5 class="modern-card-title">
                    <i class="fas fa-chart-bar text-info me-2"></i>
                    SCC Relay Configuration
                </h5>
            </div>
            <div class="modern-card-body">
                <div class="row g-4">
                    <div class="col-lg-3 col-md-6">
                        <div class="stats-card">
                            <div class="stats-card-header">
                                <h6 class="stats-card-title">Vsat Reconnect</h6>
                                <div class="stats-card-icon bg-success">
                                    <i class="fas fa-satellite"></i>
                                </div>
                            </div>
                            <h3 class="stats-card-value">4700</h3>
                            <p class="stats-card-subtitle">
                                <i class="fas fa-arrow-up me-2"></i>
                                Vsat Reconnect (mV)
                            </p>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <div class="stats-card">
                            <div class="stats-card-header">
                                <h6 class="stats-card-title">Vsat Cut Off</h6>
                                <div class="stats-card-icon bg-success">
                                    <i class="fas fa-satellite"></i>
                                </div>
                            </div>
                            <h3 class="stats-card-value">4600</h3>
                            <p class="stats-card-subtitle">
                                <i class="fas fa-arrow-down me-2"></i>
                                Vsat Cut Off (mV)
                            </p>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <div class="stats-card">
                            <div class="stats-card-header">
                                <h6 class="stats-card-title">BTS Reconnect</h6>
                                <div class="stats-card-icon bg-primary">
                                    <i class="fas fa-broadcast-tower"></i>
                                </div>
                            </div>
                            <h3 class="stats-card-value">4900</h3>
                            <p class="stats-card-subtitle">
                                <i class="fas fa-arrow-up me-2"></i>
                                BTS Reconnect (mV)
                            </p>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <div class="stats-card">
                            <div class="stats-card-header">
                                <h6 class="stats-card-title">BTS Cut Off</h6>
                                <div class="stats-card-icon bg-primary">
                                    <i class="fas fa-broadcast-tower"></i>
                                </div>
                            </div>
                            <h3 class="stats-card-value">4800</h3>
                            <p class="stats-card-subtitle">
                                <i class="fas fa-arrow-down me-2"></i>
                                BTS Cut Off (mV)
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- SCC Real-time Data -->
<div class="row g-4">
    {% for i in range(1, number_of_scc+1) %}
    {% if number_of_scc == 2 %}
    <div class="col-lg-6">
    {% elif number_of_scc == 3 %}
    <div class="col-xl-4 col-lg-6 col-md-12">
    {% else %}
    <div class="col-xl-3 col-lg-4 col-md-6 col-sm-12">
    {% endif %}
        <div class="modern-card h-100">
            <div class="modern-card-header">
                <h3 class="modern-card-title">
                    <i class="fas fa-solar-panel"></i>
                    SCC {{i}} Status
                </h3>
                <div class="d-flex align-items-center flex-wrap">
                    <i class="fas fa-info-circle text-primary me-2"></i>
                    <span class="text-muted small" id="scc{{i}}-device-id">SCC ID: Loading...</span>
                    <span class="text-muted mx-1">|</span>
                    <i class="fas fa-heartbeat text-danger me-1"></i>
                    <span class="text-muted small" id="scc{{i}}-counter-heartbeat">Heartbeat: Loading...</span>
                    <span class="text-muted mx-1">|</span>
                    <i class="fas fa-clock text-info me-1"></i>
                    <span class="text-muted small" id="last-update-{{i}}">Last Update: Loading...</span>
                </div>
            </div>
            <div class="modern-card-body">
                <div class="row g-2">
                    <!-- SCC Status -->
                    <div class="col-6">
                        <div class="stats-card">
                            <div class="stats-card-header">
                                <h6 class="stats-card-title small">Controller Status</h6>
                                <div class="stats-card-icon bg-primary">
                                    <i class="fas fa-power-off"></i>
                                </div>
                            </div>
                            <h5 class="stats-card-value">
                                <span class="status-indicator" id="scc{{i}}-status">Loading...</span>
                            </h5>
                            <p class="stats-card-subtitle small">Operation Mode</p>
                        </div>
                    </div>
                    
                    <!-- PV Voltage -->
                    <div class="col-6">
                        <div class="stats-card">
                            <div class="stats-card-header">
                                <h6 class="stats-card-title small">PV {{i}} Voltage</h6>
                                <div class="stats-card-icon bg-success">
                                    <i class="fas fa-sun"></i>
                                </div>
                            </div>
                            <h5 class="stats-card-value" id="pv{{i}}-voltage">Loading...</h5>
                            <p class="stats-card-subtitle small">Solar Input</p>
                        </div>
                    </div>
                    
                    <!-- PV Current -->
                    <div class="col-6">
                        <div class="stats-card">
                            <div class="stats-card-header">
                                <h6 class="stats-card-title small">PV {{i}} Current</h6>
                                <div class="stats-card-icon bg-info">
                                    <i class="fas fa-tachometer-alt"></i>
                                </div>
                            </div>
                            <h5 class="stats-card-value" id="pv{{i}}-current">Loading...</h5>
                            <p class="stats-card-subtitle small">Charging Input</p>
                        </div>
                    </div>
                    
                    <!-- Load Voltage -->
                    <div class="col-6">
                        <div class="stats-card">
                            <div class="stats-card-header">
                                <h6 class="stats-card-title small">Load Voltage</h6>
                                <div class="stats-card-icon bg-info">
                                    <i class="fas fa-plug"></i>
                                </div>
                            </div>
                            <h5 class="stats-card-value" id="load{{i}}-voltage">Loading...</h5>
                            <p class="stats-card-subtitle small">Output Voltage</p>
                        </div>
                    </div>
                    
                    <!-- Load Current -->
                    <div class="col-6">
                        <div class="stats-card">
                            <div class="stats-card-header">
                                <h6 class="stats-card-title small">Load Current</h6>
                                <div class="stats-card-icon bg-primary">
                                    <i class="fas fa-arrow-left"></i>
                                </div>
                            </div>
                            <h5 class="stats-card-value" id="load{{i}}-current">Loading...</h5>
                            <p class="stats-card-subtitle small">Output Current</p>
                        </div>
                    </div>

                    <!-- Load Power -->
                    <div class="col-6">
                        <div class="stats-card">
                            <div class="stats-card-header">
                                <h6 class="stats-card-title small">Load Power</h6>
                                <div class="stats-card-icon bg-warning">
                                    <i class="fas fa-bolt"></i>
                                </div>
                            </div>
                            <h5 class="stats-card-value" id="load{{i}}-power">Loading...</h5>
                            <p class="stats-card-subtitle small">Total Power</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Power Generation Chart -->
<div class="row mt-4">
    <div class="col-12">
        <div class="modern-card">
            <div class="modern-card-header">
                <h3 class="modern-card-title">
                    <i class="fas fa-chart-line"></i>
                    Power Generation Trend
                </h3>
            </div>
            <div class="modern-card-body">
                <div class="chart-container">
                    <canvas id="powerChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- SCC Parameters & Alarms -->
<div class="row mt-4">
    <div class="col-12">
        <div class="modern-card">
            <div class="modern-card-header">
                <h3 class="modern-card-title">
                    <i class="fas fa-exclamation-triangle"></i>
                    SCC Status & Alarms
                </h3>
            </div>
            <div class="modern-card-body">
                <div class="row g-3">
                    {% for i in range(1, number_of_scc+1) %}
                    <div class="col-md-6">
                        <div class="modern-card">
                            <div class="modern-card-header">
                                <h5 class="modern-card-title">SCC {{i}} Alarm Status</h5>
                            </div>
                            <div class="modern-card-body">
                                <!-- SCC-SRNE Alarms -->
                                {% if scc_type == 'scc-srne' %}
                                <div class="alert alert-info mb-3">
                                    <h6><i class="fas fa-shield-alt"></i> Protection Status</h6>
                                    <div id="scc{{i}}-alarm-summary" class="fw-bold">Checking alarms...</div>
                                </div>

                                <!-- SRNE Additional Data -->
                                <div class="mb-3">
                                    <h6 class="text-primary"><i class="fas fa-info-circle"></i> System Information</h6>
                                    <div class="row g-2">
                                        <div class="col-6">
                                            <small class="text-muted">Battery Temperature</small>
                                            <div><span id="scc{{i}}-battery-temp" class="badge bg-info">Loading...</span></div>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted">Controller Temperature</small>
                                            <div><span id="scc{{i}}-controller-temp" class="badge bg-info">Loading...</span></div>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted">Charging Mode</small>
                                            <div><span id="scc{{i}}-charging-mode" class="badge bg-success">Loading...</span></div>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted">Battery Type</small>
                                            <div><span id="scc{{i}}-battery-type" class="badge bg-secondary">Loading...</span></div>
                                        </div>
                                    </div>
                                </div>

                                <div class="table-responsive">
                                    <table class="modern-table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Protection Type</th>
                                                <th>Status</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td>Battery High Temp Protection 1</td>
                                                <td><span id="scc{{i}}-batt-hi-temp-1" class="badge">-</span></td>
                                            </tr>
                                            <tr>
                                                <td>Battery High Temp Protection 2</td>
                                                <td><span id="scc{{i}}-batt-hi-temp-2" class="badge">-</span></td>
                                            </tr>
                                            <tr>
                                                <td>Battery Low Temp Protection 1</td>
                                                <td><span id="scc{{i}}-batt-lo-temp-1" class="badge">-</span></td>
                                            </tr>
                                            <tr>
                                                <td>Battery Low Temp Protection 2</td>
                                                <td><span id="scc{{i}}-batt-lo-temp-2" class="badge">-</span></td>
                                            </tr>
                                            <tr>
                                                <td>Battery Over Discharge</td>
                                                <td><span id="scc{{i}}-batt-overdisc" class="badge">-</span></td>
                                            </tr>
                                            <tr>
                                                <td>Battery Overvoltage</td>
                                                <td><span id="scc{{i}}-batt-overvolt" class="badge">-</span></td>
                                            </tr>
                                            <tr>
                                                <td>Battery Reversed</td>
                                                <td><span id="scc{{i}}-batt-reversed" class="badge">-</span></td>
                                            </tr>
                                            <tr>
                                                <td>Battery Undervoltage</td>
                                                <td><span id="scc{{i}}-batt-undervolt" class="badge">-</span></td>
                                            </tr>
                                            <tr>
                                                <td>Controller High Temperature</td>
                                                <td><span id="scc{{i}}-controller-temp-high" class="badge">-</span></td>
                                            </tr>
                                            <tr>
                                                <td>Load Over Current/Power</td>
                                                <td><span id="scc{{i}}-load-over-current" class="badge">-</span></td>
                                            </tr>
                                            <tr>
                                                <td>PV Input Overpower</td>
                                                <td><span id="scc{{i}}-pv-overpower" class="badge">-</span></td>
                                            </tr>
                                            <tr>
                                                <td>PV Input Overvoltage</td>
                                                <td><span id="scc{{i}}-pv-overvolt" class="badge">-</span></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                {% endif %}

                                <!-- SCC-EPVEPER Alarms -->
                                {% if scc_type == 'scc-epveper' %}
                                <div class="alert alert-info mb-3">
                                    <h6><i class="fas fa-shield-alt"></i> System Status</h6>
                                    <div id="scc{{i}}-alarm-summary" class="fw-bold">Checking status...</div>
                                </div>
                                
                                <!-- Battery Status -->
                                <div class="mb-3">
                                    <h6 class="text-primary"><i class="fas fa-battery-half"></i> Battery Status</h6>
                                    <div class="row g-2">
                                        <div class="col-6">
                                            <small class="text-muted">Battery Condition</small>
                                            <div><span id="scc{{i}}-battery-condition" class="badge">-</span></div>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted">Battery Identification</small>
                                            <div><span id="scc{{i}}-battery-identification" class="badge">-</span></div>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted">Battery Resistance</small>
                                            <div><span id="scc{{i}}-battery-resistance" class="badge">-</span></div>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted">Battery Temperature</small>
                                            <div><span id="scc{{i}}-battery-temperature" class="badge">-</span></div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Charging Status -->
                                <div class="mb-3">
                                    <h6 class="text-success"><i class="fas fa-arrow-up"></i> Charging Status</h6>
                                    <div class="row g-2">
                                        <div class="col-4">
                                            <small class="text-muted">Anti Reverse MOSFET</small>
                                            <div><span id="scc{{i}}-anti-reverse-mosfet" class="badge">-</span></div>
                                        </div>
                                        <div class="col-4">
                                            <small class="text-muted">Charging Anti Reverse MOSFET</small>
                                            <div><span id="scc{{i}}-charging-anti-reverse-mosfet" class="badge">-</span></div>
                                        </div>
                                        <div class="col-4">
                                            <small class="text-muted">Charging Condition</small>
                                            <div><span id="scc{{i}}-charging-condition" class="badge">-</span></div>
                                        </div>
                                        <div class="col-4">
                                            <small class="text-muted">Charging MOSFET Short</small>
                                            <div><span id="scc{{i}}-charging-mosfet-short" class="badge">-</span></div>
                                        </div>
                                        <div class="col-4">
                                            <small class="text-muted">Charging State</small>
                                            <div><span id="scc{{i}}-charging-state" class="badge">-</span></div>
                                        </div>
                                        <div class="col-4">
                                            <small class="text-muted">Charging Status</small>
                                            <div><span id="scc{{i}}-charging-status" class="badge">-</span></div>
                                        </div>
                                        <div class="col-4">
                                            <small class="text-muted">Disequilibrium</small>
                                            <div><span id="scc{{i}}-disequilibrium" class="badge">-</span></div>
                                        </div>
                                        <div class="col-4">
                                            <small class="text-muted">Input Over Current</small>
                                            <div><span id="scc{{i}}-input-over-current" class="badge">-</span></div>
                                        </div>
                                        <div class="col-4">
                                            <small class="text-muted">Input Voltage Status</small>
                                            <div><span id="scc{{i}}-input-voltage-status" class="badge">-</span></div>
                                        </div>
                                        <div class="col-4">
                                            <small class="text-muted">Load MOSFET Short</small>
                                            <div><span id="scc{{i}}-load-mosfet-short" class="badge">-</span></div>
                                        </div>
                                        <div class="col-4">
                                            <small class="text-muted">Load Over Current</small>
                                            <div><span id="scc{{i}}-load-over-current" class="badge">-</span></div>
                                        </div>
                                        <div class="col-4">
                                            <small class="text-muted">Load Short</small>
                                            <div><span id="scc{{i}}-load-short" class="badge">-</span></div>
                                        </div>
                                        <div class="col-4">
                                            <small class="text-muted">PV Input Short</small>
                                            <div><span id="scc{{i}}-pv-input-short" class="badge">-</span></div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Discharging Status -->
                                <div class="mb-3">
                                    <h6 class="text-warning"><i class="fas fa-arrow-down"></i> Discharging Status</h6>
                                    <div class="row g-2">
                                        <div class="col-4">
                                            <small class="text-muted">Boost Voltage</small>
                                            <div><span id="scc{{i}}-boost-voltage" class="badge">-</span></div>
                                        </div>
                                        <div class="col-4">
                                            <small class="text-muted">Discharge Short</small>
                                            <div><span id="scc{{i}}-discharge-short" class="badge">-</span></div>
                                        </div>
                                        <div class="col-4">
                                            <small class="text-muted">Discharging Condition</small>
                                            <div><span id="scc{{i}}-discharging-condition" class="badge">-</span></div>
                                        </div>
                                        <div class="col-4">
                                            <small class="text-muted">Discharging Output</small>
                                            <div><span id="scc{{i}}-discharging-output" class="badge">-</span></div>
                                        </div>
                                        <div class="col-4">
                                            <small class="text-muted">Discharging State</small>
                                            <div><span id="scc{{i}}-discharging-state" class="badge">-</span></div>
                                        </div>
                                        <div class="col-4">
                                            <small class="text-muted">High Voltage Side</small>
                                            <div><span id="scc{{i}}-high-voltage-side" class="badge">-</span></div>
                                        </div>
                                        <div class="col-4">
                                            <small class="text-muted">Input Voltage</small>
                                            <div><span id="scc{{i}}-input-voltage" class="badge">-</span></div>
                                        </div>
                                        <div class="col-4">
                                            <small class="text-muted">Output Power</small>
                                            <div><span id="scc{{i}}-output-power" class="badge">-</span></div>
                                        </div>
                                        <div class="col-4">
                                            <small class="text-muted">Output Voltage</small>
                                            <div><span id="scc{{i}}-output-voltage" class="badge">-</span></div>
                                        </div>
                                        <div class="col-4">
                                            <small class="text-muted">Stop Discharging</small>
                                            <div><span id="scc{{i}}-stop-discharging" class="badge">-</span></div>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    // Initialize power generation chart
    document.addEventListener('DOMContentLoaded', function() {
        const ctx = document.getElementById('powerChart');
        if (ctx) {
            // Generate time labels for the last 24 hours
            const generateTimeLabels = () => {
                const labels = [];
                const now = new Date();
                for (let i = 23; i >= 0; i--) {
                    const time = new Date(now.getTime() - i * 60 * 60 * 1000);
                    labels.push(time.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }));
                }
                return labels;
            };

            // Generate realistic dummy data for SCC power generation
            const generatePowerData = (baseValue, variance = 20) => {
                const data = [];
                const now = new Date();
                const currentHour = now.getHours();
                
                for (let i = 23; i >= 0; i--) {
                    const hour = (currentHour - i + 24) % 24;
                    let power = 0;
                    
                    // Simulate solar power generation based on time of day
                    if (hour >= 6 && hour <= 18) {
                        // Daytime power generation (6 AM - 6 PM)
                        const normalizedHour = (hour - 6) / 12; // 0 to 1
                        const solarCurve = Math.sin(normalizedHour * Math.PI); // Bell curve
                        power = baseValue * solarCurve * (0.8 + Math.random() * 0.4);
                    } else {
                        // Nighttime - minimal or no power
                        power = Math.random() * 5; // 0-5W noise
                    }
                    
                    // Add some random variance
                    power += (Math.random() - 0.5) * variance;
                    data.push(Math.max(0, Math.round(power)));
                }
                return data;
            };

            window.powerDeskApp.createChart('powerChart', {
                type: 'line',
                data: {
                    labels: generateTimeLabels(),
                    datasets: [
                        {% for i in range(1, number_of_scc+1) %}
                        {
                            label: 'SCC {{i}} Power (W)',
                            data: generatePowerData({{ 120 + (i * 30) }}, {{ 20 + (i * 5) }}),
                            borderColor: '{% if i == 1 %}rgb(37, 99, 235){% elif i == 2 %}rgb(16, 185, 129){% elif i == 3 %}rgb(245, 101, 101){% elif i == 4 %}rgb(251, 146, 60){% else %}rgb(168, 85, 247){% endif %}',
                            backgroundColor: '{% if i == 1 %}rgba(37, 99, 235, 0.1){% elif i == 2 %}rgba(16, 185, 129, 0.1){% elif i == 3 %}rgba(245, 101, 101, 0.1){% elif i == 4 %}rgba(251, 146, 60, 0.1){% else %}rgba(168, 85, 247, 0.1){% endif %}',
                            tension: 0.4,
                            fill: true,
                            pointRadius: 3,
                            pointHoverRadius: 6
                        }{% if not loop.last %},{% endif %}
                        {% endfor %}
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Power (W)',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)',
                            },
                            ticks: {
                                callback: function(value) {
                                    return value + ' W';
                                }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Time (24 Hours)',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)',
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 20,
                                font: {
                                    size: 12,
                                    weight: 'bold'
                                }
                            }
                        },
                        title: {
                            display: true,
                            text: 'Real-time Solar Power Generation - Last 24 Hours',
                            font: {
                                size: 16,
                                weight: 'bold'
                            },
                            padding: 20
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: 'white',
                            bodyColor: 'white',
                            borderColor: 'rgba(255, 255, 255, 0.1)',
                            borderWidth: 1,
                            cornerRadius: 8,
                            displayColors: true,
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y + ' W';
                                },
                                afterLabel: function(context) {
                                    const total = context.chart.data.datasets.reduce((sum, dataset) => {
                                        return sum + dataset.data[context.dataIndex];
                                    }, 0);
                                    return 'Total: ' + total + ' W';
                                }
                            }
                        }
                    },
                    animation: {
                        duration: 1000,
                        easing: 'easeInOutQuart'
                    }
                }
            });

            // Function to update chart with new data (simulating real-time updates)
            const updateChartData = () => {
                const chart = window.powerDeskApp.getChart('powerChart');
                if (chart) {
                    const now = new Date();
                    const currentHour = now.getHours();
                    const numberOfScc = {{ number_of_scc }};
                    
                    // Generate new data point
                    const generateCurrentPower = (baseValue) => {
                        let power = 0;
                        if (currentHour >= 6 && currentHour <= 18) {
                            const normalizedHour = (currentHour - 6) / 12;
                            const solarCurve = Math.sin(normalizedHour * Math.PI);
                            power = baseValue * solarCurve * (0.8 + Math.random() * 0.4);
                        } else {
                            power = Math.random() * 5;
                        }
                        return Math.max(0, Math.round(power));
                    };
                    
                    // Remove oldest data point and add new one
                    const newTimeLabel = now.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
                    
                    chart.data.labels.shift();
                    chart.data.labels.push(newTimeLabel);
                    
                    // Update data for each SCC dataset
                    for (let i = 0; i < numberOfScc && i < chart.data.datasets.length; i++) {
                        const baseValue = 120 + (i * 30); // Different base values for each SCC
                        chart.data.datasets[i].data.shift();
                        chart.data.datasets[i].data.push(generateCurrentPower(baseValue));
                    }
                    
                    chart.update('none'); // Update without animation for real-time feel
                }
            };

            // Update chart every 30 seconds
            setInterval(updateChartData, 30000);
        }
    });

    // Additional dummy data update function for SCC parameters
    const updateSCCDummyData = () => {
        const now = new Date();
        const currentHour = now.getHours();
        const isDaytime = currentHour >= 6 && currentHour <= 18;
        const numberOfScc = {{ number_of_scc }};
        const sccType = '{{ scc_type }}';
        
        // Update SCC data dynamically based on number_of_scc
        for (let i = 1; i <= numberOfScc; i++) {
            // Device ID
            const deviceIdElement = document.getElementById(`scc${i}-device-id`);
            if (deviceIdElement) {
                const deviceId = sccType === 'scc-srne' ? 
                    `SRNE-${i}-${Math.floor(Math.random() * 999).toString().padStart(3, '0')}` :
                    `EPV-${i}-${Math.floor(Math.random() * 9999).toString().padStart(4, '0')}`;
                deviceIdElement.textContent = `SCC ID: ${deviceId}`;
            }

            // Generate realistic voltage and current based on SCC type
            let pvVoltage, pvCurrent, loadVoltage, loadCurrent;
            
            if (sccType === 'scc-srne') {
                // SRNE typically has different voltage ranges
                pvVoltage = isDaytime ? 
                    (35 + Math.random() * 20).toFixed(1) : // 35-55V during day
                    (5 + Math.random() * 10).toFixed(1);   // 5-15V at night
                    
                pvCurrent = isDaytime ? 
                    (10 + Math.random() * 15).toFixed(2) : // 10-25A during day
                    (0.1 + Math.random() * 1).toFixed(2);  // 0.1-1.1A at night
                    
                loadVoltage = (48.0 + (Math.random() - 0.5) * 2).toFixed(1); // 47-49V
                loadCurrent = (8 + Math.random() * 7).toFixed(2); // 8-15A
            } else {
                // EPVEPER has different characteristics
                pvVoltage = isDaytime ? 
                    (45 + Math.random() * 10).toFixed(1) : 
                    (10 + Math.random() * 5).toFixed(1);
                    
                pvCurrent = isDaytime ? 
                    (8 + Math.random() * 4).toFixed(2) : 
                    (0.1 + Math.random() * 0.5).toFixed(2);
                    
                loadVoltage = (47.8 + (Math.random() - 0.5) * 1.5).toFixed(1);
                loadCurrent = (5 + Math.random() * 3).toFixed(2);
            }
            
            // Update PV Voltage
            const pvVoltageElement = document.getElementById(`pv${i}-voltage`);
            if (pvVoltageElement) {
                pvVoltageElement.textContent = pvVoltage + ' V';
                // Add color coding based on voltage level
                const voltageValue = parseFloat(pvVoltage);
                if (voltageValue > 50) {
                    pvVoltageElement.className = 'stats-card-value text-success';
                } else if (voltageValue > 20) {
                    pvVoltageElement.className = 'stats-card-value text-warning';
                } else {
                    pvVoltageElement.className = 'stats-card-value text-secondary';
                }
            }
            
            // Update PV Current
            const pvCurrentElement = document.getElementById(`pv${i}-current`);
            if (pvCurrentElement) {
                pvCurrentElement.textContent = pvCurrent + ' A';
                // Add color coding based on current level
                const currentValue = parseFloat(pvCurrent);
                if (currentValue > 10) {
                    pvCurrentElement.className = 'stats-card-value text-success';
                } else if (currentValue > 2) {
                    pvCurrentElement.className = 'stats-card-value text-warning';
                } else {
                    pvCurrentElement.className = 'stats-card-value text-secondary';
                }
            }
            
            // Update Load Voltage
            const loadVoltageElement = document.getElementById(`load${i}-voltage`);
            if (loadVoltageElement) {
                loadVoltageElement.textContent = loadVoltage + ' V';
            }
            
            // Update Load Current
            const loadCurrentElement = document.getElementById(`load${i}-current`);
            if (loadCurrentElement) {
                loadCurrentElement.textContent = loadCurrent + ' A';
            }
            
            // Calculate and update Load Power
            const loadPower = (parseFloat(loadVoltage) * parseFloat(loadCurrent)).toFixed(1);
            const loadPowerElement = document.getElementById(`load${i}-power`);
            if (loadPowerElement) {
                loadPowerElement.textContent = loadPower + ' W';
            }
            
            // Update SCC Status with more realistic states
            const statuses = sccType === 'scc-srne' ? 
                ['Normal', 'Charging', 'Float', 'Boost', 'MPPT'] :
                ['is running', 'is charging', 'is standby'];
            const randomStatus = statuses[Math.floor(Math.random() * statuses.length)];
            const statusElement = document.getElementById(`scc${i}-status`);
            if (statusElement) {
                statusElement.textContent = randomStatus;
                // Update status badge color based on SCC type and status
                if (sccType === 'scc-srne') {
                    statusElement.className = 
                        randomStatus === 'Normal' ? 'badge bg-success' : 
                        randomStatus === 'Charging' || randomStatus === 'MPPT' ? 'badge bg-primary' : 
                        randomStatus === 'Boost' ? 'badge bg-info' :
                        'badge bg-warning';
                } else {
                    statusElement.className = 
                        randomStatus === 'is running' ? 'badge bg-success' : 
                        randomStatus === 'is charging' ? 'badge bg-primary' : 'badge bg-warning';
                }
            }
            
            // Update Heartbeat counter with realistic values
            const heartbeat = Math.floor(Math.random() * 10000) + 1000;
            const heartbeatElement = document.getElementById(`scc${i}-counter-heartbeat`);
            if (heartbeatElement) {
                heartbeatElement.textContent = `Heartbeat: ${heartbeat}`;
            }

            // Update Last update time
            const lastUpdateElement = document.getElementById(`last-update-${i}`);
            if (lastUpdateElement) {
                lastUpdateElement.textContent = `Last Update: ${now.toLocaleTimeString()}`;
            }
        }
    };

    // Function to update SCC alarm data
    const updateSCCAlarms = () => {
        const sccType = '{{ scc_type }}'; // Get SCC type from template
        const numberOfScc = {{ number_of_scc }};
        
        for (let i = 1; i <= numberOfScc; i++) {
            if (sccType === 'scc-srne') {
                updateSRNEAlarms(i);
            } else if (sccType === 'scc-epveper') {
                updateEPVEPERAlarms(i);
            }
        }
    };

    // Function to update SCC-SRNE alarms
    const updateSRNEAlarms = (sccNumber) => {
        const alarmTypes = {
            'batt-hi-temp-1': 'Battery High Temp Protection 1',
            'batt-hi-temp-2': 'Battery High Temp Protection 2',
            'batt-lo-temp-1': 'Battery Low Temp Protection 1',
            'batt-lo-temp-2': 'Battery Low Temp Protection 2',
            'batt-overdisc': 'Battery Over Discharge',
            'batt-overvolt': 'Battery Overvoltage',
            'batt-reversed': 'Battery Reversed',
            'batt-undervolt': 'Battery Undervoltage',
            'controller-temp-high': 'Controller High Temperature',
            'load-over-current': 'Load Over Current/Power',
            'pv-overpower': 'PV Input Overpower',
            'pv-overvolt': 'PV Input Overvoltage'
        };

        let activeAlarms = [];
        
        // Update additional SRNE system information
        const batteryTemp = (25 + Math.random() * 20).toFixed(1); // 25-45째C
        const controllerTemp = (30 + Math.random() * 15).toFixed(1); // 30-45째C
        const chargingModes = ['MPPT', 'Boost', 'Float', 'Equalize'];
        const batteryTypes = ['Sealed', 'Gel', 'Flooded', 'LiFePO4'];
        
        // Update system info elements
        const batteryTempElement = document.getElementById(`scc${sccNumber}-battery-temp`);
        if (batteryTempElement) {
            batteryTempElement.textContent = `${batteryTemp}째C`;
            batteryTempElement.className = 
                parseFloat(batteryTemp) > 40 ? 'badge bg-danger' :
                parseFloat(batteryTemp) > 35 ? 'badge bg-warning' : 'badge bg-info';
        }

        const controllerTempElement = document.getElementById(`scc${sccNumber}-controller-temp`);
        if (controllerTempElement) {
            controllerTempElement.textContent = `${controllerTemp}째C`;
            controllerTempElement.className = 
                parseFloat(controllerTemp) > 40 ? 'badge bg-danger' :
                parseFloat(controllerTemp) > 35 ? 'badge bg-warning' : 'badge bg-info';
        }

        const chargingModeElement = document.getElementById(`scc${sccNumber}-charging-mode`);
        if (chargingModeElement) {
            const randomMode = chargingModes[Math.floor(Math.random() * chargingModes.length)];
            chargingModeElement.textContent = randomMode;
            chargingModeElement.className = 
                randomMode === 'MPPT' ? 'badge bg-success' :
                randomMode === 'Boost' ? 'badge bg-primary' :
                randomMode === 'Float' ? 'badge bg-info' : 'badge bg-warning';
        }

        const batteryTypeElement = document.getElementById(`scc${sccNumber}-battery-type`);
        if (batteryTypeElement) {
            const randomType = batteryTypes[Math.floor(Math.random() * batteryTypes.length)];
            batteryTypeElement.textContent = randomType;
            batteryTypeElement.className = 'badge bg-secondary';
        }
        
        // Simulate alarm data (mostly 0 with occasional 1)
        Object.keys(alarmTypes).forEach(alarmKey => {
            const alarmValue = Math.random() < 0.05 ? 1 : 0; // 5% chance of alarm
            const element = document.getElementById(`scc${sccNumber}-${alarmKey}`);
            
            if (element) {
                if (alarmValue === 1) {
                    element.className = 'badge bg-danger';
                    element.textContent = 'ACTIVE';
                    activeAlarms.push(alarmTypes[alarmKey]);
                } else {
                    element.className = 'badge bg-success';
                    element.textContent = 'NORMAL';
                }
            }
        });

        // Update alarm summary
        const summaryElement = document.getElementById(`scc${sccNumber}-alarm-summary`);
        if (summaryElement) {
            if (activeAlarms.length > 0) {
                summaryElement.innerHTML = `<span class="text-danger"><i class="fas fa-exclamation-triangle"></i> ${activeAlarms.length} Active Alarm(s)</span>`;
                summaryElement.parentElement.className = 'alert alert-danger mb-3';
            } else {
                summaryElement.innerHTML = `<span class="text-success"><i class="fas fa-check-circle"></i> No active alarms</span>`;
                summaryElement.parentElement.className = 'alert alert-success mb-3';
            }
        }
    };

    // Function to update SCC-EPVEPER alarms
    const updateEPVEPERAlarms = (sccNumber) => {
        const normalStatuses = ['normal', 'running', 'boost', 'float', 'light_load', 'moderate', 'rated'];
        const alarmStatuses = {
            'standby': { text: 'Standby mode', class: 'bg-warning' },
            'unrecognized': { text: 'Unrecognized status', class: 'bg-secondary' },
            'fault': { text: 'Fault detected', class: 'bg-danger' },
            'overvoltage': { text: 'Overvoltage condition', class: 'bg-danger' },
            'short_circuit': { text: 'Short circuit detected', class: 'bg-danger' },
            'abnormal': { text: 'Abnormal condition', class: 'bg-warning' },
            'unable': { text: 'Unable to operate', class: 'bg-danger' },
            'overload': { text: 'Overload condition', class: 'bg-danger' },
            'low_voltage': { text: 'Low voltage detected', class: 'bg-warning' },
            'high_voltage': { text: 'High voltage detected', class: 'bg-danger' },
            'no_access': { text: 'No access to system', class: 'bg-secondary' },
            'wrong': { text: 'Wrong operation', class: 'bg-warning' },
            'overtemp': { text: 'Overtemperature condition', class: 'bg-danger' },
            'lowtemp': { text: 'Low temperature condition', class: 'bg-info' },
            'overdischarge': { text: 'Overdischarge condition', class: 'bg-danger' },
            'undervoltage': { text: 'Undervoltage condition', class: 'bg-warning' }
        };

        let activeAlarms = [];

        // Battery Status
        const batteryStatuses = {
            'battery-condition': 'Battery Condition',
            'battery-identification': 'Battery Identification',
            'battery-resistance': 'Battery Resistance',
            'battery-temperature': 'Battery Temperature'
        };

        Object.keys(batteryStatuses).forEach(statusKey => {
            const element = document.getElementById(`scc${sccNumber}-${statusKey}`);
            if (element) {
                // 95% normal, 5% alarm
                const isAlarm = Math.random() < 0.05;
                if (isAlarm) {
                    const alarmKeys = Object.keys(alarmStatuses);
                    const randomAlarm = alarmKeys[Math.floor(Math.random() * alarmKeys.length)];
                    const alarmInfo = alarmStatuses[randomAlarm];
                    
                    element.className = `badge ${alarmInfo.class}`;
                    element.textContent = randomAlarm.toUpperCase();
                    element.title = alarmInfo.text;
                    activeAlarms.push(`${batteryStatuses[statusKey]}: ${alarmInfo.text}`);
                } else {
                    element.className = 'badge bg-success';
                    element.textContent = 'NORMAL';
                    element.title = 'Normal operation';
                }
            }
        });

        // Charging Status
        const chargingStatuses = {
            'anti-reverse-mosfet': 'Anti Reverse MOSFET',
            'charging-anti-reverse-mosfet': 'Charging Anti Reverse MOSFET',
            'charging-condition': 'Charging Condition',
            'charging-mosfet-short': 'Charging MOSFET Short',
            'charging-state': 'Charging State',
            'charging-status': 'Charging Status',
            'disequilibrium': 'Disequilibrium',
            'input-over-current': 'Input Over Current',
            'input-voltage-status': 'Input Voltage Status',
            'load-mosfet-short': 'Load MOSFET Short',
            'load-over-current': 'Load Over Current',
            'load-short': 'Load Short',
            'pv-input-short': 'PV Input Short'
        };

        Object.keys(chargingStatuses).forEach(statusKey => {
            const element = document.getElementById(`scc${sccNumber}-${statusKey}`);
            if (element) {
                const isAlarm = Math.random() < 0.05;
                if (isAlarm) {
                    const alarmKeys = Object.keys(alarmStatuses);
                    const randomAlarm = alarmKeys[Math.floor(Math.random() * alarmKeys.length)];
                    const alarmInfo = alarmStatuses[randomAlarm];
                    
                    element.className = `badge ${alarmInfo.class}`;
                    element.textContent = randomAlarm.toUpperCase();
                    element.title = alarmInfo.text;
                    activeAlarms.push(`${chargingStatuses[statusKey]}: ${alarmInfo.text}`);
                } else {
                    // Random normal status
                    const normalStatus = normalStatuses[Math.floor(Math.random() * normalStatuses.length)];
                    element.className = 'badge bg-success';
                    element.textContent = normalStatus.toUpperCase();
                    element.title = 'Normal operation';
                }
            }
        });

        // Discharging Status
        const dischargingStatuses = {
            'boost-voltage': 'Boost Voltage',
            'discharge-short': 'Discharge Short',
            'discharging-condition': 'Discharging Condition',
            'discharging-output': 'Discharging Output',
            'discharging-state': 'Discharging State',
            'high-voltage-side': 'High Voltage Side',
            'input-voltage': 'Input Voltage',
            'output-power': 'Output Power',
            'output-voltage': 'Output Voltage',
            'stop-discharging': 'Stop Discharging'
        };

        Object.keys(dischargingStatuses).forEach(statusKey => {
            const element = document.getElementById(`scc${sccNumber}-${statusKey}`);
            if (element) {
                const isAlarm = Math.random() < 0.05;
                if (isAlarm) {
                    const alarmKeys = Object.keys(alarmStatuses);
                    const randomAlarm = alarmKeys[Math.floor(Math.random() * alarmKeys.length)];
                    const alarmInfo = alarmStatuses[randomAlarm];
                    
                    element.className = `badge ${alarmInfo.class}`;
                    element.textContent = randomAlarm.toUpperCase();
                    element.title = alarmInfo.text;
                    activeAlarms.push(`${dischargingStatuses[statusKey]}: ${alarmInfo.text}`);
                } else {
                    const normalStatus = normalStatuses[Math.floor(Math.random() * normalStatuses.length)];
                    element.className = 'badge bg-success';
                    element.textContent = normalStatus.toUpperCase();
                    element.title = 'Normal operation';
                }
            }
        });

        // Update alarm summary
        const summaryElement = document.getElementById(`scc${sccNumber}-alarm-summary`);
        if (summaryElement) {
            if (activeAlarms.length > 0) {
                summaryElement.innerHTML = `<span class="text-danger"><i class="fas fa-exclamation-triangle"></i> ${activeAlarms.length} Active Alarm(s)</span>`;
                summaryElement.parentElement.className = 'alert alert-danger mb-3';
            } else {
                summaryElement.innerHTML = `<span class="text-success"><i class="fas fa-check-circle"></i> No active alarms</span>`;
                summaryElement.parentElement.className = 'alert alert-success mb-3';
            }
        }
    };

    // Update SCC dummy data every 5 seconds
    setInterval(updateSCCDummyData, 5000);
    
    // Update SCC alarms every 10 seconds
    setInterval(updateSCCAlarms, 10000);
    
    // Initial updates
    updateSCCDummyData();
    updateSCCAlarms();
</script>
{% endblock %}
