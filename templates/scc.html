{% extends 'modern-layout.html' %}
{% block breadcrumbs %}SCC Monitoring - {{ scc_type.upper().replace('-', ' ') }}{% endblock breadcrumbs %}

{% block content %}
<!-- SCC Overview Header -->
<div class="row mb-4">
    <div class="col-12">
        <div class="modern-card">
            <div class="modern-card-header">
                <h2 class="modern-card-title">
                    <i class="fas fa-solar-panel"></i>
                    Solar Charge Controller Monitoring
                </h2>
                <div class="d-flex align-items-center">
                    <span class="badge bg-primary me-2">{{ scc_type.upper().replace('-', ' ') }}</span>
                    <span class="text-muted">{{ site_name }} | {{ ip_address }}</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- SCC Relay Configuration -->
<div class="row mb-4">
    <div class="col-12">
        <div class="modern-card">
            <div class="modern-card-header">
                <h5 class="modern-card-title">
                    <i class="fas fa-chart-bar text-info me-2"></i>
                    SCC Relay Configuration
                </h5>
            </div>
            <div class="modern-card-body">
                <div class="row g-4">
                    <div class="col-lg-3 col-md-6">
                        <div class="stats-card">
                            <div class="stats-card-header">
                                <h6 class="stats-card-title">Vsat Reconnect</h6>
                                <div class="stats-card-icon bg-success">
                                    <i class="fas fa-satellite"></i>
                                </div>
                            </div>
                            <h3 class="stats-card-value" id="vsat-reconnect">Loading...</h3>
                            <p class="stats-card-subtitle">
                                <i class="fas fa-arrow-up me-2"></i>
                                Vsat Reconnect (mV)
                            </p>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <div class="stats-card">
                            <div class="stats-card-header">
                                <h6 class="stats-card-title">Vsat Cut Off</h6>
                                <div class="stats-card-icon bg-success">
                                    <i class="fas fa-satellite"></i>
                                </div>
                            </div>
                            <h3 class="stats-card-value" id="vsat-cutoff">Loading...</h3>
                            <p class="stats-card-subtitle">
                                <i class="fas fa-arrow-down me-2"></i>
                                Vsat Cut Off (mV)
                            </p>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <div class="stats-card">
                            <div class="stats-card-header">
                                <h6 class="stats-card-title">BTS Reconnect</h6>
                                <div class="stats-card-icon bg-primary">
                                    <i class="fas fa-broadcast-tower"></i>
                                </div>
                            </div>
                            <h3 class="stats-card-value" id="bts-reconnect">Loading...</h3>
                            <p class="stats-card-subtitle">
                                <i class="fas fa-arrow-up me-2"></i>
                                BTS Reconnect (mV)
                            </p>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <div class="stats-card">
                            <div class="stats-card-header">
                                <h6 class="stats-card-title">BTS Cut Off</h6>
                                <div class="stats-card-icon bg-primary">
                                    <i class="fas fa-broadcast-tower"></i>
                                </div>
                            </div>
                            <h3 class="stats-card-value" id="bts-cutoff">Loading...</h3>
                            <p class="stats-card-subtitle">
                                <i class="fas fa-arrow-down me-2"></i>
                                BTS Cut Off (mV)
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- SCC Real-time Data -->
<div class="row g-4">
    {% for i in range(1, number_of_scc+1) %}
    {% if number_of_scc == 2 %}
    <div class="col-lg-6">
    {% elif number_of_scc == 3 %}
    <div class="col-xl-4 col-lg-6 col-md-12">
    {% else %}
    <div class="col-xl-3 col-lg-4 col-md-6 col-sm-12">
    {% endif %}
        <div class="modern-card h-100">
            <div class="modern-card-header">
                <h3 class="modern-card-title">
                    <i class="fas fa-solar-panel"></i>
                    SCC {{i}} Status
                </h3>
                <div class="d-flex align-items-center flex-wrap">
                    <i class="fas fa-info-circle text-primary me-2"></i>
                    <span class="text-muted small" id="scc{{i}}-device-id">SCC ID: Loading...</span>
                    <span class="text-muted mx-1">|</span>
                    <i class="fas fa-heartbeat text-danger me-1"></i>
                    <span class="text-muted small" id="scc{{i}}-counter-heartbeat">Heartbeat: Loading...</span>
                    <span class="text-muted mx-1">|</span>
                    <i class="fas fa-clock text-info me-1"></i>
                    <span class="text-muted small" id="last-update-{{i}}">Last Update: Loading...</span>
                </div>
            </div>
            <div class="modern-card-body">
                <div class="row g-2">
                    <!-- SCC Status -->
                    <div class="col-6">
                        <div class="stats-card">
                            <div class="stats-card-header">
                                <h6 class="stats-card-title small">Controller Status</h6>
                                <div class="stats-card-icon bg-primary">
                                    <i class="fas fa-power-off"></i>
                                </div>
                            </div>
                            <h5 class="stats-card-value">
                                <span class="status-indicator" id="scc{{i}}-status">Loading...</span>
                            </h5>
                            <p class="stats-card-subtitle small">Operation Mode</p>
                        </div>
                    </div>
                    
                    <!-- PV Voltage -->
                    <div class="col-6">
                        <div class="stats-card">
                            <div class="stats-card-header">
                                <h6 class="stats-card-title small">PV {{i}} Voltage</h6>
                                <div class="stats-card-icon bg-success">
                                    <i class="fas fa-sun"></i>
                                </div>
                            </div>
                            <h5 class="stats-card-value" id="pv{{i}}-voltage">Loading...</h5>
                            <p class="stats-card-subtitle small">Solar Input</p>
                        </div>
                    </div>
                    
                    <!-- PV Current -->
                    <div class="col-6">
                        <div class="stats-card">
                            <div class="stats-card-header">
                                <h6 class="stats-card-title small">PV {{i}} Current</h6>
                                <div class="stats-card-icon bg-info">
                                    <i class="fas fa-tachometer-alt"></i>
                                </div>
                            </div>
                            <h5 class="stats-card-value" id="pv{{i}}-current">Loading...</h5>
                            <p class="stats-card-subtitle small">Charging Input</p>
                        </div>
                    </div>
                    
                    <!-- Load Voltage -->
                    <div class="col-6">
                        <div class="stats-card">
                            <div class="stats-card-header">
                                <h6 class="stats-card-title small">Load Voltage</h6>
                                <div class="stats-card-icon bg-info">
                                    <i class="fas fa-plug"></i>
                                </div>
                            </div>
                            <h5 class="stats-card-value" id="load{{i}}-voltage">Loading...</h5>
                            <p class="stats-card-subtitle small">Output Voltage</p>
                        </div>
                    </div>
                    
                    <!-- Load Current -->
                    <div class="col-6">
                        <div class="stats-card">
                            <div class="stats-card-header">
                                <h6 class="stats-card-title small">Load Current</h6>
                                <div class="stats-card-icon bg-primary">
                                    <i class="fas fa-arrow-left"></i>
                                </div>
                            </div>
                            <h5 class="stats-card-value" id="load{{i}}-current">Loading...</h5>
                            <p class="stats-card-subtitle small">Output Current</p>
                        </div>
                    </div>

                    <!-- Load Power -->
                    <div class="col-6">
                        <div class="stats-card">
                            <div class="stats-card-header">
                                <h6 class="stats-card-title small">Load Power</h6>
                                <div class="stats-card-icon bg-warning">
                                    <i class="fas fa-bolt"></i>
                                </div>
                            </div>
                            <h5 class="stats-card-value" id="load{{i}}-power">Loading...</h5>
                            <p class="stats-card-subtitle small">Total Power</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Power Generation Chart -->
<div class="row mt-4">
    <div class="col-12">
        <div class="modern-card">
            <div class="modern-card-header">
                <h3 class="modern-card-title">
                    <i class="fas fa-chart-line"></i>
                    Power Generation Trend
                </h3>
            </div>
            <div class="modern-card-body">
                <div class="chart-container">
                    <canvas id="powerChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- SCC Parameters & Alarms -->
<div class="row mt-4">
    <div class="col-12">
        <div class="modern-card">
            <div class="modern-card-header">
                <h3 class="modern-card-title">
                    <i class="fas fa-exclamation-triangle"></i>
                    SCC Status & Alarms
                </h3>
            </div>
            <div class="modern-card-body">
                <div class="row g-3">
                    {% for i in range(1, number_of_scc+1) %}
                    <div class="col-md-6">
                        <div class="modern-card">
                            <div class="modern-card-header">
                                <h5 class="modern-card-title">SCC {{i}} Alarm Status</h5>
                            </div>
                            <div class="modern-card-body">
                                <!-- SCC-SRNE Alarms -->
                                {% if scc_type == 'scc-srne' %}
                                <div class="alert alert-info mb-3">
                                    <h6><i class="fas fa-shield-alt"></i> Protection Status</h6>
                                    <div id="scc{{i}}-alarm-summary" class="fw-bold">Checking alarms...</div>
                                </div>

                                <!-- SRNE Additional Data -->
                                <div class="mb-3">
                                    <h6 class="text-primary"><i class="fas fa-info-circle"></i> System Information</h6>
                                    <div class="row g-2">
                                        <div class="col-6">
                                            <small class="text-muted">Battery Temperature</small>
                                            <div><span id="scc{{i}}-battery-temp" class="badge bg-info">Loading...</span></div>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted">Controller Temperature</small>
                                            <div><span id="scc{{i}}-controller-temp" class="badge bg-info">Loading...</span></div>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted">Charging Mode</small>
                                            <div><span id="scc{{i}}-charging-mode" class="badge bg-success">Loading...</span></div>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted">Battery Type</small>
                                            <div><span id="scc{{i}}-battery-type" class="badge bg-secondary">Loading...</span></div>
                                        </div>
                                    </div>
                                </div>

                                <div class="table-responsive">
                                    <table class="modern-table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Protection Type</th>
                                                <th>Status</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td>Battery High Temp Protection 1</td>
                                                <td><span id="scc{{i}}-batt-hi-temp-protection-1" class="badge">-</span></td>
                                            </tr>
                                            <tr>
                                                <td>Battery High Temp Protection 2</td>
                                                <td><span id="scc{{i}}-batt-hi-temp-protection-2" class="badge">-</span></td>
                                            </tr>
                                            <tr>
                                                <td>Battery Low Temp Protection 1</td>
                                                <td><span id="scc{{i}}-batt-lo-temp-protection-1" class="badge">-</span></td>
                                            </tr>
                                            <tr>
                                                <td>Battery Low Temp Protection 2</td>
                                                <td><span id="scc{{i}}-batt-lo-temp-protection-2" class="badge">-</span></td>
                                            </tr>
                                            <tr>
                                                <td>Battery Over Discharge</td>
                                                <td><span id="scc{{i}}-batt-overdisc" class="badge">-</span></td>
                                            </tr>
                                            <tr>
                                                <td>Battery Overvoltage</td>
                                                <td><span id="scc{{i}}-batt-overvolt" class="badge">-</span></td>
                                            </tr>
                                            <tr>
                                                <td>Battery Reversed</td>
                                                <td><span id="scc{{i}}-batt-reversed" class="badge">-</span></td>
                                            </tr>
                                            <tr>
                                                <td>Battery Undervoltage</td>
                                                <td><span id="scc{{i}}-batt-undervolt" class="badge">-</span></td>
                                            </tr>
                                            <tr>
                                                <td>Controller High Temperature</td>
                                                <td><span id="scc{{i}}-controller-temp-high" class="badge">-</span></td>
                                            </tr>
                                            <tr>
                                                <td>Induction Probe Damaged</td>
                                                <td><span id="scc{{i}}-induction-probe-damaged" class="badge">-</span></td>
                                            </tr>
                                            <tr>
                                                <td>Load Open Circuit</td>
                                                <td><span id="scc{{i}}-load-open-circuit" class="badge">-</span></td>
                                            </tr>
                                            <tr>
                                                <td>Load Over Current/Power</td>
                                                <td><span id="scc{{i}}-load-over-current-power" class="badge">-</span></td>
                                            </tr>
                                            <tr>
                                                <td>Load Short Circuit</td>
                                                <td><span id="scc{{i}}-load-short" class="badge">-</span></td>
                                            </tr>
                                            <tr>
                                                <td>Battery Detected SLD</td>
                                                <td><span id="scc{{i}}-oo-battery-detected-sld" class="badge">-</span></td>
                                            </tr>
                                            <tr>
                                                <td>Overcharge Protection</td>
                                                <td><span id="scc{{i}}-overcharge-protection" class="badge">-</span></td>
                                            </tr>
                                            <tr>
                                                <td>Power Supply Status</td>
                                                <td><span id="scc{{i}}-power-supply-status" class="badge">-</span></td>
                                            </tr>
                                            <tr>
                                                <td>PV Input Overpower</td>
                                                <td><span id="scc{{i}}-pv-input-overpower" class="badge">-</span></td>
                                            </tr>
                                            <tr>
                                                <td>PV Input Overvoltage</td>
                                                <td><span id="scc{{i}}-pv-input-overvolt" class="badge">-</span></td>
                                            </tr>
                                            <tr>
                                                <td>Solar Panel Reversed</td>
                                                <td><span id="scc{{i}}-solar-panel-reversed" class="badge">-</span></td>
                                            </tr>
                                            <tr>
                                                <td>Solar Panel Working Point Overvoltage</td>
                                                <td><span id="scc{{i}}-solar-panel-working-point-overvolt" class="badge">-</span></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                {% endif %}

                                <!-- SCC-EPVEPER Alarms -->
                                {% if scc_type == 'scc-epveper' %}
                                <div class="alert alert-info mb-3">
                                    <h6><i class="fas fa-shield-alt"></i> System Status</h6>
                                    <div id="scc{{i}}-alarm-summary" class="fw-bold">Checking status...</div>
                                </div>
                                
                                <!-- Battery Status -->
                                <div class="mb-3">
                                    <h6 class="text-primary"><i class="fas fa-battery-half"></i> Battery Status</h6>
                                    <div class="row g-2">
                                        <div class="col-6">
                                            <small class="text-muted">Battery Condition</small>
                                            <div><span id="scc{{i}}-battery-condition" class="badge">-</span></div>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted">Battery Identification</small>
                                            <div><span id="scc{{i}}-battery-identification" class="badge">-</span></div>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted">Battery Inner Resistance</small>
                                            <div><span id="scc{{i}}-battery-inner-resistance" class="badge">-</span></div>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted">Battery Temperature</small>
                                            <div><span id="scc{{i}}-battery-temperature" class="badge">-</span></div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Charging Status -->
                                <div class="mb-3">
                                    <h6 class="text-success"><i class="fas fa-arrow-up"></i> Charging Status</h6>
                                    <div class="row g-2">
                                        <div class="col-4">
                                            <small class="text-muted">Anti Reverse MOSFET</small>
                                            <div><span id="scc{{i}}-anti-reverse-mosfet" class="badge">-</span></div>
                                        </div>
                                        <div class="col-4">
                                            <small class="text-muted">Charging Anti Reverse MOSFET</small>
                                            <div><span id="scc{{i}}-charging-anti-reverse-mosfet" class="badge">-</span></div>
                                        </div>
                                        <div class="col-4">
                                            <small class="text-muted">Charging Condition</small>
                                            <div><span id="scc{{i}}-charging-condition" class="badge">-</span></div>
                                        </div>
                                        <div class="col-4">
                                            <small class="text-muted">Charging MOSFET Short</small>
                                            <div><span id="scc{{i}}-charging-mosfet-short" class="badge">-</span></div>
                                        </div>
                                        <div class="col-4">
                                            <small class="text-muted">Charging State</small>
                                            <div><span id="scc{{i}}-charging-state" class="badge">-</span></div>
                                        </div>
                                        <div class="col-4">
                                            <small class="text-muted">Charging Status</small>
                                            <div><span id="scc{{i}}-charging-status" class="badge">-</span></div>
                                        </div>
                                        <div class="col-4">
                                            <small class="text-muted">Disequilibrium</small>
                                            <div><span id="scc{{i}}-disequilibrium" class="badge">-</span></div>
                                        </div>
                                        <div class="col-4">
                                            <small class="text-muted">Input Over Current</small>
                                            <div><span id="scc{{i}}-input-over-current" class="badge">-</span></div>
                                        </div>
                                        <div class="col-4">
                                            <small class="text-muted">Input Voltage Status</small>
                                            <div><span id="scc{{i}}-input-voltage-status" class="badge">-</span></div>
                                        </div>
                                        <div class="col-4">
                                            <small class="text-muted">Load MOSFET Short</small>
                                            <div><span id="scc{{i}}-load-mosfet-short" class="badge">-</span></div>
                                        </div>
                                        <div class="col-4">
                                            <small class="text-muted">Load Over Current</small>
                                            <div><span id="scc{{i}}-load-over-current" class="badge">-</span></div>
                                        </div>
                                        <div class="col-4">
                                            <small class="text-muted">Load Short</small>
                                            <div><span id="scc{{i}}-load-short" class="badge">-</span></div>
                                        </div>
                                        <div class="col-4">
                                            <small class="text-muted">PV Input Short</small>
                                            <div><span id="scc{{i}}-pv-input-short" class="badge">-</span></div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Discharging Status -->
                                <div class="mb-3">
                                    <h6 class="text-warning"><i class="fas fa-arrow-down"></i> Discharging Status</h6>
                                    <div class="row g-2">
                                        <div class="col-4">
                                            <small class="text-muted">Boost Voltage</small>
                                            <div><span id="scc{{i}}-boost-voltage" class="badge">-</span></div>
                                        </div>
                                        <div class="col-4">
                                            <small class="text-muted">Discharge Short</small>
                                            <div><span id="scc{{i}}-discharge-short" class="badge">-</span></div>
                                        </div>
                                        <div class="col-4">
                                            <small class="text-muted">Discharging Condition</small>
                                            <div><span id="scc{{i}}-discharging-condition" class="badge">-</span></div>
                                        </div>
                                        <div class="col-4">
                                            <small class="text-muted">Discharging Output</small>
                                            <div><span id="scc{{i}}-discharging-output" class="badge">-</span></div>
                                        </div>
                                        <div class="col-4">
                                            <small class="text-muted">Discharging State</small>
                                            <div><span id="scc{{i}}-discharging-state" class="badge">-</span></div>
                                        </div>
                                        <div class="col-4">
                                            <small class="text-muted">High Voltage Side</small>
                                            <div><span id="scc{{i}}-high-voltage-side" class="badge">-</span></div>
                                        </div>
                                        <div class="col-4">
                                            <small class="text-muted">Input Voltage</small>
                                            <div><span id="scc{{i}}-input-voltage" class="badge">-</span></div>
                                        </div>
                                        <div class="col-4">
                                            <small class="text-muted">Output Power</small>
                                            <div><span id="scc{{i}}-output-power" class="badge">-</span></div>
                                        </div>
                                        <div class="col-4">
                                            <small class="text-muted">Output Voltage</small>
                                            <div><span id="scc{{i}}-output-voltage" class="badge">-</span></div>
                                        </div>
                                        <div class="col-4">
                                            <small class="text-muted">Stop Discharging</small>
                                            <div><span id="scc{{i}}-stop-discharging" class="badge">-</span></div>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    // Global variables for SCC monitoring
    let sccChart = null;
    let updateInterval = null;
    let chartUpdateInterval = null;
    
    // Configuration
    // const API_BASE_URL = 'http://{{ ip_address }}/api/v1/monitoring';
    const API_BASE_URL = '/api/v1/monitoring';

    const UPDATE_INTERVAL = 5000; // 5 seconds
    const CHART_UPDATE_INTERVAL = 60000; // 1 minute
    
    // Initialize SCC monitoring
    document.addEventListener('DOMContentLoaded', function() {
        // Get authentication token and user role from server
        const userToken = '{{ session.get("auth_token", "") }}';
        const userRole = '{{ user_role }}';

        initializeSCCChart();
        startDataFetching();
        
        // Initial data load
        fetchSCCData();
        fetchChartData();
    });

    // Initialize power generation chart
    function initializeSCCChart() {
        const ctx = document.getElementById('powerChart');
        if (!ctx) return;

        sccChart = window.powerDeskApp.createChart('powerChart', {
            type: 'line',
            data: {
                labels: [],
                datasets: []
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Battery (V)',
                            font: {
                                size: 14,
                                weight: 'bold'
                            }
                        },
                        grid: {
                            color: 'rgba(0, 0, 0, 0.1)',
                        },
                        ticks: {
                            callback: function(value) {
                                return value + ' W';
                            }
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Time (24 Hours)',
                            font: {
                                size: 14,
                                weight: 'bold'
                            }
                        },
                        grid: {
                            color: 'rgba(0, 0, 0, 0.1)',
                        }
                    }
                },
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            usePointStyle: true,
                            padding: 20,
                            font: {
                                size: 12,
                                weight: 'bold'
                            }
                        }
                    },
                    title: {
                        display: true,
                        text: 'Real-time Battery Voltage - Last 24 Hours',
                        font: {
                            size: 16,
                            weight: 'bold'
                        },
                        padding: 20
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleColor: 'white',
                        bodyColor: 'white',
                        borderColor: 'rgba(255, 255, 255, 0.1)',
                        borderWidth: 1,
                        cornerRadius: 8,
                        displayColors: true,
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ' + context.parsed.y + ' V';
                            }
                        }
                    }
                },
                animation: {
                    duration: 1000,
                    easing: 'easeInOutQuart'
                }
            }
        });
    }

    // Start data fetching intervals
    function startDataFetching() {
        // Real-time SCC data updates
        updateInterval = setInterval(fetchSCCData, UPDATE_INTERVAL);
        
        // Chart data updates (less frequent)
        chartUpdateInterval = setInterval(fetchChartData, CHART_UPDATE_INTERVAL);
    }

    // Fetch real-time SCC data from API
    async function fetchSCCData() {
        const userToken = '{{ session.get("auth_token", "") }}';
        
        try {
            const response = await fetch(`${API_BASE_URL}/scc`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${userToken}`
                }
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const result = await response.json();
            
            if (result.status === 'success' && result.data) {
                updateSCCDisplay(result.data);
                updateLastUpdateTime(result.data.last_update);
            } else {
                console.error('API response error:', result.message || 'Unknown error');
                showErrorMessage('Failed to fetch SCC data');
            }

        } catch (error) {
            console.error('Error fetching SCC data:', error);
            showErrorMessage('Connection error - using offline mode');
        }
    }

    // Fetch chart data from SQLite via API
    async function fetchChartData() {
        const userToken = '{{ session.get("auth_token", "") }}';

        try {
            const response = await fetch(`${API_BASE_URL}/scc/chart`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${userToken}`
                }
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const result = await response.json();
            
            if (result.status === 'success' && result.data && result.data.chart_data) {
                updateChart(result.data.chart_data);
            } else {
                console.error('Chart API response error:', result.message || 'Unknown error');
            }

        } catch (error) {
            console.error('Error fetching chart data:', error);
        }
    }

    // Update SCC display with real data
    function updateSCCDisplay(data) {
        // Update relay configuration
        if (data.relay_configuration) {
            updateRelayConfiguration(data.relay_configuration);
        }

        // Update each SCC
        const numberOfScc = {{ number_of_scc }};
        for (let i = 1; i <= numberOfScc; i++) {
            const sccKey = `scc${i}`;
            const sccData = data[sccKey];
            
            if (sccData) {
                updateSCCCard(i, sccData);
            }
        }
    }

    // Update relay configuration display
    function updateRelayConfiguration(relayConfig) {
        // Update relay configuration cards using specific IDs
        if (relayConfig.vsat_reconnect !== undefined) {
            updateElement('vsat-reconnect', relayConfig.vsat_reconnect + ' mV');
        }
        
        if (relayConfig.vsat_cutoff !== undefined) {
            updateElement('vsat-cutoff', relayConfig.vsat_cutoff + ' mV');
        }
        
        if (relayConfig.bts_reconnect !== undefined) {
            updateElement('bts-reconnect', relayConfig.bts_reconnect + ' mV');
        }
        
        if (relayConfig.bts_cutoff !== undefined) {
            updateElement('bts-cutoff', relayConfig.bts_cutoff + ' mV');
        }
    }

    // Update individual SCC card
    function updateSCCCard(sccNumber, sccData) {
        // Device ID and heartbeat
        updateElement(`scc${sccNumber}-device-id`, `SCC ID: ${sccData.scc_id || 'N/A'}`);
        updateElement(`scc${sccNumber}-counter-heartbeat`, `Heartbeat: ${sccData.counter_heartbeat || 'N/A'}`);
        
        // PV Voltage
        updateElementWithColor(`pv${sccNumber}-voltage`, 
            formatValue(sccData.pv_voltage, 'V', 1), 
            getVoltageColor(sccData.pv_voltage));
        
        // PV Current
        updateElementWithColor(`pv${sccNumber}-current`, 
            formatValue(sccData.pv_current, 'A', 2), 
            getCurrentColor(sccData.pv_current));
        
        // Load Voltage
        updateElement(`load${sccNumber}-voltage`, formatValue(sccData.load_voltage, 'V', 1));
        
        // Load Current
        updateElement(`load${sccNumber}-current`, formatValue(sccData.load_current, 'A', 2));
        
        // Load Power
        updateElement(`load${sccNumber}-power`, formatValue(sccData.load_power, 'W', 1));
        
        // SCC Status
        updateStatusBadge(`scc${sccNumber}-status`, sccData.load_status);
        
        // Update alarms if available
        if (sccData.alarm_status) {
            updateAlarmStatus(sccNumber, sccData.alarm_status);
        }
        
        // Update temperatures
        if (sccData.battery_temperature !== undefined) {
            updateElement(`scc${sccNumber}-battery-temp`, formatValue(sccData.battery_temperature, '°C', 1));
        }
        
        if (sccData.device_temperature !== undefined) {
            updateElement(`scc${sccNumber}-controller-temp`, formatValue(sccData.device_temperature, '°C', 1));
        }
    }

    // Update alarm status for SCC
    function updateAlarmStatus(sccNumber, alarmStatus) {
        const sccType = '{{ scc_type }}';
        let activeAlarms = 0;
        let alarmMessages = [];
        
        if (sccType === 'scc-srne') {
            // Handle SCC-SRNE alarm structure
            const srneAlarmMap = {
                'batt_hi_temp_protection_1': 'Battery High Temperature Protection 1',
                'batt_hi_temp_protection_2': 'Battery High Temperature Protection 2',
                'batt_lo_temp_protection_1': 'Battery Low Temperature Protection 1',
                'batt_lo_temp_protection_2': 'Battery Low Temperature Protection 2',
                'batt_overdisc': 'Battery Over Discharge',
                'batt_overvolt': 'Battery Overvoltage',
                'batt_reversed': 'Battery Reversed',
                'batt_undervolt': 'Battery Undervoltage',
                'controller_temp_high': 'Controller High Temperature',
                'induction_probe_damaged': 'Induction Probe Damaged',
                'load_open_circuit': 'Load Open Circuit',
                'load_over_current_power': 'Load Over Current/Power',
                'load_short': 'Load Short Circuit',
                'oo_battery_detected_sld': 'Battery Detected SLD',
                'overcharge_protection': 'Overcharge Protection',
                'power_supply_status': 'Power Supply Status',
                'pv_input_overpower': 'PV Input Overpower',
                'pv_input_overvolt': 'PV Input Overvoltage',
                'solar_panel_reversed': 'Solar Panel Reversed',
                'solar_panel_working_point_overvolt': 'Solar Panel Working Point Overvoltage'
            };
            
            // Check each SRNE alarm
            Object.keys(srneAlarmMap).forEach(key => {
                const value = alarmStatus[key];
                const elementId = `scc${sccNumber}-${key.replace(/_/g, '-')}`;
                const element = document.getElementById(elementId);
                
                if (element) {
                    if (value === 1) {
                        element.textContent = 'ACTIVE';
                        element.className = 'badge bg-danger';
                        activeAlarms++;
                        alarmMessages.push(srneAlarmMap[key]);
                    } else {
                        element.textContent = 'NORMAL';
                        element.className = 'badge bg-success';
                    }
                }
            });
            
        } else if (sccType === 'scc-epveper') {
            // Handle SCC-EPVEPER alarm structure
            const epveperAlarmMap = {
                // Alarm status mapping with messages
                'standby': 'Standby mode',
                'unrecognized': 'Unrecognized status',
                'fault': 'Fault detected',
                'overvoltage': 'Overvoltage condition',
                'short_circuit': 'Short circuit detected',
                'abnormal': 'Abnormal condition',
                'unable': 'Unable to operate',
                'overload': 'Overload condition',
                'low_voltage': 'Low voltage detected',
                'high_voltage': 'High voltage detected',
                'no_access': 'No access to system',
                'wrong': 'Wrong operation',
                'overtemp': 'Overtemperature condition',
                'lowtemp': 'Low temperature condition',
                'overdischarge': 'Overdischarge condition',
                'undervoltage': 'Undervoltage condition'
            };
            
            // Update battery status alarms
            if (alarmStatus.battery_status) {
                Object.keys(alarmStatus.battery_status).forEach(key => {
                    const value = alarmStatus.battery_status[key];
                    const elementId = `scc${sccNumber}-${key.replace(/_/g, '-')}`;
                    updateAlarmBadge(elementId, value);
                    
                    if (value !== 'normal' && value !== 'running' && epveperAlarmMap[value]) {
                        activeAlarms++;
                        alarmMessages.push(`Battery: ${epveperAlarmMap[value]}`);
                    }
                });
            }
            
            // Update charging status alarms
            if (alarmStatus.charging_status) {
                Object.keys(alarmStatus.charging_status).forEach(key => {
                    const value = alarmStatus.charging_status[key];
                    const elementId = `scc${sccNumber}-${key.replace(/_/g, '-')}`;
                    updateAlarmBadge(elementId, value);
                    
                    if (value !== 'normal' && value !== 'running' && value !== 'boost' && value !== 'light_load' && epveperAlarmMap[value]) {
                        activeAlarms++;
                        alarmMessages.push(`Charging: ${epveperAlarmMap[value]}`);
                    }
                });
            }
            
            // Update discharging status alarms
            if (alarmStatus.discharging_status) {
                Object.keys(alarmStatus.discharging_status).forEach(key => {
                    const value = alarmStatus.discharging_status[key];
                    const elementId = `scc${sccNumber}-${key.replace(/_/g, '-')}`;
                    updateAlarmBadge(elementId, value);
                    
                    if (value !== 'normal' && value !== 'running' && value !== 'light_load' && epveperAlarmMap[value]) {
                        activeAlarms++;
                        alarmMessages.push(`Discharging: ${epveperAlarmMap[value]}`);
                    }
                });
            }
        }
        
        // Update alarm summary
        const summaryElement = document.getElementById(`scc${sccNumber}-alarm-summary`);
        if (summaryElement) {
            if (activeAlarms > 0) {
                const alarmList = alarmMessages.length > 3 
                    ? alarmMessages.slice(0, 3).join(', ') + ` and ${alarmMessages.length - 3} more...`
                    : alarmMessages.join(', ');
                    
                summaryElement.innerHTML = `<span class="text-danger"><i class="fas fa-exclamation-triangle"></i> ${activeAlarms} Active Alarm(s): ${alarmList}</span>`;
                summaryElement.parentElement.className = 'alert alert-danger mb-3';
            } else {
                summaryElement.innerHTML = `<span class="text-success"><i class="fas fa-check-circle"></i> No active alarms</span>`;
                summaryElement.parentElement.className = 'alert alert-success mb-3';
            }
        }
    }

    // Update chart with new data
    function updateChart(chartData) {
        if (!sccChart) return;
        
        // Colors for different SCCs
        const colors = [
            { border: 'rgb(37, 99, 235)', background: 'rgba(37, 99, 235, 0.1)' },
            { border: 'rgb(16, 185, 129)', background: 'rgba(16, 185, 129, 0.1)' },
            { border: 'rgb(245, 101, 101)', background: 'rgba(245, 101, 101, 0.1)' },
            { border: 'rgb(251, 146, 60)', background: 'rgba(251, 146, 60, 0.1)' },
            { border: 'rgb(168, 85, 247)', background: 'rgba(168, 85, 247, 0.1)' }
        ];
        
        // Update chart data
        sccChart.data.labels = chartData.labels;
        sccChart.data.datasets = chartData.datasets.map((dataset, index) => ({
            ...dataset,
            borderColor: colors[index]?.border || colors[0].border,
            backgroundColor: colors[index]?.background || colors[0].background,
            tension: 0.4,
            fill: true,
            pointRadius: 3,
            pointHoverRadius: 6
        }));
        
        sccChart.update('none');
    }

    // Utility functions
    function updateElement(elementId, value) {
        const element = document.getElementById(elementId);
        if (element) {
            element.textContent = value;
        }
    }

    function updateElementWithColor(elementId, value, colorClass) {
        const element = document.getElementById(elementId);
        if (element) {
            element.textContent = value;
            element.className = `stats-card-value ${colorClass}`;
        }
    }

    function updateStatusBadge(elementId, status) {
        const element = document.getElementById(elementId);
        if (element) {
            element.textContent = status || 'Unknown';
            
            let badgeClass = 'badge ';
            if (status === 'is running') {
                badgeClass += 'bg-success';
            } else if (status === 'is charging') {
                badgeClass += 'bg-primary';
            } else if (status === 'is standby') {
                badgeClass += 'bg-warning';
            } else {
                badgeClass += 'bg-danger';
            }
            
            element.className = badgeClass;
        }
    }

    function updateAlarmBadge(elementId, value) {
        const element = document.getElementById(elementId);
        if (element) {
            element.textContent = value.toUpperCase();
            
            let badgeClass = 'badge ';
            
            // Normal/Good states
            if (value === 'normal' || value === 'running') {
                badgeClass += 'bg-success';
            }
            // Information states
            else if (value === 'boost' || value === 'light_load' || value === 'no_charging') {
                badgeClass += 'bg-info';
            }
            // Warning states
            else if (value === 'standby' || value === 'unrecognized' || value === 'abnormal' || 
                     value === 'low_voltage' || value === 'lowtemp' || value === 'undervoltage') {
                badgeClass += 'bg-warning';
            }
            // Critical/Danger states
            else if (value === 'fault' || value === 'overvoltage' || value === 'short_circuit' || 
                     value === 'overload' || value === 'high_voltage' || value === 'wrong' || 
                     value === 'overtemp' || value === 'overdischarge') {
                badgeClass += 'bg-danger';
            }
            // Inactive/Unable states
            else if (value === 'unable' || value === 'no_access') {
                badgeClass += 'bg-secondary';
            }
            // Default for unknown states
            else {
                badgeClass += 'bg-secondary';
            }
            
            element.className = badgeClass;
        }
    }

    function formatValue(value, unit, decimals = 1) {
        if (value === null || value === undefined || value === -1) {
            return 'N/A';
        }
        return `${parseFloat(value).toFixed(decimals)} ${unit}`;
    }

    function getVoltageColor(voltage) {
        if (voltage > 50) return 'text-success';
        if (voltage > 20) return 'text-warning';
        return 'text-secondary';
    }

    function getCurrentColor(current) {
        if (current > 10) return 'text-success';
        if (current > 2) return 'text-warning';
        return 'text-secondary';
    }

    function updateLastUpdateTime(lastUpdate) {
        const numberOfScc = {{ number_of_scc }};
        for (let i = 1; i <= numberOfScc; i++) {
            updateElement(`last-update-${i}`, `Last Update: ${lastUpdate || 'Unknown'}`);
        }
    }

    function showErrorMessage(message) {
        // You can implement a toast notification or status indicator here
        console.warn(`SCC Monitoring: ${message}`);
    }

    // Cleanup on page unload
    window.addEventListener('beforeunload', function() {
        if (updateInterval) {
            clearInterval(updateInterval);
        }
        if (chartUpdateInterval) {
            clearInterval(chartUpdateInterval);
        }
    });
</script>
{% endblock %}
