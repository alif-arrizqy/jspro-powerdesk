{% extends 'modern-layout.html' %}
{% block breadcrumbs %}Device Settings{% endblock breadcrumbs %}

{% block content %}
<!-- Page Header -->
<div class="row mb-4">
    <div class="col-12">
        <div class="modern-card">
            <div class="modern-card-header">
                <h3 class="modern-card-title">
                    <i class="fas fa-cog text-primary me-2"></i>
                    Device Configuration
                </h3>
            </div>
            <div class="modern-card-body">
                <p class="text-muted mb-0">Konfigurasi untuk enable/disable service, informasi lokasi site dan jenis perangkat yang digunakan.</p>
            </div>
        </div>
    </div>
</div>

<!-- Configuration Forms Row 1: Service Settings & Site Information -->
<div class="row">
    <!-- Enable Services -->
    <div class="col-lg-6 mb-4">
        <div class="modern-card">
            <div class="modern-card-header">
                <h5 class="modern-card-title">
                    <i class="fas fa-cogs text-primary me-2"></i>
                    Enable Services
                </h5>
            </div>
            <div class="modern-card-body">
                <form method="POST">
                    <input type="hidden" name="enabled-services-form" value="enabled-services-form">
                    
                    <!-- Communication Services -->
                    <div class="mb-4">
                        <h6 class="text-muted mb-3">
                            <i class="fas fa-wifi me-2"></i>Communication Services
                        </h6>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card border-0 bg-light mb-3">
                                    <div class="card-body p-3">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" name="snmp-service" id="snmp-service" 
                                                   {% if enabled_services.snmp_service %}checked{% endif %}>
                                            <label class="form-check-label fw-bold" for="snmp-service">
                                                <i class="fas fa-network-wired me-2 text-primary"></i>
                                                SNMP Service
                                            </label>
                                        </div>
                                        <small class="text-muted">Network monitoring protocol</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card border-0 bg-light mb-3">
                                    <div class="card-body p-3">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" name="mqtt-service" id="mqtt-service" 
                                                   {% if enabled_services.mqtt_service %}checked{% endif %}>
                                            <label class="form-check-label fw-bold" for="mqtt-service">
                                                <i class="fas fa-wifi me-2 text-success"></i>
                                                MQTT Service
                                            </label>
                                        </div>
                                        <small class="text-muted">IoT messaging protocol</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Device Services -->
                    <div class="mb-4">
                        <h6 class="text-muted mb-3">
                            <i class="fas fa-cogs me-2"></i>Device Control Services
                        </h6>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card border-0 bg-light mb-3">
                                    <div class="card-body p-3">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" name="scc-service" id="scc-service" 
                                                   {% if enabled_services.scc_service %}checked{% endif %}>
                                            <label class="form-check-label fw-bold" for="scc-service">
                                                <i class="fas fa-plug me-2 text-warning"></i>
                                                SCC Service
                                            </label>
                                        </div>
                                        <small class="text-muted">Solar Charge Controller</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card border-0 bg-light mb-3">
                                    <div class="card-body p-3">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" name="rectifier-service" id="rectifier-service" 
                                                   {% if enabled_services.rectifier_service %}checked{% endif %}>
                                            <label class="form-check-label fw-bold" for="rectifier-service">
                                                <i class="fas fa-bolt me-2 text-danger"></i>
                                                Rectifier Service
                                            </label>
                                        </div>
                                        <small class="text-muted">AC/DC Power Rectifier</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Battery Services -->
                    <div class="mb-4">
                        <h6 class="text-muted mb-3">
                            <i class="fas fa-battery-full me-2"></i>Battery Management Services
                        </h6>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card border-0 bg-light mb-3">
                                    <div class="card-body p-3">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" name="talis5-service" id="talis5-service" 
                                                   {% if enabled_services.talis5_service %}checked{% endif %}>
                                            <label class="form-check-label fw-bold" for="talis5-service">
                                                <i class="fas fa-battery-three-quarters me-2 text-info"></i>
                                                Talis5 Service
                                            </label>
                                        </div>
                                        <small class="text-muted">Talis5 Battery Management</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card border-0 bg-light mb-3">
                                    <div class="card-body p-3">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" name="jspro-service" id="jspro-service" 
                                                   {% if enabled_services.jspro_service %}checked{% endif %}>
                                            <label class="form-check-label fw-bold" for="jspro-service">
                                                <i class="fas fa-battery-full me-2 text-primary"></i>
                                                JSPro Service
                                            </label>
                                        </div>
                                        <small class="text-muted">JSPro Battery Management</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info d-flex align-items-start" role="alert">
                        <i class="fas fa-info-circle me-3 mt-1"></i>
                        <div>
                            <strong>Informasi Penting:</strong><br>
                            <small>• Pilih service yang sesuai dengan perangkat yang terpasang</small><br>
                            <small>• Service akan dijalankan otomatis setelah konfigurasi disimpan</small><br>
                            <small>• Pastikan konfigurasi perangkat sudah benar sebelum mengaktifkan service</small><br>
                            <small>• <b>Setelah mengubah enable service, ganti juga di form Device Version</b></small><br>
                            <small>• Pastikan sesuai dengan versi perangkat yang terpasang</small>
                        </div>
                    </div>
                    
                    <div class="d-grid">
                        <button type="submit" class="btn btn-modern btn-primary">
                            <i class="fas fa-save me-2"></i>
                            Save Service Settings
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Device Version & Port Configuration -->
    <div class="col-lg-6 mb-4">
        <div class="modern-card">
            <div class="modern-card-header">
                <h5 class="modern-card-title">
                    <i class="fas fa-code-branch text-info me-2"></i>
                    Device Version & Port Configuration
                </h5>
            </div>
            <div class="modern-card-body">
                <form method="POST">
                    <input type="hidden" name="device-version-form" value="device-version-form">

                    <!-- Basic Device Information -->
                    <div class="mb-4">
                        <h6 class="text-muted mb-3">
                            <i class="fas fa-server me-2"></i>Basic Device Information
                        </h6>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="ehub-version" class="form-label">Ehub Version</label>
                                    <input type="text" class="form-control" name="ehub-version" id="ehub-version" placeholder="e.g. v2.1.0" value="{{device_version.ehub_version}}">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="panel2-type" class="form-label">Panel 2 Type</label>
                                    <input type="text" class="form-control" name="panel2-type" id="panel2-type" placeholder="e.g. Monocrystalline 100W" value="{{device_version.panel2_type}}">
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="site-type" class="form-label">Site Type</label>
                            <select class="form-control" name="site-type" id="site-type">
                                <option value="" disabled {% if not device_version.site_type %}selected{% endif %}>Select Site Type</option>
                                <option value="teresterial" {% if device_version.site_type == 'teresterial' %}selected{% endif %}>Teresterial</option>
                                <option value="non-teresterial" {% if device_version.site_type == 'non-teresterial' %}selected{% endif %}>Non-Teresterial</option>
                                <option value="ehub-recti" {% if device_version.site_type == 'ehub-recti' %}selected{% endif %}>Ehub Rectifier System</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- SCC Configuration Section -->
                    <div class="mb-4">
                        <h6 class="text-muted mb-3">
                            <i class="fas fa-plug me-2"></i>Solar Charge Controller
                        </h6>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="scc-type" class="form-label">SCC Type</label>
                                    <select class="form-control" name="scc-type" id="scc-type">
                                        <option value="" disabled {% if not device_version.scc_type %}selected{% endif %}>Select SCC Type</option>
                                        <option value="scc-srne" {% if device_version.scc_type == 'scc-srne' %}selected{% endif %}>SCC SRNE</option>
                                        <option value="scc-epever" {% if device_version.scc_type == 'scc-epever' %}selected{% endif %}>SCC EPEVER</option>
                                        <option value="N/A" {% if device_version.scc_type == '' or device_version.scc_type == 'N/A' %}selected{% endif %}>Tanpa SCC</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="scc-source" class="form-label">SCC Source</label>
                                    <select class="form-control" name="scc-source" id="scc-source">
                                        <option value="" disabled {% if not device_version.scc_source %}selected{% endif %}>Select SCC Source</option>
                                        <option value="serial" {% if device_version.scc_source == 'serial' %}selected{% endif %}>Serial</option>
                                        <option value="usb" {% if device_version.scc_source == 'usb' %}selected{% endif %}>USB</option>
                                        <option value="N/A" {% if device_version.scc_source == '' or device_version.scc_source == 'N/A' %}selected{% endif %}>Tanpa SCC</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Battery Configuration Section -->
                    <div class="mb-4">
                        <h6 class="text-muted mb-3">
                            <i class="fas fa-battery-full me-2"></i>Battery Management System
                        </h6>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="battery-type" class="form-label">Battery Type</label>
                                    <select class="form-control" name="battery-type" id="battery-type">
                                        <option value="" disabled {% if not device_version.battery_type %}selected{% endif %}>Select Battery Type</option>
                                        <option value="talis5" {% if device_version.battery_type == 'talis5' %}selected{% endif %}>Talis5</option>
                                        <option value="jspro" {% if device_version.battery_type == 'jspro' %}selected{% endif %}>JSPro</option>
                                        <option value="mix" {% if device_version.battery_type == 'mix' %}selected{% endif %}>Mix (Talis5 + JSPro)</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="usb-type" class="form-label">Talis USB Connection</label>
                                    <select class="form-control" name="usb-type" id="usb-type">
                                        <option value="" disabled {% if not device_version.usb_type %}selected{% endif %}>Select USB Type</option>
                                        <option value="seri" {% if device_version.usb_type == 'seri' %}selected{% endif %}>Serial Connection</option>
                                        <option value="paralel" {% if device_version.usb_type == 'paralel' %}selected{% endif %}>Parallel Connection</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="talis-port-0" class="form-label">Talis Port 0 (Primary)</label>
                                    <select class="form-control" name="talis-port-0" id="talis-port-0">
                                        <option value="" disabled>Select USB Port</option>
                                        {% for port in port_usb %}
                                        <option value="{{ port }}" {% if talis_config.talis_port_0 == port %}selected{% endif %}>{{ port }}</option>
                                        {% endfor %}
                                        {% if not port_usb %}
                                        <option value="/dev/ttyUSB0" {% if talis_config.talis_port_0 == '/dev/ttyUSB0' %}selected{% endif %}>/dev/ttyUSB0</option>
                                        <option value="/dev/ttyUSB1" {% if talis_config.talis_port_0 == '/dev/ttyUSB1' %}selected{% endif %}>/dev/ttyUSB1</option>
                                        <option value="/dev/ttyUSB2" {% if talis_config.talis_port_0 == '/dev/ttyUSB2' %}selected{% endif %}>/dev/ttyUSB2</option>
                                        {% endif %}
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="talis-port-1" class="form-label">Talis Port 1 (Secondary)</label>
                                    <select class="form-control" name="talis-port-1" id="talis-port-1">
                                        <option value="" disabled>Select USB Port</option>
                                        {% for port in port_usb %}
                                        <option value="{{ port }}" {% if talis_config.talis_port_1 == port %}selected{% endif %}>{{ port }}</option>
                                        {% endfor %}
                                        {% if not port_usb %}
                                        <option value="/dev/ttyUSB0" {% if talis_config.talis_port_1 == '/dev/ttyUSB0' %}selected{% endif %}>/dev/ttyUSB0</option>
                                        <option value="/dev/ttyUSB1" {% if talis_config.talis_port_1 == '/dev/ttyUSB1' %}selected{% endif %}>/dev/ttyUSB1</option>
                                        <option value="/dev/ttyUSB2" {% if talis_config.talis_port_1 == '/dev/ttyUSB2' %}selected{% endif %}>/dev/ttyUSB2</option>
                                        {% endif %}
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Rectifier Configuration Section -->
                    <div class="mb-4">
                        <h6 class="text-muted mb-3">
                            <i class="fas fa-bolt me-2"></i>Rectifier System
                        </h6>
                        <div class="mb-3">
                            <label for="rectifier-type" class="form-label">Rectifier Type</label>
                            <div class="input-group">
                                <select class="form-control" id="rectifier-type-select" onchange="handleRectifierTypeChange()">
                                    <option value="" disabled>Select or Type Rectifier Type</option>
                                    <option value="Huawei" {% if device_version.rectifier_type == 'Huawei' %}selected{% endif %}>Huawei</option>
                                    <option value="Emerson" {% if device_version.rectifier_type == 'Emerson' %}selected{% endif %}>Emerson</option>
                                    <option value="Delta" {% if device_version.rectifier_type == 'Delta' %}selected{% endif %}>Delta</option>
                                    <option value="custom">Type Custom...</option>
                                    <option value="N/A" {% if device_version.rectifier_type == '' or device_version.rectifier_type == 'N/A' %}selected{% endif %}>Tanpa Rectifier</option>
                                </select>
                                <input type="text" class="form-control" name="rectifier-type" id="rectifier-type-input" 
                                       placeholder="Enter rectifier type" 
                                       value="{% if device_version.rectifier_type and device_version.rectifier_type != 'N/A' %}{{ device_version.rectifier_type }}{% endif %}"
                                       style="{% if device_version.rectifier_type == 'N/A' or not device_version.rectifier_type %}display: none;{% endif %}">
                            </div>
                            <small class="text-muted">Pilih dari daftar atau ketik tipe rectifier</small>
                        </div>
                    </div>
                    
                    <div class="alert alert-warning d-flex align-items-center py-2" role="alert">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <small>Konfigurasi ini memerlukan <strong>restart sistem</strong> untuk menerapkan perubahan</small>
                    </div>
                    
                    <div class="d-grid">
                        <button type="submit" class="btn btn-modern btn-warning">
                            <i class="fas fa-save me-2"></i>
                            Save Device Version Settings
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

</div>

<!-- Configuration Forms Row 2: Device Version & Device Information -->
<div class="row">
    <!-- Site Information -->
    <div class="col-lg-6 mb-4">
        <div class="modern-card">
            <div class="modern-card-header">
                <h5 class="modern-card-title">
                    <i class="fas fa-map-marker-alt text-success me-2"></i>
                    Site Information
                </h5>
            </div>
            <div class="modern-card-body">
                <form method="POST">
                    <input type="hidden" name="site-information-form" value="site-information-form">
                    <div class="mb-3">
                        <label for="site-id" class="form-label">
                            <i class="fas fa-id-card me-2"></i>
                            Site ID
                        </label>
                        <input type="text" class="form-control" name="site-id" id="site-id" placeholder="Enter Site ID" value="{{site_information.site_id}}">
                    </div>
                    
                    <div class="mb-3">
                        <label for="site-name" class="form-label">
                            <i class="fas fa-building me-2"></i>
                            Site Name
                        </label>
                        <input type="text" class="form-control" name="site-name" id="site-name" placeholder="Enter Site Name" value="{{site_information.site_name}}">
                    </div>
                    
                    <div class="mb-3">
                        <label for="address" class="form-label">
                            <i class="fas fa-map-marker-alt me-2"></i>
                            Address
                        </label>
                        <textarea class="form-control" name="address" id="address" rows="4" placeholder="Enter Site Address">{{site_information.address}}</textarea>
                    </div>
                    
                    <div class="alert alert-success d-flex align-items-center" role="alert">
                        <i class="fas fa-map-marker-alt me-2"></i>
                        <small>Konfigurasi identitas dan lokasi site untuk identifikasi perangkat</small>
                    </div>
                    
                    <div class="d-grid">
                        <button type="submit" class="btn btn-modern btn-success">
                            <i class="fas fa-save me-2"></i>
                            Save Location Settings
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Device Information -->
    <div class="col-lg-6 mb-4">
        <div class="modern-card">
            <div class="modern-card-header">
                <h5 class="modern-card-title">
                    <i class="fas fa-microchip text-warning me-2"></i>
                    Device Information
                </h5>
            </div>
            <div class="modern-card-body">
                <form method="POST">
                    <input type="hidden" name="device-info-form" value="device-info-form">
                    
                    <div class="mb-3">
                        <label for="model" class="form-label">
                            <i class="fas fa-tag me-2"></i>
                            Model
                        </label>
                        <input type="text" class="form-control" name="model" id="model" placeholder="Enter Device Model" value="{{device_model.model}}">
                    </div>
                    
                    <div class="mb-3">
                        <label for="part-number" class="form-label">
                            <i class="fas fa-barcode me-2"></i>
                            Part Number
                        </label>
                        <input type="text" class="form-control" name="part-number" id="part-number" placeholder="Enter Part Number" value="{{device_model.part_number}}">
                    </div>
                    
                    <div class="mb-3">
                        <label for="serial-number" class="form-label">
                            <i class="fas fa-qrcode me-2"></i>
                            Serial Number
                        </label>
                        <input type="text" class="form-control" name="serial-number" id="serial-number" placeholder="Enter Serial Number" value="{{device_model.serial_number}}">
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="software-version" class="form-label">
                                    <i class="fas fa-code me-2"></i>
                                    Software Version
                                </label>
                                <input type="text" class="form-control" name="software-version" id="software-version" placeholder="Enter Software Version" value="{{device_model.software_version}}">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="hardware-version" class="form-label">
                                    <i class="fas fa-microchip me-2"></i>
                                    Hardware Version
                                </label>
                                <input type="text" class="form-control" name="hardware-version" id="hardware-version" placeholder="Enter Hardware Version" value="{{device_model.hardware_version}}">
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info d-flex align-items-center" role="alert">
                        <i class="fas fa-microchip me-2"></i>
                        <small>Informasi identifikasi hardware dan software versi perangkat</small>
                    </div>
                    
                    <div class="d-grid">
                        <button type="submit" class="btn btn-modern btn-warning">
                            <i class="fas fa-save me-2"></i>
                            Save Device Information Settings
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock content %}

{% block scripts %}
<script>
    // Form validation and enhancement
    document.addEventListener('DOMContentLoaded', function() {
        // Update last updated time
        function updateLastUpdated() {
            const lastUpdatedElement = document.getElementById('last-updated');
            if (lastUpdatedElement) {
                const now = new Date().toLocaleTimeString();
                lastUpdatedElement.textContent = now;
            }
        }
        
        // Initialize last updated time
        updateLastUpdated();
        
        // Add form validation
        const forms = document.querySelectorAll('form');
        forms.forEach(form => {
            form.addEventListener('submit', function(e) {
                const inputs = form.querySelectorAll('input[required], textarea[required], select[required]');
                let isValid = true;
                
                inputs.forEach(input => {
                    if (!input.value.trim()) {
                        input.classList.add('is-invalid');
                        isValid = false;
                    } else {
                        input.classList.remove('is-invalid');
                    }
                });
                
                if (!isValid) {
                    e.preventDefault();
                    alert('Please fill in all required fields.');
                } else {
                    // Update last updated time on successful submission
                    setTimeout(updateLastUpdated, 100);
                }
            });
        });
        
        // Add input change handlers
        const inputs = document.querySelectorAll('input, textarea, select');
        inputs.forEach(input => {
            input.addEventListener('input', function() {
                if (this.value.trim()) {
                    this.classList.remove('is-invalid');
                    this.classList.add('is-valid');
                } else {
                    this.classList.remove('is-valid');
                }
            });
            
            // For select elements, also listen to change event
            if (input.tagName === 'SELECT') {
                input.addEventListener('change', function() {
                    if (this.value.trim()) {
                        this.classList.remove('is-invalid');
                        this.classList.add('is-valid');
                    } else {
                        this.classList.remove('is-valid');
                    }
                });
            }
        });
        
        // SCC Type and Source interaction
        const sccTypeSelect = document.getElementById('scc-type');
        const sccSourceSelect = document.getElementById('scc-source');
        
        if (sccTypeSelect && sccSourceSelect) {
            sccTypeSelect.addEventListener('change', function() {
                // Enable/disable source options based on SCC type
                const sccType = this.value;
                const sourceOptions = sccSourceSelect.querySelectorAll('option');
                
                sourceOptions.forEach(option => {
                    if (option.value === '') return; // Skip default option
                    
                    // Enable all options by default
                    option.disabled = false;
                    option.style.display = 'block';
                });
                
                // Add visual feedback
                this.style.borderColor = '#28a745';
                setTimeout(() => {
                    this.style.borderColor = '';
                }, 1000);
            });
        }
        
        // Battery Type interaction
        const batteryTypeSelect = document.getElementById('battery-type');
        if (batteryTypeSelect) {
            batteryTypeSelect.addEventListener('change', function() {
                // Add visual feedback
                this.style.borderColor = '#17a2b8';
                setTimeout(() => {
                    this.style.borderColor = '';
                }, 1000);
            });
        }
        
        // Device Services Toggle Enhancement
        const serviceToggles = document.querySelectorAll('[id$="-service"]');
        serviceToggles.forEach(toggle => {
            toggle.addEventListener('change', function() {
                const label = this.nextElementSibling;
                if (this.checked) {
                    label.style.color = '#28a745';
                    label.style.fontWeight = 'bold';
                } else {
                    label.style.color = '#6c757d';
                    label.style.fontWeight = 'normal';
                }
                
                // Add visual feedback
                this.style.boxShadow = '0 0 5px ' + (this.checked ? '#28a745' : '#dc3545');
                setTimeout(() => {
                    this.style.boxShadow = '';
                }, 1000);
            });
            
            // Initialize state
            const label = toggle.nextElementSibling;
            if (toggle.checked) {
                label.style.color = '#28a745';
                label.style.fontWeight = 'bold';
            } else {
                label.style.color = '#6c757d';
                label.style.fontWeight = 'normal';
            }
        });
        
        // Show success message on form submission
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('success')) {
            if (window.powerDeskApp && window.powerDeskApp.showNotification) {
                window.powerDeskApp.showNotification('Settings saved successfully!', 'success');
            }
            updateLastUpdated();
        }
        
        // Auto-update last updated time every minute
        setInterval(updateLastUpdated, 60000);
        
        // Enhanced form feedback
        forms.forEach(form => {
            form.addEventListener('submit', function() {
                const submitBtn = form.querySelector('button[type="submit"]');
                if (submitBtn) {
                    submitBtn.disabled = true;
                    
                    // Determine button text based on form type
                    let originalText = 'Save Settings';
                    let loadingText = 'Saving...';
                    
                    if (submitBtn.textContent.includes('Location')) {
                        originalText = 'Save Location Settings';
                    } else if (submitBtn.textContent.includes('Device')) {
                        originalText = 'Save Device Settings';
                    } else if (submitBtn.textContent.includes('Version')) {
                        originalText = 'Save Version Settings';
                    } else if (submitBtn.textContent.includes('Service')) {
                        originalText = 'Save Service Settings';
                    }
                    
                    submitBtn.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i>${loadingText}`;
                    
                    // Re-enable after 3 seconds (in case of error)
                    setTimeout(() => {
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = `<i class="fas fa-save me-2"></i>${originalText}`;
                    }, 3000);
                }
            });
        });
    });
    
    // Rectifier type selection handler
    function handleRectifierTypeChange() {
        const selectElement = document.getElementById('rectifier-type-select');
        const inputElement = document.getElementById('rectifier-type-input');
        const selectedValue = selectElement.value;
        
        if (selectedValue === 'custom') {
            // Show input field for custom type
            inputElement.style.display = 'block';
            inputElement.focus();
            inputElement.value = '';
            inputElement.placeholder = 'Enter custom rectifier type';
        } else if (selectedValue === 'N/A') {
            // Hide input field and set N/A value
            inputElement.style.display = 'none';
            inputElement.value = 'N/A';
        } else if (selectedValue === '') {
            // Show input field but keep it empty
            inputElement.style.display = 'block';
            inputElement.value = '';
            inputElement.placeholder = 'Enter rectifier type';
        } else {
            // Set predefined value and show input field
            inputElement.style.display = 'block';
            inputElement.value = selectedValue;
        }
    }
    
    // Initialize rectifier type field on page load
    document.addEventListener('DOMContentLoaded', function() {
        const selectElement = document.getElementById('rectifier-type-select');
        const inputElement = document.getElementById('rectifier-type-input');
        
        // Set initial state based on current value
        if (inputElement.value && inputElement.value !== 'N/A') {
            // Check if current value matches any predefined options
            const options = selectElement.querySelectorAll('option');
            let matched = false;
            
            for (let option of options) {
                if (option.value === inputElement.value) {
                    selectElement.value = option.value;
                    matched = true;
                    break;
                }
            }
            
            if (!matched && inputElement.value !== '') {
                // Custom value, show it in input
                selectElement.value = 'custom';
                inputElement.style.display = 'block';
            }
        } else if (inputElement.value === 'N/A') {
            selectElement.value = 'N/A';
            inputElement.style.display = 'none';
        }
    });
</script>
{% endblock scripts %}
