{% extends 'modern-layout.html' %}
{% block breadcrumbs %}Device Settings{% endblock breadcrumbs %}

{% block content %}
<!-- Page Header -->
<div class="row mb-4">
    <div class="col-12">
        <div class="modern-card">
            <div class="modern-card-header">
                <h3 class="modern-card-title">
                    <i class="fas fa-cog text-primary me-2"></i>
                    Device Configuration
                </h3>
            </div>
            <div class="modern-card-body">
                <p class="text-muted mb-0">Konfigurasi site location and device information Perangkat JSPro.</p>
            </div>
        </div>
    </div>
</div>

<!-- Configuration Forms -->
<div class="row">
    <!-- Site Location -->
    <div class="col-lg-6 mb-4">
        <div class="modern-card">
            <div class="modern-card-header">
                <h5 class="modern-card-title">
                    <i class="fas fa-map-marker-alt text-success me-2"></i>
                    Site Location
                </h5>
            </div>
            <div class="modern-card-body">
                <form method="POST">
                    <input type="hidden" name="site-location-form" value="site-location-form">
                    
                    <div class="mb-3">
                        <label for="site-id" class="form-label">
                            <i class="fas fa-id-card me-2"></i>
                            Site ID
                        </label>
                        <input type="text" class="form-control" name="site-id" id="site-id" placeholder="Enter Site ID" value="{{site_information.site_id}}">
                    </div>
                    
                    <div class="mb-3">
                        <label for="site-name" class="form-label">
                            <i class="fas fa-building me-2"></i>
                            Site Name
                        </label>
                        <input type="text" class="form-control" name="site-name" id="site-name" placeholder="Enter Site Name" value="{{site_information.site_name}}">
                    </div>
                    
                    <div class="mb-3">
                        <label for="address" class="form-label">
                            <i class="fas fa-map-marker-alt me-2"></i>
                            Address
                        </label>
                        <textarea class="form-control" name="address" id="address" rows="3" placeholder="Enter Site Address">{{site_information.address}}</textarea>
                    </div>
                    
                    <div class="d-grid">
                        <button type="submit" class="btn btn-modern btn-success">
                            <i class="fas fa-save me-2"></i>
                            Save Location Settings
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Device Version -->
    <div class="col-lg-6 mb-4">
        <div class="modern-card">
            <div class="modern-card-header">
                <h5 class="modern-card-title">
                    <i class="fas fa-code-branch text-info me-2"></i>
                    Device Version
                </h5>
            </div>
            <div class="modern-card-body">
                <form method="POST">
                    <input type="hidden" name="device-version-form" value="device-version-form">

                    <div class="row">
                        <div class="col-lg-6">
                            <div class="mb-3">
                                <label for="ehub-version" class="form-label">
                                    <i class="fas fa-server me-2"></i>
                                    Ehub Version
                                </label>
                                <input type="text" class="form-control" name="ehub-version" id="ehub-version" placeholder="Enter Ehub Version" value="{{device_version.ehub_version}}">
                            </div>
                            <div class="mb-3">
                                <div class="mb-3">
                                    <label for="panel2-type" class="form-label">
                                        <i class="fas fa-solar-panel me-2"></i>
                                        Panel 2 Type
                                    </label>
                                    <input type="text" class="form-control" name="panel2-type" id="panel2-type" placeholder="Enter Panel 2 Type" value="{{device_version.panel2_type}}">
                                </div>
                            </div>
                            <div class="mb-3">
                                <div class="mb-3">
                                    <label for="site-type" class="form-label">
                                        <i class="fas fa-sitemap me-2"></i>
                                        Site Type
                                    </label>
                                    <input type="text" class="form-control" name="site-type" id="site-type" placeholder="Enter Site Type" value="{{device_version.site_type}}">
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="mb-3">
                                <div class="mb-3">
                                    <label for="scc-type" class="form-label">
                                        <i class="fas fa-plug me-2"></i>
                                        SCC Type
                                    </label>
                                    <input type="text" class="form-control" name="scc-type" id="scc-type" placeholder="Enter SCC Type" value="{{device_version.scc_type}}">
                                </div>
                            </div>
                            <div class="mb-3">
                                <div class="mb-3">
                                    <label for="scc-source" class="form-label">
                                        <i class="fas fa-power-off me-2"></i>
                                        SCC Source
                                    </label>
                                    <input type="text" class="form-control" name="scc-source" id="scc-source" placeholder="Enter SCC Source" value="{{device_version.scc_source}}">
                                </div>
                            </div>
                            <div class="mb-3">
                                <div class="mb-3">
                                    <label for="battery-type" class="form-label">
                                        <i class="fas fa-battery-full me-2"></i>
                                        Battery Type
                                    </label>
                                    <input type="text" class="form-control" name="battery-type" id="battery-type" placeholder="Enter Battery Type" value="{{device_version.battery_type}}">
                                </div>
                            </div>
                        </div>
                        <div class="d-grid">
                            <div class="alert alert-warning" role="alert">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                <small>Device Version memerlukan <b>restart</b> sistem untuk menerapkan perubahan.</small>
                            </div>
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-modern btn-warning">
                                <i class="fas fa-save me-2"></i>
                                Save Device Version Settings
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{% if username == 'teknisi' %}
<!-- Device Information -->
<div class="row">
    <div class="col-lg-12 mb-4">
        <div class="modern-card">
            <div class="modern-card-header">
                <h5 class="modern-card-title">
                    <i class="fas fa-microchip text-warning me-2"></i>
                    Device Information Settings
                </h5>
            </div>
            <div class="modern-card-body">
                <form method="POST">
                    <input type="hidden" name="device-info-form" value="device-info-form">
                    
                    <div class="row">
                        <div class="col-lg-6">
                            <div class="mb-3">
                                <label for="model" class="form-label">
                                    <i class="fas fa-tag me-2"></i>
                                    Model
                                </label>
                                <input type="text" class="form-control" name="model" id="model" placeholder="Enter Device Model" value="{{device_model.model}}">
                            </div>
                            
                            <div class="mb-3">
                                <label for="part-number" class="form-label">
                                    <i class="fas fa-barcode me-2"></i>
                                    Part Number
                                </label>
                                <input type="text" class="form-control" name="part-number" id="part-number" placeholder="Enter Part Number" value="{{device_model.part_number}}">
                            </div>
                            
                            <div class="mb-3">
                                <label for="serial-number" class="form-label">
                                    <i class="fas fa-qrcode me-2"></i>
                                    Serial Number
                                </label>
                                <input type="text" class="form-control" name="serial-number" id="serial-number" placeholder="Enter Serial Number" value="{{device_model.serial_number}}">
                            </div>
                        </div>
                        
                        <div class="col-lg-6">
                            <div class="mb-3">
                                <label for="software-version" class="form-label">
                                    <i class="fas fa-code me-2"></i>
                                    Software Version
                                </label>
                                <input type="text" class="form-control" name="software-version" id="software-version" placeholder="Enter Software Version" value="{{device_model.software_version}}">
                            </div>
                            
                            <div class="mb-3">
                                <label for="hardware-version" class="form-label">
                                    <i class="fas fa-microchip me-2"></i>
                                    Hardware Version
                                </label>
                                <input type="text" class="form-control" name="hardware-version" id="hardware-version" placeholder="Enter Hardware Version" value="{{device_model.hardware_version}}">
                            </div>
                            
                            <div class="mb-3">
                                <div class="alert alert-warning" role="alert">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    <small>Device information memerlukan <b>restart</b> sistem untuk menerapkan perubahan.</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-grid">
                        <button type="submit" class="btn btn-modern btn-warning">
                            <i class="fas fa-save me-2"></i>
                            Save Device Settings
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{% endif %}
{% endblock content %}

{% block scripts %}
<script>
    // Form validation and enhancement
    document.addEventListener('DOMContentLoaded', function() {
        // Update last updated time
        function updateLastUpdated() {
            const lastUpdatedElement = document.getElementById('last-updated');
            if (lastUpdatedElement) {
                const now = new Date().toLocaleTimeString();
                lastUpdatedElement.textContent = now;
            }
        }
        
        // Initialize last updated time
        updateLastUpdated();
        
        // Add form validation
        const forms = document.querySelectorAll('form');
        forms.forEach(form => {
            form.addEventListener('submit', function(e) {
                const inputs = form.querySelectorAll('input[required], textarea[required]');
                let isValid = true;
                
                inputs.forEach(input => {
                    if (!input.value.trim()) {
                        input.classList.add('is-invalid');
                        isValid = false;
                    } else {
                        input.classList.remove('is-invalid');
                    }
                });
                
                if (!isValid) {
                    e.preventDefault();
                    alert('Please fill in all required fields.');
                } else {
                    // Update last updated time on successful submission
                    setTimeout(updateLastUpdated, 100);
                }
            });
        });
        
        // Add input change handlers
        const inputs = document.querySelectorAll('input, textarea');
        inputs.forEach(input => {
            input.addEventListener('input', function() {
                if (this.value.trim()) {
                    this.classList.remove('is-invalid');
                    this.classList.add('is-valid');
                } else {
                    this.classList.remove('is-valid');
                }
            });
        });
        
        // Show success message on form submission
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('success')) {
            if (window.powerDeskApp && window.powerDeskApp.showNotification) {
                window.powerDeskApp.showNotification('Settings saved successfully!', 'success');
            }
            updateLastUpdated();
        }
        
        // Auto-update last updated time every minute
        setInterval(updateLastUpdated, 60000);
        
        // Enhanced form feedback
        forms.forEach(form => {
            form.addEventListener('submit', function() {
                const submitBtn = form.querySelector('button[type="submit"]');
                if (submitBtn) {
                    submitBtn.disabled = true;
                    
                    // Determine button text based on form type
                    let originalText = 'Save Settings';
                    let loadingText = 'Saving...';
                    
                    if (submitBtn.textContent.includes('Location')) {
                        originalText = 'Save Location Settings';
                    } else if (submitBtn.textContent.includes('Device')) {
                        originalText = 'Save Device Settings';
                    } else if (submitBtn.textContent.includes('Version')) {
                        originalText = 'Save Version Settings';
                    }
                    
                    submitBtn.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i>${loadingText}`;
                    
                    // Re-enable after 3 seconds (in case of error)
                    setTimeout(() => {
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = `<i class="fas fa-save me-2"></i>${originalText}`;
                    }, 3000);
                }
            });
        });
    });
</script>
{% endblock scripts %}
