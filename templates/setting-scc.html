{% extends 'modern-layout.html' %}
{% block breadcrumbs %}SCC Settings{% endblock breadcrumbs %}

{% block content %}
<!-- Page Header -->
<div class="row mb-4">
    <div class="col-12">
        <div class="modern-card">
            <div class="modern-card-header">
                <h3 class="modern-card-title">
                    <i class="fas fa-solar-panel text-primary me-2"></i>
                    Solar Charge Controller Configuration
                </h3>
            </div>
            <div class="modern-card-body">
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Peringatan:</strong> Ketika Anda mengklik Submit, layanan SCC dan Webapp akan direstart. Jika Anda mengalami error '502 Bad Gateway', silakan reload webapp.
                </div>
                <p class="text-muted mb-0">Configure Solar Charge Controller settings including device type, connection parameters, and operational values.</p>
            </div>
        </div>
    </div>
</div>

<!-- Configuration Forms -->
<div class="row">
    <!-- SCC Type and Source Configuration -->
    <div class="col-lg-6 mb-4">
        <div class="modern-card">
            <div class="modern-card-header">
                <h5 class="modern-card-title">
                    <i class="fas fa-cogs text-primary me-2"></i>
                    SCC Type and Source
                </h5>
            </div>
            <div class="modern-card-body">
                <form method="POST">
                    <input type="hidden" name="scc-type-form" value="scc-type-form">
                    
                    <div class="mb-3">
                        <label for="scc-type" class="form-label">
                            <i class="fas fa-microchip me-2"></i>
                            SCC Type
                        </label>
                        {% if scc_type == 'scc-srne' or scc_type == 'scc-epveper' %}
                        <select class="form-control" name="scc-type" id="scc-type" required>
                            <option value="" disabled {% if not scc_type %}selected{% endif %}>Choose SCC Type</option>
                            <option value="scc-srne" {% if scc_type == 'scc-srne' %}selected{% endif %}>SCC Srne</option>
                            <option value="scc-epveper" {% if scc_type == 'scc-epveper' %}selected{% endif %}>SCC Epveper</option>
                        </select>
                        {% else %}
                        <select class="form-control" name="scc-type" id="scc-type" required>
                            <option value="" disabled {% if not scc_type %}selected{% endif %}>Choose SCC Type</option>
                            <option value="scc-tristar" {% if scc_type == 'scc-tristar' %}selected{% endif %}>SCC Tristar</option>
                        </select>
                        {% endif %}
                    </div>
                    
                    <div class="mb-3">
                        <label for="scc-source" class="form-label">
                            <i class="fas fa-plug me-2"></i>
                            SCC Source
                        </label>
                        <select class="form-control" name="scc-source" id="scc-source" required>
                            <option value="" disabled {% if not scc_source %}selected{% endif %}>Choose SCC Source</option>
                            <option value="serial" {% if scc_source == 'serial' %}selected{% endif %}>SERIAL</option>
                            <option value="usb" {% if scc_source == 'usb' %}selected{% endif %}>USB</option>
                            <option value="tcp" {% if scc_source == 'tcp' %}selected{% endif %}>TCP</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="scc-scan" class="form-label">
                            <i class="fas fa-search me-2"></i>
                            SCC Scan ID
                        </label>
                        <select class="form-control" name="scc-scan" id="scc-scan" required>
                            <option value="" disabled {% if not scc_scan %}selected{% endif %}>Choose SCC Scan</option>
                            <option value="true" {% if scc_scan == 'true' %}selected{% endif %}>True</option>
                            <option value="false" {% if scc_scan == 'false' %}selected{% endif %}>False</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="scc-port" class="form-label">
                            <i class="fas fa-usb me-2"></i>
                            Port
                        </label>
                        <input type="text" class="form-control" name="scc-port" id="scc-port" placeholder="contoh: /dev/ttyS0 atau /dev/ttyUSB0" value="{{port}}">
                    </div>
                    
                    <div class="mb-3">
                        <label for="scc-host" class="form-label">
                            <i class="fas fa-server me-2"></i>
                            Host / IP
                        </label>
                        <input type="text" class="form-control" name="scc-host" id="scc-host" placeholder="Host / IP" value="{{host}}">
                    </div>
                    
                    <div class="d-grid">
                        <button type="submit" class="btn btn-modern btn-primary">
                            <i class="fas fa-save me-2"></i>
                            Save Configuration
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- SCC ID Configuration -->
    <div class="col-lg-6 mb-4">
        <div class="modern-card">
            <div class="modern-card-header">
                <h5 class="modern-card-title">
                    <i class="fas fa-hashtag text-info me-2"></i>
                    SCC Setting ID
                </h5>
            </div>
            <div class="modern-card-body">
                <form method="POST">
                    <input type="hidden" name="scc-setting-id-form" value="scc-setting-id-form">
                    
                    {% for key, val in scc_ids.items() %}
                    <div class="mb-3">
                        <label for="scc-id-{{key}}" class="form-label">
                            <i class="fas fa-id-badge me-2"></i>
                            SCC {{key}}
                        </label>
                        <input type="number" class="form-control" name="scc-id-{{key}}" id="scc-id-{{key}}" placeholder="SCC {{key}}" value="{{val}}" min="1" max="255" required>
                    </div>
                    {% endfor %}
                    
                    <div class="d-grid">
                        <button type="submit" class="btn btn-modern btn-info">
                            <i class="fas fa-save me-2"></i>
                            Save IDs
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Cut off / Reconnect Configuration -->
    <div class="col-lg-6 mb-4">
        <div class="modern-card">
            <div class="modern-card-header">
                <h5 class="modern-card-title">
                    <i class="fas fa-plug text-warning me-2"></i>
                    Cut off / Reconnect Values
                </h5>
            </div>
            <div class="modern-card-body">
                <form method="POST">
                    <input type="hidden" name="config-relay-form" value="config-relay-form">
                    
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-primary mb-3">
                                <i class="fas fa-broadcast-tower me-2"></i>
                                BTS Configuration
                            </h6>
                            <div class="mb-3">
                                <label for="voltage_reconnect_bts" class="form-label">
                                    <i class="fas fa-arrow-up me-2"></i>
                                    BTS Reconnect (mV)
                                </label>
                                <input type="number" class="form-control" name="voltage_reconnect_bts" id="voltage_reconnect_bts" placeholder="e.g., 4800" value="{{config_relay.voltage_reconnect_bts}}" min="0" max="60000" required>
                            </div>
                            <div class="mb-3">
                                <label for="voltage_cutoff_bts" class="form-label">
                                    <i class="fas fa-arrow-down me-2"></i>
                                    BTS Cut Off (mV)
                                </label>
                                <input type="number" class="form-control" name="voltage_cutoff_bts" id="voltage_cutoff_bts" placeholder="e.g., 4700" value="{{config_relay.voltage_cutoff_bts}}" min="0" max="60000" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-success mb-3">
                                <i class="fas fa-satellite me-2"></i>
                                VSAT Configuration
                            </h6>
                            <div class="mb-3">
                                <label for="voltage_reconnect_vsat" class="form-label">
                                    <i class="fas fa-arrow-up me-2"></i>
                                    VSAT Reconnect (mV)
                                </label>
                                <input type="number" class="form-control" name="voltage_reconnect_vsat" id="voltage_reconnect_vsat" placeholder="e.g., 4700" value="{{config_relay.voltage_reconnect_vsat}}" min="0" max="60000" required>
                            </div>
                            <div class="mb-3">
                                <label for="voltage_cutoff_vsat" class="form-label">
                                    <i class="fas fa-arrow-down me-2"></i>
                                    VSAT Cut Off (mV)
                                </label>
                                <input type="number" class="form-control" name="voltage_cutoff_vsat" id="voltage_cutoff_vsat" placeholder="e.g., 4600" value="{{config_relay.voltage_cutoff_vsat}}" min="0" max="60000" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-grid">
                        <button type="submit" class="btn btn-modern btn-warning">
                            <i class="fas fa-save me-2"></i>
                            Save Relay Config
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- SCC Parameters Configuration -->
    <div class="col-lg-6">
        <div class="modern-card">
            <div class="modern-card-header">
                <h5 class="modern-card-title">
                    <i class="fas fa-battery-full text-success me-2"></i>
                    SCC Parameters
                </h5>
            </div>
            <div class="modern-card-body">
                <form method="POST">
                    <input type="hidden" name="config-scc-form" value="config-scc-form">
                    
                    <div class="row">
                        {% for key, value in config_scc.items() %}
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{key}}" class="form-label">
                                    <i class="fas fa-cog me-2"></i>
                                    {{ key.replace('_', ' ').title() }}
                                </label>
                                <input type="text" class="form-control" name="{{key}}" id="{{key}}" placeholder="{{key}}" value="{{value}}" required>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <div class="d-grid">
                        <button type="submit" class="btn btn-modern btn-success">
                            <i class="fas fa-save me-2"></i>
                            Save Parameters
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle all form submissions
    const forms = document.querySelectorAll('form');
    forms.forEach(form => {
        form.addEventListener('submit', function(e) {
            const submitButton = form.querySelector('button[type="submit"]');
            if (submitButton) {
                const originalText = submitButton.innerHTML;
                submitButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Saving...';
                submitButton.disabled = true;
                
                // Re-enable after 5 seconds as fallback
                setTimeout(() => {
                    submitButton.innerHTML = originalText;
                    submitButton.disabled = false;
                }, 5000);
            }
        });
    });
    
    // Auto-save indicator
    const inputs = document.querySelectorAll('input, select');
    inputs.forEach(input => {
        input.addEventListener('change', function() {
            this.style.borderColor = '#ffc107';
            setTimeout(() => {
                this.style.borderColor = '';
            }, 2000);
        });
    });
    
    // Form validation
    const numberInputs = document.querySelectorAll('input[type="number"]');
    numberInputs.forEach(input => {
        input.addEventListener('input', function() {
            const value = parseInt(this.value);
            const min = parseInt(this.getAttribute('min'));
            const max = parseInt(this.getAttribute('max'));
            
            if (value < min || value > max) {
                this.style.borderColor = '#dc3545';
                this.setCustomValidity('Value must be between ' + min + ' and ' + max);
            } else {
                this.style.borderColor = '#28a745';
                this.setCustomValidity('');
            }
        });
    });
    
    // Dynamic status update
    function updateConfigStatus() {
        const sccType = document.querySelector('select[name="scc-type"]').value;
        const sccSource = document.querySelector('select[name="scc-source"]').value;
        const statusElement = document.querySelector('.stats-card:last-child .status-indicator');
        
        if (sccType && sccSource) {
            statusElement.textContent = 'Configured';
            statusElement.classList.remove('inactive');
            statusElement.classList.add('active');
        } else {
            statusElement.textContent = 'Incomplete';
            statusElement.classList.remove('active');
            statusElement.classList.add('inactive');
        }
    }
    
    // Listen for changes in main configuration
    const mainConfigInputs = document.querySelectorAll('select[name="scc-type"], select[name="scc-source"]');
    mainConfigInputs.forEach(input => {
        input.addEventListener('change', updateConfigStatus);
    });
    
    // Initialize tooltips
    const tooltips = {
        'scc-type': 'Select the type of Solar Charge Controller',
        'scc-source': 'Choose the connection method for SCC communication',
        'scc-scan': 'Enable/disable automatic ID scanning',
        'scc-port': 'Specify the communication port (for serial/USB connections)',
        'scc-host': 'Enter the IP address or hostname (for TCP connections)'
    };
    
    Object.keys(tooltips).forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.setAttribute('title', tooltips[id]);
            element.setAttribute('data-bs-toggle', 'tooltip');
        }
    });
    
    // Show/hide fields based on source selection
    const sourceSelect = document.querySelector('select[name="scc-source"]');
    const portField = document.getElementById('scc-port').closest('.mb-3');
    const hostField = document.getElementById('scc-host').closest('.mb-3');
    
    function toggleFields() {
        const source = sourceSelect.value;
        if (source === 'tcp') {
            portField.style.display = 'none';
            hostField.style.display = 'block';
        } else if (source === 'serial' || source === 'usb') {
            portField.style.display = 'block';
            hostField.style.display = 'none';
        } else {
            portField.style.display = 'block';
            hostField.style.display = 'block';
        }
    }
    
    sourceSelect.addEventListener('change', toggleFields);
    toggleFields(); // Initial call
    
    // Flash messages auto-hide
    const flashMessages = document.querySelectorAll('.alert[role="alert"]');
    flashMessages.forEach(message => {
        setTimeout(() => {
            message.style.opacity = '0';
            setTimeout(() => {
                message.remove();
            }, 500);
        }, 5000);
    });
});
</script>
{% endblock %}
