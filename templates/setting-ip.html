{% extends 'modern-layout.html' %}
{% block breadcrumbs %}IP Settings{% endblock breadcrumbs %}

{% block content %}
<!-- Page Header -->
<div class="row mb-4">
    <div class="col-12">
        <div class="modern-card">
            <div class="modern-card-header">
                <h3 class="modern-card-title">
                    <i class="fas fa-network-wired text-primary me-2"></i>
                    Network IP Configuration
                </h3>
            </div>
            <div class="modern-card-body">
                <p class="text-muted mb-0">Configure IP Address. Select site or use custom IP settings.</p>
            </div>
        </div>
    </div>
</div>

<!-- Network Status Summary -->
<div class="row mb-3">
    <div class="col-12">
        <div class="modern-card">
            <div class="modern-card-header">
                <h5 class="modern-card-title">
                    <i class="fas fa-chart-line text-success me-2"></i>
                    Network Configuration Summary
                </h5>
            </div>
            <div class="modern-card-body">
                <div class="row g-4">
                    <div class="col-lg-3 col-md-6">
                        <div class="stats-card">
                            <div class="stats-card-header">
                                <h6 class="stats-card-title">Primary IP</h6>
                                <div class="stats-card-icon bg-primary">
                                    <i class="fas fa-network-wired"></i>
                                </div>
                            </div>
                            <h4 class="stats-card-value" id="primary-ip-display">{{ ip_address if ip_address else 'Not Set' }}</h4>
                            <p class="stats-card-subtitle">IP Address</p>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <div class="stats-card">
                            <div class="stats-card-header">
                                <h6 class="stats-card-title">Subnet Mask</h6>
                                <div class="stats-card-icon bg-info">
                                    <i class="fas fa-network-wired"></i>
                                </div>
                            </div>
                            <h4 class="stats-card-value" id="subnet-mask-display">{{ subnet_mask if subnet_mask else 'Not Set' }}</h4>
                            <p class="stats-card-subtitle">Subnet Mask</p>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <div class="stats-card">
                            <div class="stats-card-header">
                                <h6 class="stats-card-title">Gateway</h6>
                                <div class="stats-card-icon bg-warning">
                                    <i class="fas fa-route"></i>
                                </div>
                            </div>
                            <h4 class="stats-card-value" id="gateway-display">{{ gateway if gateway else 'Not Set' }}</h4>
                            <p class="stats-card-subtitle">Default Route</p>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <div class="stats-card">
                            <div class="stats-card-header">
                                <h6 class="stats-card-title">Status</h6>
                                <div class="stats-card-icon bg-success">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                            </div>
                            <h4 class="stats-card-value">
                                <span class="status-indicator {% if ip_address_primary %}active{% else %}inactive{% endif %}" id="network-status">
                                    {% if ip_address_primary %}Configured{% else %}Pending{% endif %}
                                </span>
                            </h4>
                            <p class="stats-card-subtitle">Network Config</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- IP Configuration Cards -->
<div class="row">
    <!-- Primary IP Configuration -->
    <div class="col-lg-12 mb-4">
        <div class="modern-card">
            <div class="modern-card-header">
                <h5 class="modern-card-title">
                    <i class="fas fa-wifi text-primary me-2"></i>
                    IP Address 
                </h5>
            </div>
            <div class="modern-card-body">
                <!-- Site Selection -->
                <div class="mb-4">
                    <label for="select_ip" class="form-label">
                        <i class="fas fa-map-marker-alt me-2"></i>
                        Select Site
                    </label>
                    <div class="input-group">
                        <select class="form-control" name="select_ip" id="select_ip">
                            <option value="" disabled selected>Choose Site Location</option>
                        </select>
                        <button class="btn btn-modern btn-primary" type="button" id="find-btn">
                            <i class="fas fa-search me-2"></i>
                            Find
                        </button>
                    </div>
                </div>
                
                <!-- Primary IP Form -->
                <form method="POST" id="primary-form">
                    <input type="hidden" id="site" name="site">
                    <input type="hidden" id="type-ip-address" name="type-ip-address" value="ip-address">

                    <div class="mb-3">
                        <label for="ip-address" class="form-label">
                            <i class="fas fa-globe me-2"></i>
                            IP Address
                        </label>
                        <input type="text" class="form-control" name="ip-address" id="ip-address" placeholder="192.168.1.100" value="{{ip_address}}">
                    </div>
                    
                    <div class="mb-3">
                        <label for="net-mask" class="form-label">
                            <i class="fas fa-mask me-2"></i>
                            Net Mask
                        </label>
                        <input type="text" class="form-control" name="net-mask" id="net-mask" placeholder="/29" value="{{subnet_mask}}">
                    </div>
                    
                    <div class="mb-3">
                        <label for="gateway" class="form-label">
                            <i class="fas fa-route me-2"></i>
                            Gateway
                        </label>
                        <input type="text" class="form-control" name="gateway" id="gateway" placeholder="192.168.1.1" value="{{gateway}}">
                    </div>
                    
                    <div class="d-grid">
                        <button type="submit" class="btn btn-modern btn-primary" id="primary-submit">
                            <i class="fas fa-save me-2"></i>
                            Save IP Address
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Read data site
    const result_data = JSON.parse('{{ data_ip | tojson | safe }}');
    
    // Populate site dropdown
    result_data.forEach(el => {
        const selectIp = document.getElementById('select_ip');
        const option = document.createElement('option');
        option.value = el.ip;
        option.text = el.site;
        selectIp.appendChild(option);
    });

    // Find IP functionality
    document.getElementById('find-btn').addEventListener('click', function() {
        const selectIp = document.getElementById('select_ip');
        const selectedIp = selectIp.options[selectIp.selectedIndex].value;
        
        if (!selectedIp) {
            showAlert('Please select a site first', 'warning');
            return;
        }

        const result = result_data.find(el => el.ip === selectedIp);
        if (result) {
            // Update primary IP fields
            document.getElementById('ip-address').value = result.ip;
            document.getElementById('net-mask').value = result.subnet_mask;
            document.getElementById('gateway').value = result.gateway;
            document.getElementById('site').value = result.site;
            
            // Update summary display
            updateSummaryDisplay();
            
            // Handle custom IP configuration
            if (result.site === 'IP CUSTOM') {
                // Remove readonly attributes for custom configuration
                document.getElementById('ip-address').removeAttribute('readonly');
                document.getElementById('net-mask').removeAttribute('readonly');
                document.getElementById('gateway').removeAttribute('readonly');
                document.getElementById('site').value = '{{ site_name|upper }}';
                
                // Show custom configuration alert
                showAlert('Custom IP mode enabled. You can now edit the IP configuration.', 'info');
            } else {
                // Re-add readonly attributes for preset configurations
                document.getElementById('ip-address').setAttribute('readonly', 'readonly');
                document.getElementById('net-mask').setAttribute('readonly', 'readonly');
                document.getElementById('gateway').setAttribute('readonly', 'readonly');
            }
            
            // Visual feedback
            const button = document.getElementById('find-btn');
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-check me-2"></i>Found';
            button.classList.add('btn-success');
            
            setTimeout(() => {
                button.innerHTML = originalText;
                button.classList.remove('btn-success');
            }, 2000);
        }
    });

    // Form submission handlers
    const primaryForm = document.getElementById('primary-form');

    if (primaryForm) {
        primaryForm.addEventListener('submit', function(e) {
            handleFormSubmit(e, 'primary-submit', 'Save IP Address');
        });
    }

    // IP validation
    const ipInputs = document.querySelectorAll('input[name*="ip-address"], input[name="gateway"]');
    ipInputs.forEach(input => {
        input.addEventListener('input', function() {
            validateIPAddress(this);
        });
    });

    // Net mask validation
    const netMaskInputs = document.querySelectorAll('input[name="net-mask"]');
    netMaskInputs.forEach(input => {
        input.addEventListener('input', function() {
            validateNetMask(this);
        });
    });

    // Real-time summary updates
    const allInputs = document.querySelectorAll('input[type="text"]');
    allInputs.forEach(input => {
        input.addEventListener('input', function() {
            updateSummaryDisplay();
        });
    });

    // Functions
    function handleFormSubmit(event, buttonId, originalText) {
        const button = document.getElementById(buttonId);
        button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Saving...';
        button.disabled = true;
        
        // Re-enable after 5 seconds as fallback
        setTimeout(() => {
            button.innerHTML = `<i class="fas fa-save me-2"></i>${originalText}`;
            button.disabled = false;
        }, 5000);
    }

    function validateIPAddress(input) {
        const ipPattern = /^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/;
        const value = input.value.trim();
        
        if (value === '') {
            input.classList.remove('is-valid', 'is-invalid');
            return;
        }
        
        if (ipPattern.test(value)) {
            input.classList.remove('is-invalid');
            input.classList.add('is-valid');
        } else {
            input.classList.remove('is-valid');
            input.classList.add('is-invalid');
        }
    }

    function validateNetMask(input) {
        const value = input.value.trim();
        
        if (value === '') {
            input.classList.remove('is-valid', 'is-invalid');
            return;
        }
        
        // Check if it's CIDR notation (1-32) or dotted decimal
        const cidrPattern = /^([1-9]|[1-2][0-9]|3[0-2])$/;
        const dottedPattern = /^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/;
        
        if (cidrPattern.test(value) || dottedPattern.test(value)) {
            input.classList.remove('is-invalid');
            input.classList.add('is-valid');
        } else {
            input.classList.remove('is-valid');
            input.classList.add('is-invalid');
        }
    }

    function updateSummaryDisplay() {
        const primaryIp = document.getElementById('ip-address').value;
        const subnetMask = document.getElementById('subnet-mask').value;
        const gateway = document.getElementById('gateway').value;
        
        // Update summary cards (if they exist)
        const primaryIpDisplay = document.getElementById('primary-ip-display');
        const subnetMaskDisplay = document.getElementById('subnet-mask-display');
        const gatewayDisplay = document.getElementById('gateway-display');
        const networkStatus = document.getElementById('network-status');
        
        if (primaryIpDisplay) {
            primaryIpDisplay.textContent = primaryIp || 'Not Set';
        }

        if (subnetMaskDisplay) {
            subnetMaskDisplay.textContent = subnetMask || 'Not Set';
        }
        
        if (gatewayDisplay) {
            gatewayDisplay.textContent = gateway || 'Not Set';
        }
        
        // Update status
        if (networkStatus) {
            if (primaryIp) {
                networkStatus.textContent = 'Configured';
                networkStatus.classList.remove('inactive');
                networkStatus.classList.add('active');
            } else {
                networkStatus.textContent = 'Pending';
                networkStatus.classList.remove('active');
                networkStatus.classList.add('inactive');
            }
        }
    }

    function showAlert(message, type) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.innerHTML = `
            <i class="fas fa-info-circle me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        // Insert at the top of the page
        const firstCard = document.querySelector('.modern-card');
        firstCard.parentNode.insertBefore(alertDiv, firstCard);
        
        // Auto-hide after 3 seconds
        setTimeout(() => {
            alertDiv.remove();
        }, 3000);
    }

    // Initialize tooltips
    const tooltips = {
        'select_ip': 'Select a predefined site configuration or choose custom for manual setup',
        'ip-address': 'IP address for the main network interface',
        'net-mask': 'Network mask in CIDR notation (e.g., 24) or dotted decimal (e.g., 255.255.255.0)',
        'gateway': 'Default gateway IP address for routing network traffic'
    };

    Object.keys(tooltips).forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.setAttribute('title', tooltips[id]);
            element.setAttribute('data-bs-toggle', 'tooltip');
        }
    });

    // Initialize summary display
    updateSummaryDisplay();
});
</script>
{% endblock %}
